<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ConstructBid ‚Äî Bid Tracker & Proposal Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #242424;
    --border: #2e2e2e;
    --accent: #f5a623;
    --accent2: #e8391d;
    --green: #2ecc71;
    --blue: #3b82f6;
    --text: #f0ede8;
    --muted: #888;
    --danger: #e8391d;
    --estimating: #3b82f6;
    --pending: #f5a623;
    --won: #2ecc71;
    --lost: #e8391d;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* SIDEBAR */
  .layout { display: flex; min-height: 100vh; }

  .sidebar {
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }

  .logo {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    color: var(--accent);
    line-height: 1;
  }

  .logo-sub {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 3px;
  }

  .nav { padding: 16px 0; flex: 1; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.15s;
    border-left: 3px solid transparent;
    letter-spacing: 0.3px;
  }

  .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(245,166,35,0.06); }

  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--muted);
  }

  .team-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }

  .avatar {
    width: 26px; height: 26px;
    border-radius: 50%;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* MAIN */
  .main {
    margin-left: 220px;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 32px;
    height: 60px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .page-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: var(--text);
  }

  .topbar-actions { display: flex; gap: 10px; align-items: center; }

  .btn {
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }
  .btn-primary:hover { background: #f0b84a; }

  .btn-ghost {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { color: var(--text); border-color: #444; }

  .btn-danger {
    background: var(--danger);
    color: #fff;
  }

  .btn-sm { padding: 5px 10px; font-size: 12px; }

  /* ROADMAP PAGE */
  #page-roadmap { flex-direction: column; }
  #page-roadmap.active { display: flex; }
  #roadmap-toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 28px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    flex-wrap: wrap;
    position: sticky;
    top: 60px;
    z-index: 40;
  }
  #roadmap-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }
  /* Kanban horizontal scroll wrapper */
  .roadmap-phase-cols {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 12px;
    align-items: flex-start;
  }
  .roadmap-phase-cols::-webkit-scrollbar { height: 5px; }
  .roadmap-phase-cols::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  /* List view table wrapper */
  #list-view-root {
    padding: 20px 28px 48px;
  }
  .list-stats-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: stretch;
  }
  .list-stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    min-width: 110px;
    flex-shrink: 0;
  }
  .list-stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .list-stat-value { font-size: 20px; font-weight: 800; line-height: 1; }
  .list-table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    overflow-x: auto;
  }
  .list-table-wrap table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 800px; }
  .list-table-wrap thead tr { background: var(--surface2); border-bottom: 2px solid var(--border); }
  .list-table-wrap th { padding: 10px 13px; text-align: left; color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; white-space: nowrap; }
  .list-table-wrap td { padding: 10px 13px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
  .list-table-wrap tr:hover td { background: rgba(255,255,255,0.025); }

  /* CONTENT */
  .content { padding: 28px 32px; }

  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .stat-card.est::before { background: var(--estimating); }
  .stat-card.pend::before { background: var(--pending); }
  .stat-card.won::before { background: var(--won); }
  .stat-card.lost::before { background: var(--lost); }

  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; }
  .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--text); margin-top: 6px; line-height: 1; }
  .stat-sub { font-size: 12px; color: var(--muted); margin-top: 4px; font-family: 'DM Mono', monospace; }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 14px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    width: 240px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  .filter-btn {
    padding: 7px 14px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }

  .filter-btn:hover { color: var(--text); }
  .filter-btn.active { color: var(--text); }
  .filter-btn.f-all.active { border-color: var(--text); color: var(--text); }
  .filter-btn.f-estimating.active { border-color: var(--estimating); color: var(--estimating); background: rgba(59,130,246,0.08); }
  .filter-btn.f-pending.active { border-color: var(--pending); color: var(--pending); background: rgba(245,166,35,0.08); }
  .filter-btn.f-won.active { border-color: var(--won); color: var(--won); background: rgba(46,204,113,0.08); }
  .filter-btn.f-lost.active { border-color: var(--lost); color: var(--lost); background: rgba(232,57,29,0.08); }

  /* TABLE */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  table { width: 100%; border-collapse: collapse; }

  thead tr {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }

  th {
    padding: 10px 14px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    text-align: left;
    font-weight: 500;
    white-space: nowrap;
  }

  td {
    padding: 12px 14px;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  tr:last-child td { border-bottom: none; }

  tr:hover td { background: rgba(255,255,255,0.02); }

  .project-name { font-weight: 500; color: var(--text); }
  .project-id { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 2px; }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .status-badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; }

  .badge-estimating { color: var(--estimating); background: rgba(59,130,246,0.12); }
  .badge-pending { color: var(--pending); background: rgba(245,166,35,0.12); }
  .badge-won { color: var(--won); background: rgba(46,204,113,0.12); }
  .badge-lost { color: var(--lost); background: rgba(232,57,29,0.12); }

  /* INLINE STATUS DROPDOWN */
  .status-dropdown-wrap {
    position: relative;
    display: inline-block;
  }

  .status-select {
    appearance: none;
    -webkit-appearance: none;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 4px 26px 4px 20px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-family: 'DM Sans', sans-serif;
    background-image: none;
    transition: opacity 0.15s, box-shadow 0.15s;
  }

  .status-select:hover { opacity: 0.85; box-shadow: 0 0 0 2px currentColor; }

  .status-select.sel-estimating { color: var(--estimating); background: rgba(59,130,246,0.15); }
  .status-select.sel-pending    { color: var(--pending);    background: rgba(245,166,35,0.15); }
  .status-select.sel-won        { color: var(--won);        background: rgba(46,204,113,0.15); }
  .status-select.sel-lost       { color: var(--lost);       background: rgba(232,57,29,0.15); }

  .status-select option { background: #1e1e1e; color: #f0f0f0; font-weight: 600; }

  .status-chevron {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 8px;
    pointer-events: none;
    opacity: 0.6;
  }

  .status-dot {
    position: absolute;
    left: 9px;
    top: 50%;
    transform: translateY(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    pointer-events: none;
    background: currentColor;
  }

  .status-dropdown-wrap .sel-estimating ~ .status-dot { color: var(--estimating); }
  .status-dropdown-wrap .sel-pending    ~ .status-dot { color: var(--pending); }
  .status-dropdown-wrap .sel-won        ~ .status-dot { color: var(--won); }
  .status-dropdown-wrap .sel-lost       ~ .status-dot { color: var(--lost); }

  .value-cell { font-family: 'DM Mono', monospace; font-size: 13px; }
  .contact-cell { font-size: 13px; }
  .company-cell { font-size: 12px; color: var(--muted); }
  .date-cell { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; }

  .row-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.15s; }
  tr:hover .row-actions { opacity: 1; }

  .action-btn {
    width: 28px; height: 28px;
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 13px;
    background: var(--surface2);
    border: 1px solid var(--border);
    transition: all 0.15s;
  }

  .action-btn:hover { border-color: var(--accent); color: var(--accent); }
  .action-btn.del:hover { border-color: var(--danger); color: var(--danger); }

  /* FILES */
  .file-count {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--muted);
  }

  .file-count.has-files { color: var(--blue); }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.15s;
  }

  .modal-overlay.open { display: flex; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 600px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.2s;
  }

  .modal-lg { width: 760px; }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 1.5px;
    color: var(--accent);
  }

  .modal-close {
    width: 30px; height: 30px;
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--muted);
    font-size: 18px;
    background: none;
    border: none;
    transition: all 0.15s;
  }

  .modal-close:hover { color: var(--text); background: var(--surface2); }

  .modal-body { padding: 24px; }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  /* FORM */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-full { grid-column: 1 / -1; }

  .form-group { display: flex; flex-direction: column; gap: 6px; }

  .form-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    font-weight: 500;
  }

  .form-input, .form-select, .form-textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-select { cursor: pointer; }
  .form-textarea { resize: vertical; min-height: 80px; }

  /* CONTACTS PAGE ‚Äî two-panel layout */
  .contacts-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: calc(100vh - 60px);
    overflow: hidden;
  }

  /* LEFT PANEL ‚Äî company list */
  .company-list-panel {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .company-list-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
  }

  .company-search {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  .company-search:focus { border-color: var(--accent); }
  .company-search::placeholder { color: var(--muted); }

  .company-list { overflow-y: auto; flex: 1; }

  .company-item {
    padding: 14px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .company-item:hover { background: rgba(255,255,255,0.03); }
  .company-item.active { background: rgba(245,166,35,0.07); border-left: 3px solid var(--accent); }
  .company-item.active .company-item-name { color: var(--accent); }

  .company-item-logo {
    width: 36px; height: 36px;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    font-weight: 800;
    flex-shrink: 0;
    letter-spacing: -0.5px;
  }

  .company-item-info { flex: 1; min-width: 0; }
  .company-item-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .company-item-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* RIGHT PANEL ‚Äî company detail */
  .company-detail-panel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .company-detail-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
    color: var(--muted);
  }

  .company-detail-content {
    display: grid;
    grid-template-columns: 300px 1fr;
    height: 100%;
    overflow: hidden;
  }

  /* Company info left */
  .company-info-col {
    padding: 28px 24px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
  }

  .company-logo-large {
    width: 56px; height: 56px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 16px;
    letter-spacing: -1px;
  }

  .company-detail-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 1px;
    color: var(--text);
    line-height: 1.1;
    margin-bottom: 4px;
  }

  .company-info-row {
    display: flex;
    gap: 8px;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 8px;
    align-items: flex-start;
  }

  .company-info-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-top: 20px;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .company-bids-list { display: flex; flex-direction: column; gap: 6px; }

  .company-bid-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 7px 10px;
    font-size: 12px;
    cursor: pointer;
    transition: border-color 0.12s;
  }
  .company-bid-pill:hover { border-color: #444; }

  /* Contacts right col */
  .contacts-col {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .contacts-col-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .contacts-col-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 15px;
    letter-spacing: 1.5px;
    color: var(--muted);
  }

  .contacts-person-list {
    overflow-y: auto;
    flex: 1;
  }

  .contact-person-row {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
  }

  .contact-person-row:hover { background: rgba(255,255,255,0.02); }
  .contact-person-row:hover .person-actions { opacity: 1; }

  .person-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .person-info { flex: 1; min-width: 0; }
  .person-name { font-size: 13px; font-weight: 600; }
  .person-role {
    font-size: 11px;
    color: var(--muted);
    margin-top: 1px;
  }

  .person-contact-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
    font-size: 12px;
    color: var(--muted);
    text-align: right;
    min-width: 200px;
  }

  .person-contact-info a { color: var(--blue); text-decoration: none; }
  .person-contact-info a:hover { text-decoration: underline; }

  .person-actions {
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  /* PROPOSAL BUILDER */
  .proposal-builder { display: grid; grid-template-columns: 1fr 1fr; gap: 0; height: calc(100vh - 120px); }

  .proposal-form {
    padding: 24px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
  }

  .proposal-preview {
    padding: 32px;
    overflow-y: auto;
    background: #fff;
    color: #1a1a1a;
  }

  .preview-doc {
    max-width: 600px;
    margin: 0 auto;
    font-family: 'DM Sans', sans-serif;
  }

  .preview-header {
    border-bottom: 3px solid #f5a623;
    padding-bottom: 20px;
    margin-bottom: 24px;
  }

  .preview-company-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 2px;
    color: #0f0f0f;
  }

  .preview-doc-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: #f5a623;
    margin-top: 8px;
  }

  .preview-section { margin-bottom: 20px; }
  .preview-section-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #999;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .preview-value { font-size: 14px; color: #1a1a1a; line-height: 1.6; }

  .preview-line-items table { width: 100%; border-collapse: collapse; }
  .preview-line-items th {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #999;
    padding: 8px 10px;
    background: #f5f5f5;
    text-align: left;
  }
  .preview-line-items td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 13px;
    color: #1a1a1a;
  }
  .preview-total {
    text-align: right;
    font-size: 18px;
    font-weight: 700;
    color: #0f0f0f;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 2px solid #0f0f0f;
  }

  .preview-footer {
    margin-top: 32px;
    padding-top: 16px;
    border-top: 1px solid #ddd;
    font-size: 11px;
    color: #999;
  }

  /* SECTION HEADER */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    color: var(--muted);
  }

  /* LINE ITEMS */
  .line-items { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }

  .line-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 8px;
    align-items: center;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 10px;
  }

  .line-item-desc { font-size: 13px; color: var(--text); }
  .line-item-qty { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; width: 50px; text-align: center; }
  .line-item-price { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--accent); width: 80px; text-align: right; }
  .line-item-del { cursor: pointer; color: var(--muted); font-size: 14px; transition: color 0.15s; }
  .line-item-del:hover { color: var(--danger); }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--green);
    border-radius: 6px;
    padding: 14px 20px;
    font-size: 13px;
    z-index: 9999;
    display: none;
    animation: slideUp 0.2s;
    max-width: 320px;
  }

  .toast.show { display: block; }

  /* HIDDEN PAGES */
  .page { display: none; }
  .page.active { display: block; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; margin-bottom: 16px; }

  /* PROPOSAL TABS */
  .proposal-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
    gap: 0;
  }

  .proposal-tab {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    margin-bottom: -1px;
  }

  .proposal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .proposal-tab:hover { color: var(--text); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #444; }

  /* Files Drop Zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 6px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--muted);
    font-size: 13px;
  }

  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(245,166,35,0.04);
    color: var(--accent);
  }

  .file-list { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }

  .file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 12px;
  }

  .file-item-name { display: flex; align-items: center; gap: 8px; }
  .file-remove { cursor: pointer; color: var(--muted); transition: color 0.15s; }
  .file-remove:hover { color: var(--danger); }

  .won-label { color: var(--won) !important; }
  .lost-label { color: var(--lost) !important; }

  /* BID CONTACT PREVIEW CARD */
  #bid-contact-preview { animation: slideUp 0.15s; }

  /* PROPOSAL CATEGORY BLOCKS */
  .p-category {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .p-category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: rgba(255,255,255,0.03);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
  }

  .p-category-header:hover { background: rgba(255,255,255,0.05); }

  .p-category-chevron {
    font-size: 10px;
    color: var(--muted);
    transition: transform 0.15s;
    flex-shrink: 0;
  }

  .p-category.collapsed .p-category-chevron { transform: rotate(-90deg); }
  .p-category.collapsed .p-category-body { display: none; }

  .p-category-name-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 13px;
    font-weight: 600;
    outline: none;
    min-width: 0;
    font-family: 'DM Sans', sans-serif;
  }

  .p-category-name-input::placeholder { color: var(--muted); font-weight: 400; }

  .p-category-total {
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--accent);
    flex-shrink: 0;
  }

  .p-category-body { padding: 12px; }

  .p-category-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }

  .p-cat-line-items { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }

  .p-cat-line-item {
    display: grid;
    grid-template-columns: 1fr 52px 80px 24px;
    gap: 6px;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 8px;
  }

  .p-cat-li-del { cursor: pointer; color: var(--muted); font-size: 13px; text-align: center; transition: color 0.15s; }
  .p-cat-li-del:hover { color: var(--danger); }

  /* ASSIGNED TEAM AVATARS IN ROW */
  .row-team { display: flex; align-items: center; gap: 0; position: relative; }

  .row-avatar {
    width: 26px; height: 26px;
    border-radius: 50%;
    font-size: 10px;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid var(--surface);
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s;
    position: relative;
    margin-left: -6px;
    flex-shrink: 0;
  }

  .row-avatar:first-child { margin-left: 0; }
  .row-avatar:hover { transform: translateY(-2px) scale(1.12); z-index: 10; border-color: var(--accent); }

  .row-avatar-add {
    width: 26px; height: 26px;
    border-radius: 50%;
    border: 2px dashed var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    margin-left: -6px;
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .row-avatar-add:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.1); }

  /* ASSIGN POPUP */
  .assign-popup {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    z-index: 5000;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: none;
    animation: slideUp 0.15s;
  }

  .assign-popup.open { display: block; }

  .assign-popup-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    margin-bottom: 10px;
    font-weight: 500;
  }

  .assign-member {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 8px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.12s;
  }

  .assign-member:hover { background: var(--surface2); }

  .assign-member-avatar {
    width: 30px; height: 30px;
    border-radius: 50%;
    font-size: 11px;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .assign-member-name { font-size: 13px; flex: 1; }

  .assign-member-check {
    width: 16px; height: 16px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 9px;
    transition: all 0.12s;
  }

  .assign-member-check.checked {
    background: var(--accent);
    border-color: var(--accent);
    color: #000;
  }

  /* ASSIGN FIELD IN MODAL */
  .assign-members-grid {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 4px;
  }

  .assign-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.15s;
    background: var(--surface2);
  }

  .assign-toggle:hover { border-color: #555; color: var(--text); }

  .assign-toggle.selected {
    color: #000;
    border-color: transparent;
  }

  .assign-toggle-avatar {
    width: 22px; height: 22px;
    border-radius: 50%;
    font-size: 9px;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
  }
</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-text">ConstructBid</div>
      <div class="logo-sub">Bid Tracker Pro</div>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">üìä</span> Dashboard
      </div>
      <div class="nav-item" onclick="showPage('bids')">
        <span class="nav-icon">üìã</span> All Bids
      </div>
      <div class="nav-item" onclick="showPage('contacts')">
        <span class="nav-icon">üë•</span> Contacts
      </div>
      <div class="nav-item" onclick="showPage('analytics')">
        <span class="nav-icon">üìà</span> Analytics
      </div>
      <div class="nav-item" onclick="showPage('roadmap')">
        <span class="nav-icon">üó∫Ô∏è</span> Project Roadmap
      </div>
      <div class="nav-item" onclick="openMyCompanyModal()">
        <span class="nav-icon">üèóÔ∏è</span> My Company
      </div>
    </nav>
    <div class="sidebar-footer">
      <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Team</div>
      <div class="team-badge">
        <div class="avatar" style="background:#3b82f620;color:#3b82f6">JD</div>
        <div class="avatar" style="background:#f5a62320;color:#f5a623;margin-left:-8px;">MK</div>
        <div class="avatar" style="background:#2ecc7120;color:#2ecc71;margin-left:-8px;">SR</div>
        <span style="font-size:11px;color:var(--muted);margin-left:4px;">3 members</span>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- DASHBOARD PAGE -->
    <div id="page-dashboard" class="page active">
      <div class="topbar">
        <div class="page-title">Dashboard</div>
        <div class="topbar-actions">
          <button class="btn btn-primary" onclick="openNewBidModal()">+ New Bid</button>
        </div>
      </div>
      <div class="content">
        <div class="stats-row" id="stats-row"></div>
        <div class="section-header">
          <div class="section-label">Estimating Bids</div>
          <button class="btn btn-ghost btn-sm" onclick="showPage('bids')">View All ‚Üí</button>
        </div>
        <div class="table-wrap" id="dashboard-table"></div>
      </div>
    </div>

    <!-- BIDS PAGE -->
    <div id="page-bids" class="page">
      <div class="topbar">
        <div class="page-title">All Bids</div>
        <div class="topbar-actions">
          <button class="btn btn-primary" onclick="openNewBidModal()">+ New Bid</button>
        </div>
      </div>
      <div class="content">
        <div class="filter-bar">
          <input type="text" class="search-input" id="search-input" placeholder="üîç  Search projects, contacts..." oninput="renderBidsTable()">
          <button class="filter-btn f-all active" onclick="setFilter('all')">All</button>
          <button class="filter-btn f-estimating" onclick="setFilter('estimating')">Estimating</button>
          <button class="filter-btn f-pending" onclick="setFilter('pending')">Pending Approval</button>
          <button class="filter-btn f-won" onclick="setFilter('won')">Won</button>
          <button class="filter-btn f-lost" onclick="setFilter('lost')">Lost</button>
        </div>
        <div class="table-wrap" id="bids-table"></div>
      </div>
    </div>

    <!-- CONTACTS PAGE -->
    <div id="page-contacts" class="page">
      <div class="topbar">
        <div class="page-title">Contacts</div>
        <div class="topbar-actions">
          <button class="btn btn-ghost" onclick="openAddCompanyModal()">+ Add Company</button>
          <button class="btn btn-primary" id="add-contact-btn" onclick="openAddPersonModal()" style="display:none;">+ Add Contact</button>
        </div>
      </div>
      <div class="contacts-layout">
        <!-- LEFT: Company list -->
        <div class="company-list-panel">
          <div class="company-list-header">
            <input type="text" class="company-search" placeholder="üîç  Search companies..." oninput="filterCompanies(this.value)">
          </div>
          <div class="company-list" id="company-list"></div>
        </div>
        <!-- RIGHT: Detail panel -->
        <div class="company-detail-panel" id="company-detail-panel">
          <div class="company-detail-empty">
            <div style="font-size:48px;">üè¢</div>
            <div style="font-size:14px;">Select a company to view details</div>
            <button class="btn btn-ghost btn-sm" onclick="openAddCompanyModal()">+ Add your first company</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT ROADMAP PAGE -->
    <div id="page-roadmap" class="page">
      <!-- Fixed topbar: just title + new card -->
      <div class="topbar">
        <div class="page-title">Project Roadmap</div>
        <div class="topbar-actions">
          <button class="btn btn-primary" onclick="openNewRoadmapCard()">+ New Card</button>
        </div>
      </div>

      <!-- Dedicated toolbar below topbar -->
      <div id="roadmap-toolbar" style="display:flex;align-items:center;gap:10px;padding:10px 28px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;position:sticky;top:60px;z-index:40;">
        <!-- Project selector -->
        <select id="roadmap-project-select" class="form-select" style="font-size:12px;padding:5px 10px;min-width:220px;" onchange="onRoadmapProjectChange()">
          <option value="ogesco">Ogesco ‚Äì De la Montagne</option>
          <option value="project2">Project 2 (Demo)</option>
        </select>

        <div style="width:1px;height:24px;background:var(--border);margin:0 2px;"></div>

        <!-- View switcher pills -->
        <div style="display:flex;background:var(--surface2);border:1px solid var(--border);border-radius:6px;overflow:hidden;">
          <button id="view-btn-kanban" onclick="setRoadmapView('kanban')"
            style="padding:5px 14px;border:none;border-right:1px solid var(--border);background:var(--accent);color:#000;cursor:pointer;font-size:12px;font-weight:700;letter-spacing:0.3px;transition:all 0.15s;white-space:nowrap;">
            ‚äû Board
          </button>
          <button id="view-btn-list" onclick="setRoadmapView('list')"
            style="padding:5px 14px;border:none;border-right:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:12px;font-weight:600;letter-spacing:0.3px;transition:all 0.15s;white-space:nowrap;">
            ‚ò∞ List
          </button>
          <button id="view-btn-calendar" onclick="setRoadmapView('calendar')"
            style="padding:5px 14px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:12px;font-weight:600;letter-spacing:0.3px;transition:all 0.15s;white-space:nowrap;">
            üìÖ Calendar
          </button>
        </div>

        <!-- Category filter (list + calendar only) -->
        <select id="roadmap-col-filter" class="form-select" style="font-size:12px;padding:5px 10px;min-width:160px;display:none;" onchange="renderRoadmap()">
          <option value="all">All Categories</option>
        </select>

        <!-- Spacer -->
        <div style="flex:1;"></div>

        <!-- Print PDF (list only) -->
        <button id="roadmap-print-btn" onclick="printRoadmapList()" class="btn btn-ghost btn-sm" style="display:none;font-size:12px;">
          üñ® Print PDF
        </button>
      </div>

      <div id="roadmap-content" style="padding:0;"></div>
    </div>

    <!-- ANALYTICS PAGE -->
    <div id="page-analytics" class="page">
      <div class="topbar">
        <div class="page-title">Analytics</div>
      </div>
      <div id="analytics-content" style="padding:0 4px;"></div>
    </div>

  </main>
</div>

<!-- ADD/EDIT BID MODAL -->
<div class="modal-overlay" id="bid-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="bid-modal-title">New Bid</div>
      <button class="modal-close" onclick="closeBidModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full">
          <label class="form-label">Project Name *</label>
          <input type="text" class="form-input" id="bid-name" placeholder="e.g. 26C-0313 Shake Shack Macleod Trail">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="bid-status">
            <option value="estimating">Estimating</option>
            <option value="pending">Pending Approval</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Bid Value ($)</label>
          <input type="number" class="form-input" id="bid-value" placeholder="0">
        </div>

        <!-- COMPANY DROPDOWN -->
        <div class="form-group form-full">
          <label class="form-label">Company</label>
          <select class="form-select" id="bid-company-select" onchange="onBidCompanyChange()">
            <option value="">‚Äî Select a company ‚Äî</option>
          </select>
        </div>

        <!-- CONTACT DROPDOWN (filtered by company) -->
        <div class="form-group form-full" id="bid-contact-group">
          <label class="form-label">Contact Person</label>
          <select class="form-select" id="bid-contact-select" onchange="onBidContactChange()">
            <option value="">‚Äî Select a contact ‚Äî</option>
          </select>
        </div>

        <!-- CONTACT INFO PREVIEW CARD -->
        <div class="form-full" id="bid-contact-preview" style="display:none;">
          <div style="background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:6px;padding:12px 14px;display:flex;align-items:center;gap:14px;">
            <div id="bid-contact-avatar" style="width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;"></div>
            <div style="flex:1;min-width:0;">
              <div id="bid-contact-name-display" style="font-size:13px;font-weight:600;"></div>
              <div id="bid-contact-role-display" style="font-size:11px;color:var(--muted);margin-top:1px;"></div>
              <div style="margin-top:5px;display:flex;gap:16px;flex-wrap:wrap;">
                <span id="bid-contact-email-display" style="font-size:12px;color:var(--blue);"></span>
                <span id="bid-contact-phone-display" style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- hidden fields to store actual values for saving -->
        <input type="hidden" id="bid-contact">
        <input type="hidden" id="bid-company">
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-input" id="bid-due">
        </div>
        <div class="form-group">
          <label class="form-label">Est. Construction Date</label>
          <input type="date" class="form-input" id="bid-construction">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Assigned Team Members</label>
          <div class="assign-members-grid" id="modal-assign-grid"></div>
        </div>
        <div class="form-group form-full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="bid-notes" placeholder="Any relevant notes..."></textarea>
        </div>
        <div class="form-group form-full">
          <label class="form-label">Attachments</label>
          <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFiles(event)">
            üìé Click to attach files or drag & drop
          </div>
          <input type="file" id="file-input" multiple style="display:none" onchange="addFiles(this.files)">
          <div class="file-list" id="file-list"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeBidModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveBid()">Save Bid</button>
    </div>
  </div>
</div>

<!-- ADD COMPANY MODAL -->
<div class="modal-overlay" id="add-company-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="company-modal-title">Add Company</div>
      <button class="modal-close" onclick="closeAddCompanyModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-input" id="co-name" placeholder="e.g. BUILD IT Calgary">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="co-email" placeholder="info@company.com">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="co-phone" placeholder="+1 403 000 0000">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Address</label>
          <input type="text" class="form-input" id="co-address" placeholder="Street, City, Province, Postal Code">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="co-notes" placeholder="Any notes about this company..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddCompanyModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCompany()">Save Company</button>
    </div>
  </div>
</div>

<!-- ADD PERSON MODAL -->
<div class="modal-overlay" id="add-person-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="person-modal-title">Add Contact</div>
      <button class="modal-close" onclick="closeAddPersonModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">First Name *</label>
          <input type="text" class="form-input" id="p-first" placeholder="First name">
        </div>
        <div class="form-group">
          <label class="form-label">Last Name</label>
          <input type="text" class="form-input" id="p-last" placeholder="Last name">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Role / Title</label>
          <select class="form-select" id="p-role">
            <option value="Other">Other</option>
            <option value="Project Manager">Project Manager</option>
            <option value="Superintendent">Superintendent</option>
            <option value="Foreman">Foreman</option>
            <option value="Site Assistant">Site Assistant</option>
            <option value="Estimator">Estimator</option>
            <option value="Owner">Owner</option>
            <option value="Engineer">Engineer</option>
            <option value="Architect">Architect</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="p-email" placeholder="email@company.com">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="p-phone" placeholder="+1 403 000 0000">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="p-notes" placeholder="Any notes..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddPersonModal()">Cancel</button>
      <button class="btn btn-primary" onclick="savePerson()">Save Contact</button>
    </div>
  </div>
</div>

<!-- VIEW BID MODAL -->
<div class="modal-overlay" id="view-modal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="view-modal-title">Bid Details</div>
      <button class="modal-close" onclick="document.getElementById('view-modal').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body" id="view-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('view-modal').classList.remove('open')">Close</button>
      <button class="btn btn-primary" id="view-edit-btn">Edit Bid</button>
    </div>
  </div>
</div>

<!-- PROPOSAL BUILDER MODAL (full screen) -->
<div class="modal-overlay" id="proposal-modal" style="align-items:stretch;padding:0;">
  <div style="background:var(--bg);width:100%;display:flex;flex-direction:column;animation:fadeIn 0.2s;position:relative;">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:58px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:14px;">
        <button class="modal-close" onclick="closeProposalModal()" style="font-size:20px;">‚úï</button>
        <div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--accent);" id="proposal-modal-title">Proposal Builder</div>
          <div style="font-size:11px;color:var(--muted);margin-top:-2px;" id="proposal-modal-sub"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-ghost" onclick="openMyCompanyModal()" style="font-size:12px;">‚öôÔ∏è My Company</button>
        <button class="btn btn-ghost" onclick="toggleSavedQuotesPanel()" style="font-size:12px;" id="saved-quotes-btn">üìÅ Saved Quotes</button>
        <button class="btn btn-ghost" onclick="saveCurrentQuote()" style="font-size:12px;border-color:var(--accent);color:var(--accent);">üíæ Save Quote</button>
        <button class="btn btn-primary" onclick="exportProposalPDF()" style="font-size:12px;">‚¨á Export PDF</button>
      </div>
    </div>
    <!-- Saved Quotes Slide Panel -->
    <div id="saved-quotes-panel" style="display:none;position:absolute;top:58px;right:0;width:340px;height:calc(100% - 58px);background:var(--surface);border-left:1px solid var(--border);z-index:200;flex-direction:column;overflow:hidden;box-shadow:-4px 0 20px rgba(0,0,0,0.3);">
      <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent);">Saved Quotes</div>
        <button onclick="toggleSavedQuotesPanel()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;line-height:1;">‚úï</button>
      </div>
      <div id="saved-quotes-list" style="flex:1;overflow-y:auto;padding:12px;"></div>
    </div>

    <!-- Page tabs -->
    <div style="display:flex;background:var(--surface2);border-bottom:1px solid var(--border);flex-shrink:0;">
      <div id="prop-tab-1" onclick="switchProposalPage(1)" style="padding:10px 24px;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid var(--accent);color:var(--accent);letter-spacing:0.5px;transition:all 0.15s;">Page 1 ‚Äî Estimate</div>
      <div id="prop-tab-2" onclick="switchProposalPage(2)" style="padding:10px 24px;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted);letter-spacing:0.5px;transition:all 0.15s;">Page 2 ‚Äî Inclusions & Terms</div>
    </div>
    <!-- Body: split panel -->
    <div class="proposal-builder" style="flex:1;overflow:hidden;">
      <!-- LEFT: Form -->
      <div class="proposal-form" id="prop-form-page1">

        <!-- Bid info banner -->
        <div id="proposal-bid-banner" style="display:none;background:rgba(245,166,35,0.08);border:1px solid rgba(245,166,35,0.25);border-radius:6px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:var(--accent);align-items:center;gap:8px;">
          <span style="font-size:15px;">üìã</span>
          <span id="proposal-bid-banner-text">Pre-filled from bid</span>
        </div>

        <!-- SECTION: Quote Reference -->
        <div style="margin-bottom:16px;display:flex;gap:10px;align-items:flex-end;">
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label class="form-label">Quote #</label>
            <input type="text" class="form-input" id="p-quote-num" placeholder="e.g. QGS-2026-001" oninput="updatePreview()">
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label class="form-label">Quote Name / Label</label>
            <input type="text" class="form-input" id="p-quote-label" placeholder="e.g. Dalhousie Care Center v1" oninput="updatePreview()">
          </div>
        </div>

        <!-- SECTION: TO (client) -->
        <div style="margin-bottom:18px;">
          <div class="section-label" style="margin-bottom:10px;">üì¨ To (Client)</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">Company</div>
          <div class="form-group" style="margin-bottom:8px;">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-input" id="p-client-company" placeholder="e.g. Built IT Calgary" oninput="updatePreview()">
          </div>
          <div class="form-grid" style="margin-bottom:8px;">
            <div class="form-group">
              <label class="form-label">Company Email</label>
              <input type="text" class="form-input" id="p-client-company-email" placeholder="info@company.com" oninput="updatePreview()">
            </div>
            <div class="form-group">
              <label class="form-label">Company Phone</label>
              <input type="text" class="form-input" id="p-client-company-phone" placeholder="+1 403 000 0000" oninput="updatePreview()">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:14px;">
            <label class="form-label">Company Address</label>
            <input type="text" class="form-input" id="p-client-company-address" placeholder="Street, City, Province" oninput="updatePreview()">
          </div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;border-top:1px solid var(--border);padding-top:12px;">Contact Person</div>
          <div class="form-group" style="margin-bottom:8px;">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-input" id="p-client" placeholder="e.g. Louisa Gwin" oninput="updatePreview()">
          </div>
          <div class="form-grid" style="margin-bottom:8px;">
            <div class="form-group">
              <label class="form-label">Contact Email</label>
              <input type="text" class="form-input" id="p-client-email" placeholder="louisa@company.com" oninput="updatePreview()">
            </div>
            <div class="form-group">
              <label class="form-label">Contact Phone</label>
              <input type="text" class="form-input" id="p-client-phone" placeholder="+1 403 000 0000" oninput="updatePreview()">
            </div>
          </div>
        </div>

        <!-- SECTION: Project Info -->
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:18px;">
          <div class="section-label" style="margin-bottom:10px;">üìê Project Information</div>
          <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">Project Name</label>
            <input type="text" class="form-input" id="p-project" placeholder="e.g. Dalhousie Care Center" oninput="updatePreview()">
          </div>
          <div class="form-grid" style="margin-bottom:10px;">
            <div class="form-group">
              <label class="form-label">Estimate Date</label>
              <input type="date" class="form-input" id="p-date" oninput="updatePreview()">
            </div>
            <div class="form-group">
              <label class="form-label">Addendum Received</label>
              <input type="number" class="form-input" id="p-addendum" placeholder="0" min="0" oninput="updatePreview()" value="0">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">Drawings / Specs Date</label>
            <input type="date" class="form-input" id="p-drawings-date" oninput="updatePreview()">
          </div>
          <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">Scope of Work / Description</label>
            <textarea class="form-textarea" id="p-scope" rows="3" placeholder="Describe the work to be performed..." oninput="updatePreview()"></textarea>
          </div>
        </div>

        <!-- SECTION: Pricing Categories -->
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:18px;">
          <div class="section-header" style="margin-bottom:14px;">
            <div class="section-label">üí∞ Pricing Categories</div>
            <button class="btn btn-primary btn-sm" onclick="addCategory()">+ Add Category</button>
          </div>
          <div id="categories-list"></div>
        </div>

        <!-- SECTION: Terms -->
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:18px;">
          <div class="section-label" style="margin-bottom:10px;">üìã Terms</div>
          <div class="form-grid" style="margin-bottom:10px;">
            <div class="form-group">
              <label class="form-label">Quote Valid For</label>
              <select class="form-select" id="p-quote-valid" onchange="updatePreview()">
                <option value="">‚Äî Select ‚Äî</option>
                <option value="30">30 days</option>
                <option value="45">45 days</option>
                <option value="60">60 days</option>
                <option value="90">90 days</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Material Pricing Held Until</label>
              <input type="text" class="form-input" id="p-material-until" placeholder="e.g. AUG 2026" oninput="updatePreview()">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">Footer / Bid Request Note</label>
            <input type="text" class="form-input" id="p-footer-note" placeholder="e.g. Bid request to be sent at info@company.com" oninput="updatePreview()">
          </div>
          <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">Additional Terms</label>
            <textarea class="form-textarea" id="p-terms" rows="2" placeholder="Any other terms..." oninput="updatePreview()"></textarea>
          </div>
          <!-- Line items visibility toggle -->
          <div style="background:rgba(245,166,35,0.06);border:1px solid rgba(245,166,35,0.2);border-radius:6px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--text);">Show itemized breakdown</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">Toggle line items on/off ‚Äî hide to show only category totals</div>
            </div>
            <label style="position:relative;display:inline-block;width:42px;height:24px;flex-shrink:0;">
              <input type="checkbox" id="p-show-items" checked onchange="updatePreview()" style="opacity:0;width:0;height:0;position:absolute;">
              <span id="p-show-items-track" style="position:absolute;inset:0;background:var(--accent);border-radius:24px;cursor:pointer;transition:background 0.2s;">
                <span id="p-show-items-thumb" style="position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:transform 0.2s;transform:translateX(18px);"></span>
              </span>
            </label>
          </div>
        </div>

      </div>
      <!-- RIGHT: Live preview page 1 -->
      <div class="proposal-preview" id="proposal-preview-panel">
        <div class="preview-doc" id="preview-doc"></div>
      </div>
    </div>

    <!-- PAGE 2 BUILDER -->
    <div class="proposal-builder" id="prop-page2-panel" style="flex:1;overflow:hidden;display:none;">
      <!-- LEFT: Page 2 Form -->
      <div class="proposal-form">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
          <div style="font-size:13px;color:var(--muted);">Editing Page 2 content. Pre-filled from <strong style="color:var(--text);">My Company ‚Üí Proposal Defaults</strong>.</div>
          <button class="btn btn-ghost btn-sm" onclick="resetPage2FromDefaults()">‚Ü∫ Reset from defaults</button>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">General Inclusions</label>
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One item per line</div>
          <textarea class="form-textarea" id="p2-inclusions" rows="7" placeholder="e.g.&#10;Supply and install all specified materials&#10;Labour and equipment&#10;Site cleanup" oninput="updatePreview2()"></textarea>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">General Exclusions</label>
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One item per line</div>
          <textarea class="form-textarea" id="p2-exclusions" rows="7" placeholder="e.g.&#10;Permits and inspections&#10;Design and engineering&#10;Hazardous material removal" oninput="updatePreview2()"></textarea>
        </div>

        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:16px;">
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Hourly Rates</label>
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One rate per line (e.g. Journeyman ‚Äî $95/hr)</div>
            <textarea class="form-textarea" id="p2-hourly" rows="5" placeholder="e.g.&#10;Journeyman ‚Äî $95/hr&#10;Apprentice ‚Äî $65/hr&#10;Foreman ‚Äî $110/hr" oninput="updatePreview2()"></textarea>
          </div>
        </div>

        <div style="border-top:1px solid var(--border);padding-top:16px;">
          <div class="form-group">
            <label class="form-label">Terms & Conditions</label>
            <textarea class="form-textarea" id="p2-terms" rows="8" placeholder="e.g.&#10;Payment due within 30 days of invoice.&#10;Quote valid for 45 days from issue date.&#10;All work to comply with local codes and regulations." oninput="updatePreview2()"></textarea>
          </div>
        </div>
      </div>

      <!-- RIGHT: Live preview page 2 -->
      <div class="proposal-preview" id="proposal-preview-panel-2">
        <div class="preview-doc" id="preview-doc-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- MY COMPANY MODAL -->
<div class="modal-overlay" id="my-company-modal">
  <div class="modal modal-lg" style="max-width:680px;">
    <div class="modal-header">
      <div class="modal-title">My Company Info</div>
      <button class="modal-close" onclick="closeMyCompanyModal()">‚úï</button>
    </div>
    <!-- Tabs -->
    <div style="display:flex;border-bottom:1px solid var(--border);background:var(--surface);">
      <div class="mc-tab active" id="mc-tab-info" onclick="switchMCTab('info')" style="padding:12px 20px;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid var(--accent);color:var(--accent);letter-spacing:0.5px;">üèóÔ∏è Company Info</div>
      <div class="mc-tab" id="mc-tab-defaults" onclick="switchMCTab('defaults')" style="padding:12px 20px;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted);letter-spacing:0.5px;">üìÑ Proposal Defaults</div>
    </div>

    <!-- TAB: Company Info -->
    <div id="mc-panel-info" class="modal-body">
      <div style="margin-bottom:20px;">
        <div class="form-label" style="margin-bottom:8px;">Company Logo</div>
        <div style="display:flex;align-items:center;gap:16px;">
          <div id="my-logo-preview" style="width:80px;height:80px;border-radius:8px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:28px;background:var(--surface2);overflow:hidden;cursor:pointer;" onclick="document.getElementById('logo-file-input').click()">üèóÔ∏è</div>
          <div>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('logo-file-input').click()">üìÅ Upload Logo</button>
            <input type="file" id="logo-file-input" accept="image/*" style="display:none" onchange="handleLogoUpload(this)">
            <div style="font-size:11px;color:var(--muted);margin-top:6px;">PNG, JPG or SVG ¬∑ shown on proposals</div>
            <button class="btn btn-sm" style="margin-top:6px;background:transparent;border:1px solid var(--border);color:var(--muted);font-size:11px;" onclick="clearLogo()">‚úï Remove</button>
          </div>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group form-full">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-input" id="my-name" placeholder="e.g. Quality Gypsum Inc.">
        </div>
        <div class="form-group form-full">
          <label class="form-label">Address</label>
          <input type="text" class="form-input" id="my-address" placeholder="85 Walgrove Rise SE, Calgary, AB">
        </div>
        <div class="form-group">
          <label class="form-label">Website</label>
          <input type="text" class="form-input" id="my-website" placeholder="www.yourcompany.ca">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="my-phone" placeholder="(403) 809-2908">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="my-email" placeholder="info@yourcompany.ca">
        </div>
        <div class="form-group">
          <label class="form-label">Contact Person Name</label>
          <input type="text" class="form-input" id="my-contact-name" placeholder="e.g. Fabian Vargas Garcia">
        </div>
      </div>
    </div>

    <!-- TAB: Proposal Defaults -->
    <div id="mc-panel-defaults" class="modal-body" style="display:none;">
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px;padding:10px 14px;background:rgba(245,166,35,0.06);border:1px solid rgba(245,166,35,0.2);border-radius:6px;">
        üí° These defaults auto-fill Page 2 of every new proposal. You can still edit them per-proposal.
      </div>
      <div class="form-group" style="margin-bottom:16px;">
        <label class="form-label">General Inclusions</label>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One item per line</div>
        <textarea class="form-textarea" id="my-inclusions" rows="6" placeholder="e.g.&#10;Supply and install all specified materials&#10;Labour and equipment&#10;Site cleanup&#10;Standard warranty on workmanship"></textarea>
      </div>
      <div class="form-group" style="margin-bottom:16px;">
        <label class="form-label">General Exclusions</label>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One item per line</div>
        <textarea class="form-textarea" id="my-exclusions" rows="6" placeholder="e.g.&#10;Permits and inspections&#10;Design and engineering&#10;Hazardous material removal&#10;Work outside scope of this estimate"></textarea>
      </div>
      <div class="form-group" style="margin-bottom:16px;">
        <label class="form-label">Hourly Rates</label>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">One rate per line (e.g. Journeyman ‚Äî $95/hr)</div>
        <textarea class="form-textarea" id="my-hourly-rates" rows="5" placeholder="e.g.&#10;Journeyman ‚Äî $95/hr&#10;Apprentice ‚Äî $65/hr&#10;Foreman ‚Äî $110/hr&#10;Overtime ‚Äî 1.5√ó standard rate"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Terms & Conditions</label>
        <textarea class="form-textarea" id="my-terms" rows="7" placeholder="e.g.&#10;Payment due within 30 days of invoice.&#10;Quote valid for 45 days from issue date.&#10;All work to comply with local codes and regulations.&#10;Changes to scope require written authorization."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeMyCompanyModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMyCompany()">Save & Apply to Proposals</button>
    </div>
  </div>
</div>

<!-- ASSIGN POPUP -->
<div class="assign-popup" id="assign-popup">
  <div class="assign-popup-title">Assign Team Members</div>
  <div id="assign-popup-list"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============ DATA ============

// TEAM MEMBERS
const teamMembers = [
  { id: 'FV', initials: 'FV', name: 'Fabian Vargas', bg: '#f5a62320', color: '#f5a623' },
];

let bids = [
  { id: 2000, name: 'Highfield Office T.I. Project', status: 'estimating', value: 0, contact: 'Domenic Migliarese', company: 'JVF Project Management & Consulting', due: '2026-02-25', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2001, name: 'Duplex - 1512, 20A St. NW', status: 'estimating', value: 0, contact: 'Dinko Condric', company: 'Swift Builders Ltd', due: '2026-02-25', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2002, name: '26C-0313 Shake Shack Macleod Trail', status: 'estimating', value: 0, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2026-02-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2003, name: '26.032 - Anejo , #6742 Seton , Calgary , AB', status: 'estimating', value: 0, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2026-03-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2004, name: 'Point Trotter 3 - Condo Project', status: 'estimating', value: 0, contact: 'Matthew Klassen', company: 'Ledcor Group', due: '2026-03-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2005, name: 'V2609 - FHS Bridgeport - Chestermere', status: 'estimating', value: 0, contact: 'Shirley Huynh', company: 'Versatile Developments', due: '2026-03-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2006, name: 'Budget Request: Tiny Einstein\'s Daycare', status: 'pending', value: 32065, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2025-03-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2007, name: 'Sage Hill Bldg J - Demising Wall', status: 'pending', value: 12067, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-03-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2008, name: 'Nova Vet', status: 'pending', value: 79523, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-04-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2009, name: '720 West Chesteremer Drive', status: 'pending', value: 31441, contact: 'Wayne Schmirler', company: 'TD renovation and Construction ltd', due: '2025-05-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2010, name: 'Silverado - BMO Demise - 2nd Phase', status: 'pending', value: 15060, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-05-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2011, name: 'Skylar Townhomes Buildings 1 & 2', status: 'pending', value: 293244, contact: 'Gibraltar', company: '', due: '2025-05-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2012, name: 'Pocock Residence - 2524 16A Street SE', status: 'pending', value: 15976, contact: 'Jaime Holland', company: 'Holland Licensed Interior Design', due: '2025-05-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2013, name: 'Soberys Liquor - Canmore', status: 'pending', value: 33146, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-05-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2014, name: 'CF Chinook Centre ‚Äì Demolition Scope for Admin Office Relocation', status: 'pending', value: 11950, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-05-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2015, name: 'Choice Properties Office Renovation', status: 'pending', value: 11023, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-05-30', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2016, name: 'Calgary CO-OP Cannabis Store - Seton', status: 'pending', value: 39576, contact: 'Francis Bordaje', company: 'Keller Construction Ltd', due: '2025-06-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2017, name: 'Community Natural Foods - Seton', status: 'pending', value: 111200, contact: 'Francis Bordaje', company: 'Keller Construction Ltd', due: '2025-06-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2018, name: 'CBE Arbour Lake Middle School', status: 'pending', value: 18210, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-06-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2019, name: 'CBE Arbour Lake Middle School (Demo)', status: 'pending', value: 10370, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-06-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2020, name: 'Mary Browns Deer Ridge', status: 'pending', value: 36330, contact: 'Marcelo Arantes', company: 'Build It', due: '2025-06-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2021, name: 'Shawarma Palace - Seton', status: 'pending', value: 50445, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-06-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2022, name: 'Charron Garage Project', status: 'pending', value: 3825, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2025-06-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2023, name: 'Evolve Chiropractic', status: 'pending', value: 49531, contact: 'Dinko Condric', company: 'Swift Builders Ltd', due: '2025-07-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2024, name: '25.092 - A&W, #1822, Didsbury, AB', status: 'pending', value: 52528, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-07-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2025, name: 'Willowbrae Sage Hill', status: 'pending', value: 243366, contact: 'Marc Brown', company: 'Keller Construction Ltd', due: '2025-07-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2026, name: 'Inspired Cannabis, Ranch Market, Strathmore, AB', status: 'pending', value: 0, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-07-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2027, name: 'BAILEY UPPER FLOOR - 618 3 AVE NE', status: 'pending', value: 12047, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2025-07-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2028, name: '25.101 - Pet Valu, #3301, Canmore, AB', status: 'pending', value: 22757, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-07-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2029, name: 'Dollarama - West Springs Landing', status: 'pending', value: 25167, contact: 'Juan Aquino', company: 'Planit Construction', due: '2025-07-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2030, name: 'Cushman Wakefield Tenant Partitioning', status: 'pending', value: 26087, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-07-30', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2031, name: 'Deerfoot 17 - Small Interior Office', status: 'pending', value: 8903, contact: 'Chris Craig', company: 'Centom Construction Ltd', due: '2025-08-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2032, name: 'Oldstreet Banff Muskrat (216 & 218 Muskrat Street)', status: 'pending', value: 459505, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-08-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2033, name: '25.120 - Inspired Cannabis, Lethbridge', status: 'pending', value: 8834, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-08-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2034, name: 'Drywall - Pickleplex Social club', status: 'pending', value: 137100, contact: 'Ali Aghigh', company: 'Catalyst Construction Group - Ajax', due: '2025-08-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2035, name: 'Demolition - Pickleplex Social club', status: 'pending', value: 54615, contact: 'Ali Aghigh', company: 'Catalyst Construction Group - Ajax', due: '2025-08-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2036, name: 'Tality Wellness', status: 'pending', value: 108330, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-08-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2037, name: 'East Lake EMS Dispatch Training Centre', status: 'pending', value: 12447, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-09-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2038, name: 'Rosie\'s Burger, Marda Loop, Calgary', status: 'pending', value: 11998, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2025-09-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2039, name: 'FHS West Springs Landing - T/I', status: 'pending', value: 16049, contact: 'Shirley Huynh', company: 'Versatile Developments', due: '2025-09-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2040, name: 'Dollar Tree #40314, CALGARY, AB', status: 'pending', value: 36078, contact: 'Giovanna Helmer', company: 'Mirabelli', due: '2025-09-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2041, name: '25.150 - Tim Hortons , #104939, Red deer , AB', status: 'pending', value: 14000, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2025-09-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2042, name: '1602 13 ave sw', status: 'pending', value: 116768, contact: 'Colin Godbout', company: 'Elevated', due: '2025-09-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2043, name: 'Vandervoort residence', status: 'pending', value: 23298, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-09-25', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2044, name: 'South Trail -Unit #75 -CosmoProf - Whitebox', status: 'pending', value: 55627, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-09-25', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2045, name: 'Centex Penbrook', status: 'pending', value: 17156, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-10-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2046, name: '25.146 - Cinnzeo, R027 Market Mall, Calgary, AB', status: 'pending', value: 5496, contact: 'Martin Maranon', company: 'BSI Build', due: '2025-10-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2047, name: 'Quarry Park CRU Reno', status: 'pending', value: 9937, contact: 'Rescom Estimating', company: '', due: '2025-10-06', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2048, name: 'Hello Nori Bridgeland', status: 'pending', value: 33696, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-10-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2049, name: 'V2566 - FHS South Trail - Cgy - DRYWALL Pricing', status: 'pending', value: 15960, contact: 'Shirley Huynh', company: 'Versatile Developments', due: '2025-10-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2050, name: 'Harrop HLE Package', status: 'pending', value: 5820, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-10-13', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2051, name: 'KLATT - HLE request for quote', status: 'pending', value: 39608, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2025-10-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2052, name: '25.164 - Inspired Cannabis, Park St, Cochrane , AB', status: 'pending', value: 10189, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2025-10-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2053, name: 'Swiston Residence Basemetn', status: 'pending', value: 9380, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-10-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2054, name: '75 hawkwood road', status: 'pending', value: 10780, contact: '', company: '', due: '2025-10-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2055, name: 'Elite Painting - Hampton Inn', status: 'pending', value: 11837, contact: 'Brad Bell', company: 'Elite Painting', due: '2025-10-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2056, name: 'Pizza Hut Tenant Improvement', status: 'pending', value: 17892, contact: 'Dusan Aralica', company: 'Novesta Projects', due: '2025-10-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2057, name: '25.133 Walmart 3151 Shawville AB Expanded', status: 'pending', value: 2916, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-10-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2058, name: 'IVY 28, BUILDING A, B, C', status: 'pending', value: 493698, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-10-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2059, name: 'EFC job - Right bay', status: 'pending', value: 46835, contact: 'Phetsamone Chanthamala', company: 'EFC Developments', due: '2025-10-30', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2060, name: 'Mother Dairy', status: 'pending', value: 0, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-10-31', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2061, name: 'Residential Townhouse Quote -Drywall/insulation', status: 'pending', value: 149626, contact: 'Able Abraham', company: 'Engineeredto Development Ltd', due: '2025-10-31', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2062, name: 'FWD Offices (Paint)', status: 'pending', value: 36500, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-11-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2063, name: 'FWD Offices', status: 'pending', value: 172371, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-11-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2064, name: 'Iannuzzi HLE Package', status: 'pending', value: 10579, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-11-13', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2065, name: 'V2611 Beaners', status: 'pending', value: 17540, contact: 'Shirley Huynh', company: 'Versatile Developments', due: '2025-11-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2066, name: '1715 - 37th St. SE', status: 'pending', value: 108294, contact: 'James Carter', company: 'Carter Home & Design', due: '2025-11-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2067, name: '25.200 - Pet Valu, #3300, Chestermere, AB', status: 'pending', value: 19837, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2025-11-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2068, name: 'Radiant Health Poplar Centre', status: 'pending', value: 60123, contact: 'Madison Inkster', company: 'Statera Contracting', due: '2025-11-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2069, name: 'NEWMAN DEANS', status: 'pending', value: 11959, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2025-12-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2070, name: 'Zimmerman project', status: 'pending', value: 9861, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2025-12-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2071, name: 'Dollar Tree, #D44078, Okotoks, AB', status: 'pending', value: 32898, contact: 'Martin Maranon', company: 'BSI Build', due: '2025-12-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2072, name: 'Fresh Slice Airdrie', status: 'pending', value: 17388, contact: 'Mike Garcia', company: 'Novesta Projects', due: '2025-12-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2073, name: 'City of Airdrie - Washroom Upgrades', status: 'pending', value: 5497, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2025-12-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2074, name: 'FS8 Marda Loop', status: 'pending', value: 10678, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2026-01-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2075, name: 'Wingstop, Deerfoot Meadows, Calgary, AB', status: 'pending', value: 38323, contact: 'Martin Maranon', company: 'BSI Build', due: '2026-01-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2076, name: '25.136 Walmart OMNI', status: 'pending', value: 1500, contact: 'Tracy Conrad', company: 'BSI Build / Theodore Builders', due: '2026-01-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2077, name: 'Bajnok HLE', status: 'pending', value: 19771, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2026-01-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2078, name: 'Barkley HLE', status: 'pending', value: 1275, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2026-01-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2079, name: '25.217 - Bulk Barn , Country Hills', status: 'pending', value: 45877, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2026-01-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2080, name: 'POD', status: 'pending', value: 66764, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2026-01-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2081, name: '25.220 - Pet Valu, #3306 Meredith Rd, Calgary , AB', status: 'pending', value: 18687, contact: 'Martin Maranon', company: 'BSI Build', due: '2026-01-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2082, name: 'Peartree & Burger 320', status: 'pending', value: 69498, contact: 'Kevin Brown', company: 'Build It', due: '2026-01-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2083, name: '4 Plex - 652 Acadia Drive SE', status: 'pending', value: 116731, contact: 'Wayne Schmirler', company: 'TD renovation and Construction ltd', due: '2026-01-23', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2084, name: '25.112 - EverBright Signature, Kingsview Road, Airdrie, AB', status: 'pending', value: 98030, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2026-01-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2085, name: '215 8A Street NE', status: 'pending', value: 69808, contact: 'David Mirosevic', company: 'Platinum Homes Canada Ltd.', due: '2026-01-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2086, name: '140 Taradale CL NE  - Gypsum Quote', status: 'pending', value: 17789, contact: '', company: '', due: '2026-01-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2087, name: '604 Sloane Square', status: 'pending', value: 19461, contact: 'Nick lobello', company: 'FWD Construction', due: '2026-02-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2088, name: 'Glendale 3-Plex (Due Feb 6)', status: 'pending', value: 70293, contact: 'Simona Smolejova', company: 'My Home Options Ltd', due: '2026-02-06', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2089, name: '26.012 - Tim Hortons, #105306, Didsbury , AB', status: 'pending', value: 21470, contact: 'Trevor Crowdis', company: 'BSI Build / Theodore Builders', due: '2026-02-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2090, name: 'Dalhousie Care Center', status: 'pending', value: 182107, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2026-02-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2091, name: '26-32741-EMG - Vilma Abalos', status: 'pending', value: 20723, contact: 'Angel Garant', company: 'First General Services (Calgary) Inc.', due: '2026-02-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2092, name: 'Gow HLE  - GYPSUM QUOTE', status: 'pending', value: 3904, contact: 'Lauren Wood', company: 'LD&A Ltd', due: '2026-02-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2093, name: 'Ktichen Standerwick  - 408 9A Street NE', status: 'pending', value: 5590, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2094, name: '403 31 Ave NE Calgary, AB T2E 2E3, Canada', status: 'pending', value: 4800, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2095, name: 'CBE Radisson Park School', status: 'pending', value: 15068, contact: 'Ammar Hamad', company: 'FWD Construction', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2096, name: 'Golden Sand Restaurant, Tuesday, Jun 24 ¬∑ 10‚Äì11‚ÄØAM', status: 'pending', value: 3825, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2097, name: '3422 Richmond Road SW', status: 'pending', value: 123017, contact: 'Anthony Cimino', company: 'Lusso Custom Homes Inc', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2098, name: 'One 8T Wellness- Marda Loop', status: 'pending', value: 88916, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2099, name: 'Shawarma Palace Seton - RFQ - RFP Supply & Install', status: 'pending', value: 11583, contact: 'Deola Onifade', company: 'Cornad Contracting Inc', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2100, name: 'Zara CF Markket mall', status: 'pending', value: 110684, contact: 'mathew Construction', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2101, name: '1036 Drury Ave', status: 'pending', value: 94647, contact: 'Wade Adams', company: '42Tech Modular', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2102, name: 'Aldersyde WTP (copy)', status: 'won', value: 107460, contact: 'Munaf Ladha', company: 'Maple Reinders', due: '2024-06-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2103, name: 'Bell helicopter TI', status: 'won', value: 20496, contact: 'Don Bergerman', company: 'EFC Developments', due: '2024-06-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2104, name: 'Brisson - Kucharski HLE', status: 'won', value: 9557, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2024-06-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2105, name: 'Ogilve - 408 9A Street NE', status: 'won', value: 19339, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2024-08-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2106, name: 'BBB #5 1709 8th Ave NE', status: 'won', value: 56222, contact: 'Corrie Massie', company: 'Bedrock Construction Ltd', due: '2024-08-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2107, name: 'Taco Bell 32 ave NE', status: 'won', value: 29500, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-10-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2108, name: 'Eggenshwiler Hle', status: 'won', value: 8532, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2024-11-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2109, name: '24.175 - Montrose Daycare, Design Build, Calgary, AB (copy)', status: 'won', value: 49765, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-11-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2110, name: 'Bulk Barn Calgary - Interior Fit-Out (copy)', status: 'won', value: 43622, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-11-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2111, name: 'Newman Deans - 3237 6st Se Calgary', status: 'won', value: 7888, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2024-12-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2112, name: 'Mega Courts Tender Package', status: 'won', value: 26522, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2024-12-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2113, name: 'Thrift store renovation, airdrie', status: 'won', value: 23315, contact: 'Jeremy Hiscock', company: 'BSI Build', due: '2024-12-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2114, name: 'HR1362 - Heston', status: 'won', value: 17484, contact: 'Ryan Wyngaarden', company: 'Nelson Homes', due: '2025-01-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2115, name: '228 West Chestermere Drive', status: 'won', value: 114844, contact: 'Troy Schmirler', company: 'TD renovation and Construction ltd', due: '2025-01-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2116, name: 'Loop 15 A & B', status: 'won', value: 234121, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-01-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2117, name: 'AB Clinic Airdrie - Tenant Improvement', status: 'won', value: 51145, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-01-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2118, name: 'Seton Car Wash- Telsec (copy)', status: 'won', value: 8800, contact: 'Paul Pashulka', company: 'Telsec Property Corp', due: '2025-01-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2119, name: 'Red\'s Diner Seton (copy)', status: 'won', value: 45750, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-02-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2120, name: '24 Stage Coach Trail (copy)', status: 'won', value: 56574, contact: 'Troy Schmirler', company: 'TD renovation and Construction ltd', due: '2025-02-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2121, name: 'FS8 Pilates Studio (copy)', status: 'won', value: 23973, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2025-03-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2122, name: 'HR1365SC (Sutherland) (copy)', status: 'won', value: 0, contact: 'Ryan Wyngaarden', company: 'Nelson Homes', due: '2025-03-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2123, name: 'Pizzaholic, Niazi Group, Calgary, AB', status: 'won', value: 21810, contact: 'Jeremy Hiscock', company: 'BSI Build', due: '2025-03-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2124, name: 'O\'Brien - 228 PARKGLEN CRESCENT SE (copy)', status: 'won', value: 8100, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-03-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2125, name: '209 10th st NE - Cheryl, Tuesday, Mar 11 ¬∑ 11‚ÄØAM‚Äì12‚ÄØPM (copy)', status: 'won', value: 12231, contact: 'Cheryl Barr', company: 'Home Owner', due: '2025-03-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2126, name: 'Hinnell 2.0  tender', status: 'won', value: 6887, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2025-04-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2127, name: 'Glenbrook 37 #1', status: 'won', value: 149180, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-04-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2128, name: 'Glenbrook 37 #2', status: 'won', value: 120551, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2025-04-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2129, name: 'Seton Carwash (copy)', status: 'won', value: 73380, contact: 'Paul Pashulka', company: 'Telsec Property Corp', due: '2025-04-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2130, name: 'Time Horton\'s Homestead (copy)', status: 'won', value: 32920, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2025-04-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2131, name: '228 Parkglen Crescent SE Calgary, AB T2J 4M2, Canada (copy)', status: 'won', value: 8100, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2025-06-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2132, name: 'Marda Station and Lincoln Park Centre (copy)', status: 'won', value: 26770, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-06-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2133, name: 'Marda Station and Lincoln Park Centre (Demo) (copy)', status: 'won', value: 60783, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-06-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2134, name: '25.103 - Mary Browns, #9152, Medicine Hat, AB (copy)', status: 'won', value: 37736, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-07-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2135, name: 'Burger king - cochrane (copy)', status: 'won', value: 39275, contact: 'John Mclelland', company: 'Versatile Developments', due: '2025-07-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2136, name: '25.113 - Inspired Cannabi Strathmore, (copy)', status: 'won', value: 10200, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-08-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2137, name: 'Mary Browns, #9168 West Springs (copy)', status: 'won', value: 26457, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-09-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2138, name: 'Newman Deans - Ld&a, Wednesday, Jan 22 ¬∑ 2‚Äì3‚ÄØPM (copy)', status: 'won', value: 8388, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2139, name: 'Avalon Seton (copy)', status: 'won', value: 94654, contact: 'Graham O\'neil', company: 'Avalon', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2140, name: 'Swiston - 159 Oakside circle sw. BSMT (copy)', status: 'won', value: 9380, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2141, name: 'Loop 36 (20 units) Multi Family', status: 'won', value: 293920, contact: 'Jon Turton', company: 'Old Street Dev.', due: '2024-03-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2142, name: 'Mountain Ridge - Black Diamond', status: 'won', value: 71380, contact: 'Jignesh Parikh', company: 'Span West building corporation', due: '2024-04-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2143, name: 'Eauclaire Gym- TELSEC 101 3 St SW, Calgary, AB T2P 4G6', status: 'won', value: 307147, contact: 'Brad Macauley', company: 'Telsec Property Corp', due: '2024-06-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2144, name: 'RCS 1576 20 Ave NE', status: 'won', value: 12000, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-07-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2145, name: 'RCS 1545 4th Street NW', status: 'won', value: 16000, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-07-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2146, name: 'Bowman - 519 19 Ave SW (copy)', status: 'won', value: 22150, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-08-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2147, name: 'Hear Canada, 80748 East Hills, Calgary (copy)', status: 'won', value: 23600, contact: 'Martin Maranon', company: 'BSI Build', due: '2024-10-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2148, name: '79 Valley Brook Cir NW Calgary, AB T3B 5S2, Canada (copy)', status: 'won', value: 2236, contact: 'Bronwen Davis', company: 'Private Owner', due: '2024-10-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2149, name: 'Bailey  - 4235 40 Street NW (copy)', status: 'won', value: 4880, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2024-07-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2150, name: 'Standerwick  - 408 9A Street NE', status: 'won', value: 19339, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2024-08-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2151, name: 'Crawford - 4 Verna Place', status: 'won', value: 8692, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-08-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2152, name: 'O\'sullivan - 334B Silvergrove Place NW', status: 'won', value: 23800, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-09-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2153, name: 'Brideland - 510 7 Street NE', status: 'won', value: 29170, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-11-23', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2154, name: 'Fat Burger Seton', status: 'won', value: 5296, contact: 'Don Bergerman', company: 'EFC Developments', due: '2023-12-06', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2155, name: 'Staples - 215 10 St NE', status: 'won', value: 2834, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-12-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2156, name: 'Stewart - Ghostlake, AB', status: 'won', value: 51000, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-12-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2157, name: 'LCD Deerfoot', status: 'won', value: 8415, contact: 'Don Bergerman', company: 'EFC Developments', due: '2023-12-13', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2158, name: 'O\'Connor - 84 Westover Drive SW', status: 'won', value: 17834, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-01-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2159, name: 'Workhub New Office', status: 'won', value: 42602, contact: 'Brian Nodwell', company: 'Workhub Software', due: '2024-02-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2160, name: 'EFC Warehouse Reno', status: 'won', value: 16929, contact: 'Don Bergerman', company: 'EFC Developments', due: '2024-02-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2161, name: 'Mcconnachie - 1429 4 street NW', status: 'won', value: 8160, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-02-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2162, name: '110 9TH AVE SW - Tbar Repair', status: 'won', value: 3280, contact: 'Connor Linton', company: 'Interior Care', due: '2024-03-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2163, name: '28 East Lake Green Bldg # 3', status: 'won', value: 33446, contact: 'Derek Selanders', company: 'Birchcliff properties', due: '2024-03-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2164, name: 'Kirchmayer - 458 Sienna Heights Hill SW', status: 'won', value: 18427, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-04-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2165, name: 'HR1341 (Heston)', status: 'won', value: 16173, contact: 'Ryan Wyngaarden', company: 'Nelson Homes', due: '2024-04-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2166, name: 'SWISTON HLE - 159 Oakside Circle SW', status: 'won', value: 18135, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-04-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2167, name: 'WEE WILD ONES', status: 'won', value: 151702, contact: 'Franco Falcone', company: 'BSI Build', due: '2024-04-23', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2168, name: 'Brideland - 510 7 Street NE (BSMT)', status: 'won', value: 10645, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-04-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2169, name: 'GRINDE HLE - 7004 Kenosee Place Sw', status: 'won', value: 10526, contact: 'Jenna Dimler', company: 'LD&A Ltd', due: '2024-05-30', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2170, name: '185 Pennsburg Way SE', status: 'won', value: 3369, contact: 'Murray Petkau', company: 'Melanson Homes & Renovations  Ellie Cabinet Co.', due: '2024-05-31', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2171, name: '22 Citadel Meadow Crescent NW - BSMT', status: 'won', value: 5910, contact: 'Warren Muller', company: 'WMGC Solutions', due: '2024-07-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2172, name: '544 River AVE, Cochrane - BSMT Legal Suite (copy)', status: 'won', value: 10600, contact: 'Warren Muller', company: 'WMGC Solutions', due: '2024-07-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2173, name: 'RCS 1575 Country Hills', status: 'won', value: 16400, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-07-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2174, name: 'Crumbl Cookies - Deerfoot City (copy)', status: 'won', value: 26900, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-07-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2175, name: '48 Beacham Rd NW, Calgary', status: 'won', value: 8000, contact: 'Warren Muller', company: 'WMGC Solutions', due: '2024-07-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2176, name: 'Rothwell 4307 Elbow Drive SW', status: 'won', value: 2500, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2024-07-31', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2177, name: '2007 35 AVE SW (copy)', status: 'won', value: 7743, contact: 'Daniel Senecal', company: 'Home Owner', due: '2024-08-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2178, name: 'Norville - 1137 18th Ave NW', status: 'lost', value: 4082, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-10-13', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2179, name: 'Quine - 1318 Southbow Place SW', status: 'lost', value: 10963, contact: 'Neil Bailey', company: 'LD&A Ltd', due: '2023-10-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2180, name: 'Wilhelm - 79 Bearspaw Loop', status: 'lost', value: 26245, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2024-09-23', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2181, name: '32247-373 Avenue West Aldersyde AB', status: 'lost', value: 70130, contact: 'Candice Cretney', company: 'Cascade Custom Home Ltd', due: '2024-11-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2182, name: 'St. Edmund King and Martyr Anglican Church', status: 'lost', value: 36830, contact: 'Frank Corbett', company: 'The Anglican Diocese of Calgary', due: '2024-11-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2183, name: '24.210 - Pet Valu, #3202, Airdrie', status: 'lost', value: 20240, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-11-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2184, name: 'Walker Residence - 522 5 St, Canmore, AB T1W 2G3', status: 'lost', value: 80426, contact: 'Candice Cretney', company: 'Cascade Custom Home Ltd', due: '2024-11-29', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2185, name: '24.200 - Pet Valu, #3104, Yorkton, Saskatchewan', status: 'lost', value: 47580, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-12-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2186, name: 'Canna Cabana - Cochrane', status: 'lost', value: 28193, contact: 'Pratiksha Mahant', company: 'Dawn Construction (2018) Ltd.', due: '2025-01-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2187, name: '24.219 - Cora\'s, Symons Valley, Calgary Alberta', status: 'lost', value: 29080, contact: 'Carlle Balanquit', company: 'BSI Build', due: '2025-01-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2188, name: 'Mustard Seed Building 110 Renov - Women Shelter', status: 'lost', value: 178459, contact: 'Munaf Ladha', company: 'Maple Reinders', due: '2025-01-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2189, name: 'Ace Liquor Hunterhorn Relocation', status: 'lost', value: 19390, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-01-19', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2190, name: '7801 Hunterquay Rd NW - Candice', status: 'lost', value: 9200, contact: 'Candice Cretney', company: 'Cascade Custom Home Ltd', due: '2025-01-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2191, name: '25.005 - Pet Valu, _3223, Cochrane, AB', status: 'lost', value: 32876, contact: 'Martin Maranon', company: 'BSI Build', due: '2025-01-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2192, name: 'Equipment Express - Telsec', status: 'lost', value: 10155, contact: 'Brad Macauley', company: 'Telsec Property Corp', due: '2025-01-30', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2193, name: 'HInnel Residence', status: 'lost', value: 6887, contact: 'Lindsey Tsang', company: 'LD&A Ltd', due: '2025-02-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2194, name: 'Moench - 6312 Lynch Crescent SW', status: 'lost', value: 72952, contact: 'Candice Cretney', company: 'Cascade Custom Home Ltd', due: '2025-02-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2195, name: '1120 68ave NE Traffic Tech', status: 'lost', value: 36654, contact: 'Brad Macauley', company: 'Telsec Property Corp', due: '2025-02-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2196, name: 'Belvedere Market Development', status: 'lost', value: 0, contact: 'Austin Rossmann', company: 'Keller Construction Ltd', due: '2025-02-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2197, name: '#761005 Sherwin Williams', status: 'lost', value: 22500, contact: 'Helen Claridge', company: 'Akela Construction Ltd', due: '2025-02-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2198, name: 'Carstairs Reservoir', status: 'lost', value: 8400, contact: 'Darija Svilar', company: 'Maple Reinders', due: '2025-02-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2199, name: 'Bow City Storage CRU\'s 1 & 2', status: 'lost', value: 177084, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-02-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2200, name: 'Big Springs Plaza Airdrie', status: 'lost', value: 60560, contact: 'John Arcurri', company: 'Ashton Luxury Living', due: '2025-02-25', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2201, name: 'Calgary Sports Plex Project, Monday, Feb 24 ¬∑ 11:30‚Äì11:45‚ÄØAM', status: 'lost', value: 11649, contact: 'Don Bergerman', company: 'EFC Developments', due: '2025-02-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2202, name: '25.033 - Mary Browns, #9176, Calgary, AB', status: 'lost', value: 37000, contact: 'Carlle Balanquit', company: 'BSI Build', due: '2025-03-10', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2203, name: 'Fleischmans Yeast Offices', status: 'lost', value: 29920, contact: 'Jeremy Hiscock', company: 'BSI Build', due: '2025-03-12', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2204, name: 'Belmont Apartments - B1', status: 'lost', value: 1856970, contact: 'Wilson Chuong', company: 'Luxuria Group', due: '2025-03-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2205, name: 'Belmont Apartments - B3', status: 'lost', value: 924264, contact: 'Wilson Chuong', company: 'Luxuria Group', due: '2025-03-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2206, name: 'Belmont Apartments - B2', status: 'lost', value: 1474504, contact: 'Wilson Chuong', company: 'Luxuria Group', due: '2025-03-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2207, name: 'Fat Bastard Red Deer Tender package', status: 'lost', value: 17384, contact: 'Carlle Balanquit', company: 'BSI Build', due: '2025-03-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2208, name: 'Cedar + Steam - Trinity Hills Tender package', status: 'lost', value: 108872, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-03-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2209, name: 'Niko\'s Pizza - Bridlewood location', status: 'lost', value: 6877, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-03-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2210, name: 'Triple Eight Shipping/Receiving Office', status: 'lost', value: 49600, contact: 'Adam Rosendahl', company: 'JVF Project Management & Consulting', due: '2025-03-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2211, name: 'Time Horton\'s Homestead', status: 'lost', value: 0, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2025-04-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2212, name: 'Boyer Vet', status: 'lost', value: 0, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-04-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2213, name: 'Glendeer - East Demise', status: 'lost', value: 0, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-04-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2214, name: 'Enbridge - 640 Palmer Rd NE (DEMO)', status: 'lost', value: 10100, contact: 'Phetsamone Chanthamala', company: 'EFC Developments', due: '2025-04-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2215, name: 'Enbridge - 640 Palmer Rd NE (Drywall)', status: 'lost', value: 30246, contact: 'Phetsamone Chanthamala', company: 'EFC Developments', due: '2025-04-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2216, name: 'Best Buy Airdrie', status: 'lost', value: 0, contact: 'Harkeerat Singh', company: 'Direct Construction Company Limited', due: '2025-04-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2217, name: 'Pinewood Place Expansion', status: 'lost', value: 0, contact: 'Helen Claridge', company: 'Akela Construction Ltd', due: '2025-04-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2218, name: 'Dave\'s Hot Chiken -  Beacon Hill', status: 'lost', value: 0, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-04-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2219, name: 'Dave\'s Hot Chiken - Macleod', status: 'lost', value: 0, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-04-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2220, name: 'Lifemark - Bridlewood', status: 'lost', value: 0, contact: 'Colin Letawsky', company: 'Fillmore Construction - Edmonton', due: '2025-04-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2221, name: 'Paradigm Spark - TI', status: 'lost', value: 0, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-04-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2222, name: '25.057 - Harveys, #2810, Calgary, AB', status: 'lost', value: 0, contact: 'Joey Calvitti', company: 'BSI Build', due: '2025-04-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2223, name: 'Soprema', status: 'lost', value: 0, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-05-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2224, name: 'Model Suite Office', status: 'lost', value: 0, contact: 'Marcelo Arantes', company: 'Build It', due: '2025-05-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2225, name: 'IKO Office', status: 'lost', value: 0, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-05-06', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2226, name: 'Village Ice Cream', status: 'lost', value: 17510, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-05-14', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2227, name: 'Opa! of Greece', status: 'lost', value: 23281, contact: 'Alsion Erwood', company: 'Vanguard Commercial Services', due: '2025-05-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2228, name: 'Brookfield Livingston - Calgary', status: 'lost', value: 0, contact: 'Greg Clarke', company: 'Traugott Building Contractors', due: '2025-05-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2229, name: 'Tim Hortons Park Street', status: 'lost', value: 0, contact: 'Marcelo Arantes', company: 'Build It', due: '2025-06-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2230, name: 'Shawnessy Unit 250 - Demolition', status: 'lost', value: 0, contact: 'Ammar Hamad', company: 'FWD Construction', due: '2025-06-13', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2231, name: 'Cool Drinks YYC', status: 'lost', value: 0, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-06-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2232, name: 'DHC Calgary', status: 'lost', value: 0, contact: 'Victoria Temple', company: 'Carbon Build', due: '2025-07-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2233, name: 'Atrium Tennant Improvement', status: 'lost', value: 0, contact: 'Peter Kiranas', company: 'Aethos Strategic', due: '2025-08-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2234, name: 'City of Calgary Prairie Sky Admin Building', status: 'lost', value: 0, contact: 'Austin Rossmann', company: 'Keller Construction Ltd', due: '2025-10-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2235, name: 'Calgary - Standard Life Building - 9th Floor Legal Services Division Office', status: 'lost', value: 0, contact: 'Nick lobello', company: 'FWD Construction', due: '2025-10-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2236, name: 'Skin Vault South Bank Inglewood', status: 'lost', value: 0, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-10-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2237, name: 'Pulse Fitness', status: 'lost', value: 0, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2025-10-22', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2238, name: 'WH11 Office Space', status: 'lost', value: 0, contact: 'Stephen Chen', company: 'FWD Construction', due: '2025-10-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2239, name: 'Mother Dairy - Tenant Improvement', status: 'lost', value: 0, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2025-10-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2240, name: 'Abadata 3', status: 'lost', value: 0, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2241, name: '132 Cedarpark Dr SW', status: 'lost', value: 9587, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2242, name: '10727 Maplecreek Dr. SE - Garage Suite', status: 'lost', value: 23792, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2243, name: 'Abbeydale Community Association', status: 'lost', value: 30409, contact: 'Caleb Webb', company: 'Quest Construction and Management', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2244, name: '289 Aspen Summit Height', status: 'lost', value: 62337, contact: 'Nicole Phee', company: 'Home By Us', due: '2023-11-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2245, name: '322 Aspen Summit Height', status: 'lost', value: 67342, contact: 'Nicole Phee', company: 'Home By Us', due: '2023-11-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2246, name: '338 Aspen Summit Height', status: 'lost', value: 44766, contact: 'Nicole Phee', company: 'Home By Us', due: '2023-11-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2247, name: '4318 4A Street SW', status: 'lost', value: 75795, contact: 'Michelle Skerry', company: 'CNJ Developments', due: '2023-12-05', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2248, name: '3833 7A Street SW', status: 'lost', value: 60838, contact: 'Michelle Skerry', company: 'CNJ Developments', due: '2023-12-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2249, name: '416 48 AVE SW', status: 'lost', value: 60749, contact: 'Michelle Skerry', company: 'CNJ Developments', due: '2024-01-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2250, name: '8104 46 Avenue NW', status: 'lost', value: 120100, contact: 'Niklas Bartsch', company: 'Konstruct Developments Ltd', due: '2024-02-24', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2251, name: '3343 Varna Crescent NW', status: 'lost', value: 68624, contact: 'John Arcurri', company: 'Ashton Luxury Living', due: '2024-02-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2252, name: 'ATB Redemise', status: 'lost', value: 52930, contact: 'Helen Claridge', company: 'Akela Construction Ltd', due: '2024-03-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2253, name: 'Radius Calgary TI', status: 'lost', value: 34657, contact: 'Brett Robinson', company: 'Novacom Building Partners Ltd', due: '2024-03-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2254, name: '1958 19 street NW', status: 'lost', value: 19821, contact: 'Paul Davis', company: 'Home Owner', due: '2024-03-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2255, name: 'Trinity Demising wall', status: 'lost', value: 110270, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-03-27', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2256, name: 'EFC Warehouse (Floor Paint)', status: 'lost', value: 2500, contact: 'Don Bergerman', company: 'EFC Developments', due: '2024-04-03', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2257, name: '137 Vista Cres, Vulcan County', status: 'lost', value: 37100, contact: 'Brian Dotinga', company: 'Luxridge Custom Builders Ltd', due: '2024-04-09', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2258, name: 'Weins - 1227 18A Street NW', status: 'lost', value: 13324, contact: 'Murray Petkau', company: 'Melanson Homes & Renovations  Ellie Cabinet Co.', due: '2024-04-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2259, name: 'DEMISING WALL -  49 AERO DR NE #16', status: 'lost', value: 18165, contact: 'Matt Thompson', company: 'EFC Developments', due: '2024-04-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2260, name: 'WestBroek - 241 Hidden Creek Road', status: 'lost', value: 7680, contact: 'Murray Petkau', company: 'Melanson Homes & Renovations  Ellie Cabinet Co.', due: '2024-04-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2261, name: 'HEAR Canada Airdrie 80744', status: 'lost', value: 30500, contact: 'Joon Yi', company: 'BSI Build', due: '2024-04-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2262, name: 'HEAR Canada Lethbridge 80743', status: 'lost', value: 38300, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-04-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2263, name: '236 East Lakeview Place Chestermere, AB', status: 'lost', value: 75448, contact: 'Sunny Dhaliwal', company: 'Gill Developments', due: '2024-04-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2264, name: '1308 17 AVE NW A & B', status: 'lost', value: 166807, contact: 'Sunny Dhaliwal', company: 'Gill Developments', due: '2024-04-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2265, name: '6626 18 ST SE', status: 'lost', value: 25716, contact: 'Sunny Dhaliwal', company: 'Gill Developments', due: '2024-04-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2266, name: '3719 A & B SARCEE RD SW', status: 'lost', value: 76132, contact: 'Sunny Dhaliwal', company: 'Gill Developments', due: '2024-04-26', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2267, name: 'The Vibe - 1905 45 ST SW', status: 'lost', value: 1636597, contact: 'Sai Ram', company: 'PK Developments', due: '2024-05-02', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2268, name: 'Job #185 - 6823 Lawrence Court SW', status: 'lost', value: 47819, contact: 'Marc Lehodey', company: 'Rectangle Design', due: '2024-05-16', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2269, name: 'Choudry Residence Bearspaw Lot 28 Silverhorn Meadows', status: 'lost', value: 154000, contact: 'Imran Choudry', company: 'Dwell Custom Homes', due: '2024-05-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2270, name: 'Camp Kindle', status: 'lost', value: 186870, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2024-05-21', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2271, name: 'Leading Edge Physiotherapy- Glenmore', status: 'lost', value: 32128, contact: 'Jeffrey Byma', company: 'Rescom Construction Management Inc', due: '2024-06-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2272, name: '24.090 - Trinity Hills, J3 104-105 | Demising wall', status: 'lost', value: 24000, contact: 'Jack Che', company: 'BSI Build', due: '2024-06-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2273, name: 'Jackson Port Commercial', status: 'lost', value: 92392, contact: 'Sunny Dhaliwal', company: 'Gill Developments', due: '2024-07-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2274, name: 'Starbucks Hunterhorn Base building', status: 'lost', value: 21006, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2024-07-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2275, name: 'Dream Washroom Kensington', status: 'lost', value: 6500, contact: 'Don Bergerman', company: 'EFC Developments', due: '2024-07-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2276, name: 'Trinity Group, Unit J2-104 LLW - Demising Wall', status: 'lost', value: 20733, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-08-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2277, name: '606 4th st Calgary.', status: 'lost', value: 4800, contact: 'Brainard Vibora', company: 'EFC Developments', due: '2024-09-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2278, name: 'Oaktree Expansion - 1621 32nd Ave NE, Calgary', status: 'lost', value: 31620, contact: 'Ashish Chopra', company: 'Build It', due: '2024-09-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2279, name: 'Pet Valu, #3227 Evanston, Calgary', status: 'lost', value: 11967, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-09-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2280, name: 'Starbucks Coventry Hills Tender Package', status: 'lost', value: 21540, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2024-10-01', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2281, name: '42tech modular', status: 'lost', value: 44360, contact: 'Wade Adams', company: '42Tech Modular', due: '2024-10-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2282, name: 'Highly Fun Daycare', status: 'lost', value: 23746, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2024-10-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2283, name: '4615 112th Ave SE Bay 105', status: 'lost', value: 3924, contact: 'Gerald Depuis', company: 'Telsec Property Corp', due: '2024-10-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2284, name: '2129 Victoria Crescent NW', status: 'lost', value: 71678, contact: 'Dilesh Sidhpura', company: 'Hockaday Homes', due: '2024-10-11', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2285, name: 'Trinity Group, B4.6 Second Cup', status: 'lost', value: 21985, contact: 'Joey Calvitti', company: 'BSI Build', due: '2024-10-17', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2286, name: 'Egg Club Calgary', status: 'lost', value: 16036, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2024-10-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2287, name: '2624 14 Ave Se - Duplex', status: 'lost', value: 61487, contact: 'Ali Hamdan', company: 'Private Owner', due: '2024-10-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2288, name: 'Kinton Ramen - Uxborough', status: 'lost', value: 28000, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2024-10-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2289, name: 'Kinton Ramen Mission', status: 'lost', value: 29720, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2024-11-04', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2290, name: 'Oak & Olive Building C', status: 'lost', value: 14341, contact: 'Brian Madayag', company: 'Truman Homes', due: '2024-11-08', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2291, name: 'Arlington Realty - Demising wall', status: 'lost', value: 25930, contact: 'Louisa Gwin', company: 'BIBD (Calgary) Inc.', due: '2024-11-15', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2292, name: 'Custom Home 714 2nd Street Canmore', status: 'lost', value: 78136, contact: 'Candice Cretney', company: 'Cascade Custom Home Ltd', due: '2024-11-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2293, name: 'Atlas Office Reno', status: 'lost', value: 0, contact: 'Dinko Condric', company: 'Swift Builders Ltd', due: '2024-11-18', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2294, name: 'The Bike Shop', status: 'lost', value: 141288, contact: 'FCMI Estimating', company: 'Fillmore Construction - Edmonton', due: '2024-11-20', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2295, name: 'Rajdhani Sweets Tender Package', status: 'lost', value: 0, contact: 'Courtney Lewis', company: 'BIBD (Calgary) Inc.', due: '2024-11-28', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2296, name: 'Starbucks Hunterhorn TI Tender package', status: 'lost', value: 0, contact: 'Rebeka Tavares', company: 'BIBD (Calgary) Inc.', due: '2025-01-07', construction: '', notes: '', files: [], assigned: ['FV'] },
  { id: 2297, name: '19605 Walden Blvd SE Calgary, AB T2X 4C4, Canada', status: 'lost', value: 0, contact: '', company: '', due: '', construction: '', notes: '', files: [], assigned: ['FV'] },
];

let editingBidId = null;
let pendingFiles = [];
let modalAssigned = [];
let currentFilter = 'all';
let nextId = 1000;
let assignPopupBidId = null;

// ============ MODAL ASSIGN ============
function renderModalAssign() {
  const grid = document.getElementById('modal-assign-grid');
  grid.innerHTML = teamMembers.map(m => {
    const selected = modalAssigned.includes(m.id);
    return `
      <div class="assign-toggle ${selected ? 'selected' : ''}"
           style="${selected ? `background:${m.bg};border-color:${m.color};color:${m.color};` : ''}"
           onclick="toggleModalAssign('${m.id}')">
        <div class="assign-toggle-avatar" style="background:${m.color}33;color:${m.color};">${m.initials}</div>
        ${m.name}
      </div>
    `;
  }).join('');
}

function toggleModalAssign(id) {
  if (modalAssigned.includes(id)) {
    modalAssigned = modalAssigned.filter(x => x !== id);
  } else {
    modalAssigned.push(id);
  }
  renderModalAssign();
}

// ============ INLINE ASSIGN POPUP ============
function openAssignPopup(e, bidId) {
  e.stopPropagation();
  assignPopupBidId = bidId;
  const popup = document.getElementById('assign-popup');
  const bid = bids.find(b => b.id === bidId);
  const assigned = bid ? (bid.assigned || []) : [];

  document.getElementById('assign-popup-list').innerHTML = teamMembers.map(m => {
    const checked = assigned.includes(m.id);
    return `
      <div class="assign-member" onclick="toggleAssign('${m.id}')">
        <div class="assign-member-avatar" style="background:${m.bg};color:${m.color};">${m.initials}</div>
        <div class="assign-member-name">${m.name}</div>
        <div class="assign-member-check ${checked ? 'checked' : ''}" id="acheck-${m.id}">${checked ? '‚úì' : ''}</div>
      </div>
    `;
  }).join('');

  // Position popup near click
  const rect = e.currentTarget.getBoundingClientRect();
  popup.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
  popup.style.top = (rect.bottom + 6) + 'px';
  popup.classList.add('open');
}

function toggleAssign(memberId) {
  if (!assignPopupBidId) return;
  const bid = bids.find(b => b.id === assignPopupBidId);
  if (!bid) return;
  if (!bid.assigned) bid.assigned = [];
  if (bid.assigned.includes(memberId)) {
    bid.assigned = bid.assigned.filter(x => x !== memberId);
  } else {
    bid.assigned.push(memberId);
  }
  // Update check UI
  const chk = document.getElementById('acheck-' + memberId);
  if (chk) {
    const isChecked = bid.assigned.includes(memberId);
    chk.className = 'assign-member-check' + (isChecked ? ' checked' : '');
    chk.textContent = isChecked ? '‚úì' : '';
  }
  // Refresh table rows without closing popup
  renderBidsTable();
  renderDashboard();
}

// Close popup on outside click
document.addEventListener('click', (e) => {
  const popup = document.getElementById('assign-popup');
  if (!popup.contains(e.target)) {
    popup.classList.remove('open');
    assignPopupBidId = null;
  }
});

// COLORS for contacts
const avatarColors = ['#3b82f620,#3b82f6','#f5a62320,#f5a623','#2ecc7120,#2ecc71','#e8391d20,#e8391d','#a855f720,#a855f7','#06b6d420,#06b6d4'];
const personAvatarColors = ['#3b82f6','#f5a623','#2ecc71','#a855f7','#06b6d4','#e8391d','#f97316','#ec4899'];

// ============ NAVIGATION ============
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const items = document.querySelectorAll('.nav-item');
  const map = { dashboard: 0, bids: 1, contacts: 2, analytics: 3, roadmap: 4 };
  if (map[page] !== undefined) items[map[page]].classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'bids') renderBidsTable();
  if (page === 'contacts') { renderCompanyList(); if (selectedCompanyId) renderCompanyDetail(selectedCompanyId); }
  if (page === 'analytics') renderAnalytics();
  if (page === 'roadmap') renderRoadmap();
}

// ============ ANALYTICS ============
function renderAnalytics() {
  const container = document.getElementById('analytics-content');

  // Group won/lost bids by year
  const wonBids  = bids.filter(b => b.status === 'won');
  const lostBids = bids.filter(b => b.status === 'lost');

  function getYear(b) {
    if (!b.due) return 'Unknown';
    return b.due.substring(0, 4);
  }

  const years = [...new Set([...wonBids, ...lostBids].map(getYear))].filter(y => y !== 'Unknown').sort().reverse();

  function statsByYear(list, year) {
    const filtered = list.filter(b => getYear(b) === year);
    const count = filtered.length;
    const value = filtered.reduce((s, b) => s + (b.value || 0), 0);
    return { count, value, bids: filtered };
  }

  function fmt(n) {
    if (n >= 1000000) return '$' + (n/1000000).toFixed(2) + 'M';
    if (n >= 1000) return '$' + (n/1000).toFixed(0) + 'K';
    return '$' + n.toLocaleString();
  }

  // All-time totals
  const totalWonVal  = wonBids.reduce((s,b) => s + (b.value||0), 0);
  const totalLostVal = lostBids.reduce((s,b) => s + (b.value||0), 0);
  const totalQuoted  = totalWonVal + totalLostVal;
  const winRate = totalQuoted > 0 ? Math.round(totalWonVal / totalQuoted * 100) : 0;

  // Max bar value for scaling
  const maxYearVal = Math.max(...years.map(y => {
    const w = statsByYear(wonBids, y).value;
    const l = statsByYear(lostBids, y).value;
    return Math.max(w, l);
  }), 1);

  let html = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;">
      <div class="stat-card" style="border-top:3px solid var(--won);">
        <div class="stat-number" style="color:var(--won)">${wonBids.length}</div>
        <div class="stat-label">Total Won</div>
      </div>
      <div class="stat-card" style="border-top:3px solid var(--lost);">
        <div class="stat-number" style="color:var(--lost)">${lostBids.length}</div>
        <div class="stat-label">Total Lost</div>
      </div>
      <div class="stat-card" style="border-top:3px solid var(--accent);">
        <div class="stat-number" style="color:var(--accent)">${fmt(totalWonVal)}</div>
        <div class="stat-label">Revenue Won</div>
      </div>
      <div class="stat-card" style="border-top:3px solid #8b5cf6;">
        <div class="stat-number" style="color:#8b5cf6">${winRate}%</div>
        <div class="stat-label">Win Rate (by value)</div>
      </div>
    </div>

    <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:24px;">
      <div style="font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:20px;">Year-by-Year Breakdown</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;">
  `;

  years.forEach(year => {
    const won  = statsByYear(wonBids,  year);
    const lost = statsByYear(lostBids, year);
    const total = won.value + lost.value;
    const yr_rate = total > 0 ? Math.round(won.value / total * 100) : 0;
    const wonPct  = maxYearVal > 0 ? Math.round(won.value  / maxYearVal * 100) : 0;
    const lostPct = maxYearVal > 0 ? Math.round(lost.value / maxYearVal * 100) : 0;

    html += `
      <div style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;padding:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <div style="font-size:20px;font-weight:800;color:var(--text);">${year}</div>
          <div style="font-size:11px;padding:3px 10px;border-radius:20px;background:${yr_rate>=50?'rgba(46,204,113,0.15)':'rgba(231,76,60,0.15)'};color:${yr_rate>=50?'var(--won)':'var(--lost)'};">${yr_rate}% win rate</div>
        </div>

        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:12px;color:var(--won);">‚úì Won (${won.count} bids)</span>
            <span style="font-size:12px;font-weight:700;color:var(--won);">${fmt(won.value)}</span>
          </div>
          <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
            <div style="height:100%;width:${wonPct}%;background:var(--won);border-radius:4px;transition:width 0.5s;"></div>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:12px;color:var(--lost);">‚úó Lost (${lost.count} bids)</span>
            <span style="font-size:12px;font-weight:700;color:var(--lost);">${fmt(lost.value)}</span>
          </div>
          <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
            <div style="height:100%;width:${lostPct}%;background:var(--lost);border-radius:4px;transition:width 0.5s;"></div>
          </div>
        </div>

        <div style="border-top:1px solid var(--border);padding-top:10px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:11px;color:var(--muted);">Total Quoted</span>
          <span style="font-size:13px;font-weight:700;color:var(--text);">${fmt(total)}</span>
        </div>

        <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;">
          <button onclick="showYearBids('${year}','won')"
            style="font-size:10px;padding:4px 10px;border-radius:4px;border:1px solid var(--won);background:transparent;color:var(--won);cursor:pointer;">View Won</button>
          <button onclick="showYearBids('${year}','lost')"
            style="font-size:10px;padding:4px 10px;border-radius:4px;border:1px solid var(--lost);background:transparent;color:var(--lost);cursor:pointer;">View Lost</button>
        </div>
      </div>
    `;
  });

  html += `</div></div>`;

  // Top companies by won value
  const companyWins = {};
  wonBids.forEach(b => {
    const co = b.company || 'Unknown';
    if (!companyWins[co]) companyWins[co] = { count: 0, value: 0 };
    companyWins[co].count++;
    companyWins[co].value += b.value || 0;
  });
  const topCos = Object.entries(companyWins).sort((a,b) => b[1].value - a[1].value).slice(0, 8);
  const maxCoVal = topCos[0]?.[1].value || 1;

  html += `
    <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:24px;">
      <div style="font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:20px;">Top Clients by Won Revenue</div>
  `;
  topCos.forEach(([co, s]) => {
    const pct = Math.round(s.value / maxCoVal * 100);
    html += `
      <div style="margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;">${co}</span>
          <span style="font-size:12px;color:var(--muted);">${s.count} job${s.count>1?'s':''} ¬∑ <strong style="color:var(--won)">${fmt(s.value)}</strong></span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--won));border-radius:3px;"></div>
        </div>
      </div>
    `;
  });
  html += `</div>`;

  // Year bid table (hidden by default)
  html += `<div id="year-bids-panel" style="display:none;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div id="year-bids-title" style="font-size:14px;font-weight:700;"></div>
      <button onclick="document.getElementById('year-bids-panel').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;">‚úï</button>
    </div>
    <div id="year-bids-list"></div>
  </div>`;

  container.innerHTML = html;
}

function showYearBids(year, status) {
  function getYear(b) { return b.due ? b.due.substring(0,4) : 'Unknown'; }
  const filtered = bids.filter(b => b.status === status && getYear(b) === year);
  const panel = document.getElementById('year-bids-panel');
  const title = document.getElementById('year-bids-title');
  const list  = document.getElementById('year-bids-list');

  const color = status === 'won' ? 'var(--won)' : 'var(--lost)';
  const icon  = status === 'won' ? '‚úì' : '‚úó';
  title.innerHTML = `<span style="color:${color}">${icon} ${status === 'won' ? 'Won' : 'Lost'} Bids ‚Äî ${year}</span>`;

  function fmt(n) {
    if (!n) return '‚Äî';
    if (n >= 1000000) return '$' + (n/1000000).toFixed(2) + 'M';
    if (n >= 1000) return '$' + (n/1000).toFixed(0) + 'K';
    return '$' + n.toLocaleString();
  }

  list.innerHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:8px 6px;color:var(--muted);font-weight:600;">Project</th>
          <th style="text-align:left;padding:8px 6px;color:var(--muted);font-weight:600;">Company</th>
          <th style="text-align:left;padding:8px 6px;color:var(--muted);font-weight:600;">Contact</th>
          <th style="text-align:right;padding:8px 6px;color:var(--muted);font-weight:600;">Value</th>
          <th style="text-align:right;padding:8px 6px;color:var(--muted);font-weight:600;">Due</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(b => `
          <tr style="border-bottom:1px solid rgba(255,255,255,0.04);" onmouseenter="this.style.background='rgba(255,255,255,0.03)'" onmouseleave="this.style.background='transparent'">
            <td style="padding:8px 6px;color:var(--text);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${b.name}</td>
            <td style="padding:8px 6px;color:var(--muted);">${b.company || '‚Äî'}</td>
            <td style="padding:8px 6px;color:var(--muted);">${b.contact || '‚Äî'}</td>
            <td style="padding:8px 6px;text-align:right;color:${color};font-weight:700;">${fmt(b.value)}</td>
            <td style="padding:8px 6px;text-align:right;color:var(--muted);">${b.due || '‚Äî'}</td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot>
        <tr style="border-top:2px solid var(--border);">
          <td colspan="3" style="padding:10px 6px;font-weight:700;color:var(--text);">Total (${filtered.length} bids)</td>
          <td style="padding:10px 6px;text-align:right;font-weight:800;color:${color};">${fmt(filtered.reduce((s,b)=>s+(b.value||0),0))}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  `;

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}


// ============================================================
// PROJECT ROADMAP ‚Äî KANBAN WITH PRE/CONSTRUCTION PHASES
// ============================================================

const roadmapProjects = {
  ogesco: {
    name: 'Ogesco ‚Äì De la Montagne',
    client: 'Ogesco Construction Inc',
    phases: ['Pre-Construction', 'Construction'],
    columns: [
      {
        id: 'billing',
        label: 'Contractual / Billing',
        phase: 'Pre-Construction',
        color: '#6366f1',
        cards: [
          { id: 'c1', title: 'Contract Denunciation ‚Äì Ongoing', tags: ['Contract'], assignees: ['S'], due: '2025-05-30', notes: [
            { date: '2025-05-01', text: 'Contract sent to client for signature.' },
            { date: '2025-04-15', text: 'Draft reviewed by legal team. Minor amendments requested.' }
          ], subtasks: [], timeLog: [] },
          { id: 'c2', title: 'DP8 ‚Äì October 2025', tags: ['Billing'], assignees: ['A'], due: '', notes: [
            { date: '2025-10-01', text: 'Draw package 8 submitted for approval.' }
          ], subtasks: [], timeLog: [] },
          { id: 'c3', title: 'DP10 December 2025 ‚Äì Release', tags: ['Billing'], assignees: ['S', 'A'], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c4', title: 'DP11 January 2026 ‚Äì Release', tags: ['Billing'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
        ]
      },
      {
        id: 'ft',
        label: 'Field Tasks (FT)',
        phase: 'Construction',
        color: '#f5a623',
        cards: [
          { id: 'c5', title: 'FT-PRO-005 ‚Äì √âclairage-R√©glettes 4\'', tags: ['Completed'], assignees: ['I'], due: '', notes: [
            { date: '2025-11-10', text: 'Task marked as completed. Final inspection passed.' },
            { date: '2025-10-28', text: 'Installation of 4\' lighting strips in corridors. Zone B done.' }
          ], subtasks: [{label:'Order material', done:true},{label:'Install fixtures', done:true},{label:'Final inspection', done:true}], timeLog: [{date:'2025-11-08', hours:4, note:'Install'},{date:'2025-11-09', hours:3, note:'Wiring finalize'}] },
          { id: 'c6', title: 'FT-PRO-006 ‚Äì Electrical Panel Upgrade', tags: ['In Progress'], assignees: ['I'], due: '2026-01-15', notes: [
            { date: '2026-01-05', text: 'Panel upgrade started. Shutdown scheduled for 2026-01-12.' }
          ], subtasks: [{label:'Shutdown coordination', done:true},{label:'Panel replacement', done:false},{label:'Testing & commissioning', done:false}], timeLog: [] },
        ]
      },
      {
        id: 'directives',
        label: 'Directives',
        phase: 'Construction',
        color: '#3b82f6',
        cards: [
          { id: 'c7', title: 'DIR-001 ‚Äì Revised HVAC Routing', tags: ['Pending'], assignees: [], due: '', notes: [
            { date: '2025-12-01', text: 'Architect issued revised HVAC routing directive. Under review.' }
          ], subtasks: [], timeLog: [] },
          { id: 'c8', title: 'DIR-002 ‚Äì Fire Stopping Addendum', tags: ['Sent / Waiting'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
        ]
      },
      {
        id: 'extras',
        label: 'Additional Work',
        phase: 'Construction',
        color: '#ec4899',
        cards: [
          { id: 'c9', title: '914 ‚Äì Ogesco Bureau ‚Äì Heating & Temp', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c10', title: '913 ‚Äì Prise Twist Lock S√©nergie', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c11', title: '912 ‚Äì Conduits pour garage de immotek', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c12', title: '911 ‚Äì Temporary Heating', tags: ['Sent / Waiting'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c13', title: '910 ‚Äì Raccordement Fraco', tags: ['Sent / Waiting'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c14', title: '909 ‚Äì Broken Carlon', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c15', title: '908-AV-02 ‚Äì Charging Station Supply', tags: ['Ordered', 'Reply Received'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
        ]
      },
      {
        id: 'longlead',
        label: 'Long Lead Materials',
        phase: 'Pre-Construction',
        color: '#eab308',
        cards: [
          { id: 'c16', title: 'PO-1025 ‚Äì Heating', tags: ['Ordered'], assignees: ['I'], due: '', notes: [
            { date: '2025-11-20', text: 'PO issued to supplier. Expected lead time: 12 weeks.' }
          ], subtasks: [], timeLog: [] },
          { id: 'c17', title: 'PO-1011 Transformers', tags: ['Ordered', 'Completed'], assignees: [], due: '2025-09-30', notes: [
            { date: '2025-09-28', text: 'Transformers delivered on site. All units inspected.' }
          ], subtasks: [], timeLog: [] },
          { id: 'c18', title: 'Main Distribution Lines', tags: ['Ordered'], assignees: [], due: '2025-10-31', notes: [], subtasks: [], timeLog: [] },
          { id: 'c19', title: 'PO-991 ‚Äì Distribution', tags: ['Ordered', 'In Progress'], assignees: ['S'], due: '2026-02-02', notes: [
            { date: '2025-12-30', text: 'IN: Order placed with Schneider for switchboard and busway. Delivery expected mid-March.' },
            { date: '2025-10-16', text: 'Meeting: Patrick, Steven, Ilias, Samuel. Switchboard date: 2025-02-20. No response from Siemens to improve delivery date.\nBusway: Drawings must be out by 2025-10-24. 32‚Äì36 weeks to receive.' },
            { date: '2025-10-01', text: 'IN: First delivery of distribution panels received on site.' },
            { date: '2025-09-09', text: 'IN: Delivery schedule sent to Lumen/Siemens. Croquis sent to Bussduck ‚Äì waiting on clearance height feedback. 2‚Äì3 week delay.' }
          ], subtasks: [{label:'Switchboard order confirmed', done:true},{label:'Busway drawings issued', done:true},{label:'Switchboard delivery', done:false},{label:'Busway delivery', done:false},{label:'Installation', done:false},{label:'Testing', done:false}], timeLog: [] },
          { id: 'c20', title: 'PO-982 ‚Äì Fire Alarm', tags: ['Ordered', 'In Progress'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
        ]
      },
      {
        id: 'qrt',
        label: 'QRT (RFI / Technical)',
        phase: 'Construction',
        color: '#2ecc71',
        cards: [
          { id: 'c21', title: 'QRT-PRO-003 ‚Äì Missing panel service on some floors', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c22', title: 'QRT-PRO-004 ‚Äì Trace conduit in slab', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c23', title: 'QRT-PRO-005 ‚Äì Electrical supply details for fire suppression in basement', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c24', title: 'QRT-PRO-006 ‚Äì Waterproofing installation', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c25', title: 'QRT-PRO-007 ‚Äì Missing heating in vestibule entrances', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
          { id: 'c26', title: 'QRT-PRO-008 ‚Äì Amperage electrical outlet for HotteMicro-onde', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] },
        ]
      },
    ]
  },
  project2: {
    name: 'Project 2 (Demo)',
    client: 'Demo Client',
    phases: ['Pre-Construction', 'Construction'],
    columns: [
      {
        id: 'p2-billing', label: 'Contractual / Billing', phase: 'Pre-Construction', color: '#6366f1',
        cards: [{ id: 'p2c1', title: 'Contract Review', tags: ['Pending'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] }]
      },
      {
        id: 'p2-longlead', label: 'Long Lead Materials', phase: 'Pre-Construction', color: '#eab308',
        cards: [{ id: 'p2c2', title: 'Main Switchboard Order', tags: ['Ordered'], assignees: [], due: '2026-03-01', notes: [], subtasks: [], timeLog: [] }]
      },
      {
        id: 'p2-ft', label: 'Field Tasks (FT)', phase: 'Construction', color: '#f5a623',
        cards: [{ id: 'p2c3', title: 'FT-001 Rough-in Electrical', tags: ['In Progress'], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] }]
      },
      {
        id: 'p2-qrt', label: 'QRT (RFI / Technical)', phase: 'Construction', color: '#2ecc71',
        cards: [{ id: 'p2c4', title: 'QRT-001 Load Calculation Clarification', tags: [], assignees: [], due: '', notes: [], subtasks: [], timeLog: [] }]
      }
    ]
  }
};

let activeCardId = null;
let activeProjectId = null;

const TAG_COLORS = {
  'Ordered':           { bg: '#1e3a2a', color: '#2ecc71', border: '#2ecc71' },
  'Completed':         { bg: '#1a2e1a', color: '#4ade80', border: '#4ade80' },
  'In Progress':       { bg: '#1e2a3a', color: '#60a5fa', border: '#3b82f6' },
  'Sent / Waiting':    { bg: '#3a2a1a', color: '#fb923c', border: '#f5a623' },
  'Reply Received':    { bg: '#1a2e2a', color: '#34d399', border: '#34d399' },
  'Pending':           { bg: '#2a2a1a', color: '#facc15', border: '#eab308' },
  'Contract':          { bg: '#2a1a3a', color: '#c084fc', border: '#a855f7' },
  'Billing':           { bg: '#2a1a2e', color: '#e879f9', border: '#d946ef' },
  'Cancelled':         { bg: '#2a1a1a', color: '#f87171', border: '#ef4444' },
};

function tagStyle(tag) {
  const t = TAG_COLORS[tag] || { bg: '#2a2a2a', color: '#aaa', border: '#444' };
  return `background:${t.bg};color:${t.color};border:1px solid ${t.border};`;
}

function avatarColor(initials) {
  const colors = ['#f5a623','#3b82f6','#2ecc71','#e8391d','#a855f7','#ec4899','#06b6d4'];
  let h = 0; for (let c of initials) h += c.charCodeAt(0);
  return colors[h % colors.length];
}

let currentRoadmapView = 'kanban';

function onRoadmapProjectChange() {
  // Reset col filter to all when switching project
  const sel = document.getElementById('roadmap-col-filter');
  if (sel) sel.value = 'all';
  if (currentRoadmapView !== 'kanban') populateColFilter();
  renderRoadmap();
}

function setRoadmapView(view) {
  currentRoadmapView = view;

  // Update view button active states
  ['kanban','list','calendar'].forEach(v => {
    const btn = document.getElementById('view-btn-' + v);
    if (!btn) return;
    if (v === view) {
      btn.style.background = 'var(--accent)';
      btn.style.color = '#000';
      btn.style.fontWeight = '700';
    } else {
      btn.style.background = 'transparent';
      btn.style.color = 'var(--muted)';
      btn.style.fontWeight = '600';
    }
  });

  // Category filter: show for list + calendar, hide for kanban
  const colFilter = document.getElementById('roadmap-col-filter');
  if (colFilter) {
    colFilter.style.display = (view !== 'kanban') ? 'block' : 'none';
    if (view !== 'kanban') populateColFilter();
  }

  // Print button: list view only
  const printBtn = document.getElementById('roadmap-print-btn');
  if (printBtn) printBtn.style.display = (view === 'list') ? 'inline-flex' : 'none';

  renderRoadmap();
}

function populateColFilter() {
  const projKey = document.getElementById('roadmap-project-select')?.value || 'ogesco';
  const proj = roadmapProjects[projKey];
  const sel  = document.getElementById('roadmap-col-filter');
  if (!sel || !proj) return;
  const current = sel.value;
  sel.innerHTML = '<option value="all">All Categories</option>' +
    proj.columns.map(c => `<option value="${c.id}" ${c.id === current ? 'selected' : ''}>${c.label}</option>`).join('');
}

function renderRoadmap() {
  const projKey = document.getElementById('roadmap-project-select')?.value || 'ogesco';
  activeProjectId = projKey;
  const proj = roadmapProjects[projKey];
  const container = document.getElementById('roadmap-content');
  if (!proj || !container) return;

  if (currentRoadmapView === 'kanban')        renderKanbanView(projKey, proj, container);
  else if (currentRoadmapView === 'list')      renderListView(projKey, proj, container);
  else if (currentRoadmapView === 'calendar')  renderCalendarView(projKey, proj, container);
}

// ================== KANBAN VIEW ==================
function renderKanbanView(projKey, proj, container) {
  const phases = proj.phases;
  let html = `<div style="padding:16px 28px 48px;">`;

  phases.forEach(phase => {
    const cols = proj.columns.filter(c => c.phase === phase);
    if (!cols.length) return;
    const phaseColor = phase === 'Pre-Construction' ? '#f5a623' : '#3b82f6';
    const phaseIcon  = phase === 'Pre-Construction' ? 'üìê' : 'üèóÔ∏è';

    html += `
      <div style="margin-bottom:32px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:10px 0;border-bottom:2px solid ${phaseColor}30;">
          <span style="font-size:18px;">${phaseIcon}</span>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:${phaseColor};">${phase}</div>
          <div style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-left:4px;">${cols.reduce((s,c)=>s+c.cards.length,0)} cards across ${cols.length} columns</div>
        </div>
        <div class="roadmap-phase-cols">
    `;

    cols.forEach(col => {
      const totalCards = col.cards.length;
      html += `
        <div class="roadmap-col" data-col="${col.id}" style="min-width:280px;width:280px;flex-shrink:0;border-radius:10px;background:var(--surface);border:1px solid var(--border);overflow:hidden;"
          ondragover="roadmapDragOver(event,'${col.id}','${projKey}')" ondrop="roadmapDrop(event,'${col.id}','${projKey}')">
          <div style="padding:12px 14px;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="width:10px;height:10px;border-radius:50%;background:${col.color};flex-shrink:0;"></div>
              <div style="font-size:12px;font-weight:700;color:var(--text);letter-spacing:0.3px;">${col.label}</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:10px;background:rgba(255,255,255,0.08);color:var(--muted);border-radius:10px;padding:2px 8px;">${totalCards}</span>
              <button onclick="openNewCardInCol('${projKey}','${col.id}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1;padding:0 2px;" title="Add card">+</button>
            </div>
          </div>
          <div style="padding:8px;min-height:60px;" id="col-cards-${col.id}">
      `;

      col.cards.forEach(card => {
        const doneSubs  = card.subtasks.filter(s => s.done).length;
        const totalSubs = card.subtasks.length;
        const totalHours = card.timeLog.reduce((s,t) => s+(t.hours||0), 0);
        const overdue   = card.due && new Date(card.due) < new Date() && !card.tags.includes('Completed');

        html += `
          <div class="roadmap-card" id="kcard-${card.id}" draggable="true"
            ondragstart="roadmapDragStart(event,'${card.id}','${col.id}','${projKey}')"
            onclick="openCardDetail('${projKey}','${col.id}','${card.id}')"
            style="background:var(--surface2);border:1px solid var(--border);border-left:3px solid ${col.color};border-radius:7px;padding:11px 12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;">
            <div style="font-size:12px;font-weight:600;color:var(--text);line-height:1.4;margin-bottom:8px;">${card.title}</div>
            ${card.tags.length ? `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">${card.tags.map(t=>`<span style="${tagStyle(t)}font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600;">${t}</span>`).join('')}</div>` : ''}
            <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;">
              <div style="display:flex;align-items:center;gap:6px;">
                ${card.assignees.length ? `<div style="display:flex;">${card.assignees.map(a=>`<div style="width:20px;height:20px;border-radius:50%;background:${avatarColor(a)};color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-right:-4px;border:1px solid var(--surface2);">${a}</div>`).join('')}</div>` : ''}
                ${totalSubs ? `<span style="font-size:10px;color:var(--muted);">‚úì ${doneSubs}/${totalSubs}</span>` : ''}
                ${totalHours ? `<span style="font-size:10px;color:var(--muted);">‚è± ${totalHours}h</span>` : ''}
                ${card.notes.length ? `<span style="font-size:10px;color:var(--muted);">üí¨ ${card.notes.length}</span>` : ''}
              </div>
              ${card.due ? `<span style="font-size:10px;color:${overdue?'var(--lost)':'var(--muted)'};">${overdue?'‚ö† ':''}${card.due}</span>` : ''}
            </div>
          </div>
        `;
      });

      html += `</div></div>`;
    });

    html += `</div></div>`;
  });

  html += `</div>`;
  container.innerHTML = html;
}

// ================== LIST VIEW ==================
function renderListView(projKey, proj, container) {
  const colFilter = document.getElementById('roadmap-col-filter')?.value || 'all';
  const cols = colFilter === 'all' ? proj.columns : proj.columns.filter(c => c.id === colFilter);
  const allCards = [];
  cols.forEach(col => col.cards.forEach(card => allCards.push({ col, card })));

  const totalHoursAll   = allCards.reduce((s,{card}) => s + card.timeLog.reduce((a,t)=>a+(t.hours||0),0), 0);
  const completedCount  = allCards.filter(({card}) => card.tags.includes('Completed')).length;
  const overdueCount    = allCards.filter(({card}) => card.due && new Date(card.due+'T00:00:00') < new Date() && !card.tags.includes('Completed')).length;

  let rowsHtml = '';
  allCards.forEach(({col, card}, idx) => {
    const doneSubs    = card.subtasks.filter(s=>s.done).length;
    const totalSubs   = card.subtasks.length;
    const totalHours  = card.timeLog.reduce((s,t)=>s+(t.hours||0),0);
    const overdue     = card.due && new Date(card.due+'T00:00:00') < new Date() && !card.tags.includes('Completed');
    const isCompleted = card.tags.includes('Completed');
    const subPct      = totalSubs > 0 ? Math.round(doneSubs/totalSubs*100) : 0;
    const barColor    = subPct === 100 ? 'var(--won)' : 'var(--accent)';

    rowsHtml += `
      <tr class="${isCompleted ? 'row-done' : ''}">
        <td style="color:var(--muted);font-size:11px;width:36px;">${idx+1}</td>
        <td style="max-width:240px;">
          <div style="font-size:12px;font-weight:600;color:var(--text);line-height:1.4;${isCompleted?'text-decoration:line-through;opacity:0.55;':''}">${card.title}</div>
          ${card.notes.length ? `<div style="font-size:10px;color:var(--muted);margin-top:2px;">üí¨ ${card.notes.length} entr${card.notes.length===1?'y':'ies'} ¬∑ ${card.notes[0]?.date||''}</div>` : ''}
        </td>
        <td style="white-space:nowrap;">
          <div style="display:flex;align-items:center;gap:5px;">
            <div style="width:8px;height:8px;border-radius:50%;background:${col.color};flex-shrink:0;"></div>
            <span style="font-size:11px;color:var(--text);">${col.label}</span>
          </div>
        </td>
        <td>
          <span style="font-size:10px;padding:2px 8px;border-radius:10px;white-space:nowrap;${col.phase==='Pre-Construction'?'background:rgba(245,166,35,0.15);color:#f5a623;':'background:rgba(59,130,246,0.15);color:#3b82f6;'}">${col.phase}</span>
        </td>
        <td style="max-width:160px;">
          ${card.tags.length
            ? `<div style="display:flex;flex-wrap:wrap;gap:3px;">${card.tags.map(t=>`<span style="${tagStyle(t)}font-size:10px;padding:1px 6px;border-radius:8px;font-weight:600;white-space:nowrap;">${t}</span>`).join('')}</div>`
            : '<span style="color:var(--muted);">‚Äî</span>'}
        </td>
        <td>
          ${card.assignees.length
            ? `<div style="display:flex;">${card.assignees.map(a=>`<div style="width:22px;height:22px;border-radius:50%;background:${avatarColor(a)};color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-right:-4px;border:1px solid var(--surface);" title="${a}">${a}</div>`).join('')}</div>`
            : '<span style="color:var(--muted);">‚Äî</span>'}
        </td>
        <td style="min-width:90px;">
          ${totalSubs
            ? `<div style="font-size:10px;color:var(--muted);margin-bottom:3px;">${doneSubs}/${totalSubs}</div>
               <div style="height:4px;background:rgba(255,255,255,0.08);border-radius:2px;width:70px;"><div style="height:100%;width:${subPct}%;background:${barColor};border-radius:2px;"></div></div>`
            : '<span style="color:var(--muted);">‚Äî</span>'}
        </td>
        <td>${totalHours ? `<span style="color:#60a5fa;font-weight:600;">${totalHours}h</span>` : '<span style="color:var(--muted);">‚Äî</span>'}</td>
        <td style="white-space:nowrap;">
          ${card.due
            ? `<span style="color:${overdue?'var(--lost)':'var(--muted)'};font-weight:${overdue?'700':'400'};">${overdue?'‚ö† ':''}${card.due}</span>`
            : '<span style="color:var(--muted);">‚Äî</span>'}
        </td>
        <td style="width:36px;">
          <button onclick="openCardDetail('${projKey}','${col.id}','${card.id}')"
            style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:2px;transition:color 0.1s;"
            onmouseenter="this.style.color='var(--text)'" onmouseleave="this.style.color='var(--muted)'"
            title="Open card">‚Üó</button>
        </td>
      </tr>`;
  });

  container.innerHTML = `
    <div id="list-view-root">
      <div class="list-stats-bar">
        <div class="list-stat-card"><div class="list-stat-label">Total Items</div><div class="list-stat-value" style="color:var(--text);">${allCards.length}</div></div>
        <div class="list-stat-card"><div class="list-stat-label">Completed</div><div class="list-stat-value" style="color:var(--won);">${completedCount}</div></div>
        <div class="list-stat-card"><div class="list-stat-label">Open</div><div class="list-stat-value" style="color:var(--accent);">${allCards.length - completedCount}</div></div>
        <div class="list-stat-card"><div class="list-stat-label">Overdue</div><div class="list-stat-value" style="color:var(--lost);">${overdueCount}</div></div>
        <div class="list-stat-card"><div class="list-stat-label">Hours Logged</div><div class="list-stat-value" style="color:#60a5fa;">${totalHoursAll}h</div></div>
        <div class="list-stat-card" style="min-width:180px;flex:1;">
          <div class="list-stat-label">Project</div>
          <div style="font-size:13px;font-weight:700;color:var(--text);margin-top:2px;">${proj.name}</div>
          <div style="font-size:11px;color:var(--muted);">${proj.client}</div>
        </div>
      </div>

      <div class="list-table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Item / Title</th>
              <th>Category</th>
              <th>Phase</th>
              <th>Status / Tags</th>
              <th>Assigned</th>
              <th>Subtasks</th>
              <th>Time</th>
              <th>Due Date</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </div>

      <div style="margin-top:10px;font-size:11px;color:var(--muted);text-align:right;">
        ${proj.name} ¬∑ ${proj.client} &nbsp;‚Äî&nbsp; ${new Date().toLocaleDateString('en-CA',{year:'numeric',month:'long',day:'numeric'})}
      </div>
    </div>`;
}

// ================== CALENDAR VIEW ==================
function renderCalendarView(projKey, proj, container) {
  const colFilter = document.getElementById('roadmap-col-filter')?.value || 'all';
  let cols = colFilter === 'all' ? proj.columns : proj.columns.filter(c => c.id === colFilter);

  // Collect all cards with due dates
  const cardsWithDates = [];
  cols.forEach(col => col.cards.forEach(card => {
    if (card.due) cardsWithDates.push({ col, card, date: new Date(card.due + 'T00:00:00') });
  }));

  // Determine range: current month ¬± 1
  const now = new Date();
  const calKey = 'cal-' + projKey;
  if (!window._calYear) window._calYear = now.getFullYear();
  if (!window._calMonth) window._calMonth = now.getMonth();

  const year  = window._calYear;
  const month = window._calMonth;
  const firstDay = new Date(year, month, 1);
  const lastDay  = new Date(year, month + 1, 0);
  const startDow = firstDay.getDay(); // 0=Sun
  const daysInMonth = lastDay.getDate();

  const monthName = firstDay.toLocaleDateString('en-CA', { month: 'long', year: 'numeric' });

  // Group by date string YYYY-MM-DD
  const byDate = {};
  cardsWithDates.forEach(({col, card, date}) => {
    const key = date.toISOString().split('T')[0];
    if (!byDate[key]) byDate[key] = [];
    byDate[key].push({ col, card });
  });

  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  let html = `
    <div style="padding:16px 24px 40px;">
      <!-- Nav -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <button onclick="calNav(-1,'${projKey}')" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:6px 14px;cursor:pointer;font-size:13px;">‚Üê Prev</button>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:var(--text);">${monthName.toUpperCase()}</div>
        <button onclick="calNav(1,'${projKey}')" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:6px 14px;cursor:pointer;font-size:13px;">Next ‚Üí</button>
      </div>
      <!-- Legend -->
      <div style="display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;">
        ${cols.map(c=>`<div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);"><div style="width:8px;height:8px;border-radius:50%;background:${c.color};"></div>${c.label}</div>`).join('')}
      </div>
      <!-- Grid -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
        <!-- Day headers -->
        <div style="display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--border);">
          ${dayNames.map(d=>`<div style="padding:8px 10px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;text-align:center;">${d}</div>`).join('')}
        </div>
        <!-- Days grid -->
        <div style="display:grid;grid-template-columns:repeat(7,1fr);">
  `;

  // Fill leading empty cells
  for (let i = 0; i < startDow; i++) {
    html += `<div style="min-height:90px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:rgba(0,0,0,0.15);"></div>`;
  }

  const todayStr = now.toISOString().split('T')[0];

  for (let d = 1; d <= daysInMonth; d++) {
    const col = (startDow + d - 1) % 7;
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = dateStr === todayStr;
    const dayCards = byDate[dateStr] || [];
    const borderRight = col < 6 ? '1px solid var(--border)' : 'none';

    html += `
      <div style="min-height:90px;border-right:${borderRight};border-bottom:1px solid var(--border);padding:6px 7px;vertical-align:top;${isToday?'background:rgba(245,166,35,0.05);':''}">
        <div style="font-size:12px;font-weight:${isToday?'800':'500'};color:${isToday?'var(--accent)':'var(--muted)'};margin-bottom:4px;${isToday?'background:var(--accent);color:#000;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;':''}">${d}</div>
        ${dayCards.map(({col:c, card})=>`
          <div onclick="openCardDetail('${projKey}','${c.id}','${card.id}')"
            style="font-size:10px;padding:2px 6px;border-radius:4px;margin-bottom:2px;cursor:pointer;background:${c.color}25;border-left:2px solid ${c.color};color:var(--text);line-height:1.4;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;" title="${card.title}">
            ${card.title}
          </div>`).join('')}
      </div>
    `;
  }

  // Trailing cells
  const trailingCells = 7 - ((startDow + daysInMonth) % 7);
  if (trailingCells < 7) {
    for (let i = 0; i < trailingCells; i++) {
      html += `<div style="min-height:90px;border-right:${i<trailingCells-1?'1px solid var(--border)':'none'};border-bottom:1px solid var(--border);background:rgba(0,0,0,0.15);"></div>`;
    }
  }

  html += `</div></div>

    <!-- Cards with due dates summary -->
    <div style="margin-top:20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;">
      <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Deadlines This Month</div>
      ${cardsWithDates.filter(({date}) => date.getFullYear()===year && date.getMonth()===month).length ?
        cardsWithDates.filter(({date}) => date.getFullYear()===year && date.getMonth()===month)
          .sort((a,b)=>a.date-b.date)
          .map(({col:c, card, date}) => {
            const overdue = date < now && !card.tags.includes('Completed');
            return `<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04);" onclick="openCardDetail('${projKey}','${c.id}','${card.id}')" style="cursor:pointer;">
              <div style="width:8px;height:8px;border-radius:50%;background:${c.color};flex-shrink:0;"></div>
              <span style="font-size:12px;color:var(--text);flex:1;">${card.title}</span>
              <span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.05);color:var(--muted);">${c.label}</span>
              <span style="font-size:11px;font-weight:600;color:${overdue?'var(--lost)':'var(--muted)'};white-space:nowrap;">${overdue?'‚ö† ':''}${card.due}</span>
            </div>`;
          }).join('') :
        '<div style="font-size:12px;color:var(--muted);font-style:italic;">No deadlines set for this month.</div>'
      }
    </div>
  </div>`;

  container.innerHTML = html;
}

function calNav(dir, projKey) {
  window._calMonth = (window._calMonth || new Date().getMonth()) + dir;
  if (window._calMonth > 11) { window._calMonth = 0; window._calYear = (window._calYear||new Date().getFullYear()) + 1; }
  if (window._calMonth < 0)  { window._calMonth = 11; window._calYear = (window._calYear||new Date().getFullYear()) - 1; }
  renderRoadmap();
}

// ================== PRINT LIST VIEW ==================
function printRoadmapList() {
  const projKey = document.getElementById('roadmap-project-select')?.value || 'ogesco';
  const proj = roadmapProjects[projKey];
  const colFilter = document.getElementById('roadmap-col-filter')?.value || 'all';
  let cols = colFilter === 'all' ? proj.columns : proj.columns.filter(c => c.id === colFilter);

  const allCards = [];
  cols.forEach(col => col.cards.forEach(card => allCards.push({ col, card })));
  const now = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' });

  const printWin = window.open('', '_blank');
  printWin.document.write(`<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>${proj.name} ‚Äì Project List</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Arial', sans-serif; color: #111; background: #fff; font-size: 11px; }
    .header { padding: 24px 28px 16px; border-bottom: 3px solid #f5a623; display:flex; justify-content:space-between; align-items:flex-start; }
    .project-name { font-size: 22px; font-weight: 800; color: #111; letter-spacing: 1px; }
    .project-sub  { font-size: 11px; color: #666; margin-top: 3px; }
    .report-meta  { font-size: 10px; color: #999; text-align: right; }
    .summary { display:flex; gap: 16px; padding: 12px 28px; background: #f9f9f9; border-bottom: 1px solid #eee; }
    .sum-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px 14px; min-width: 100px; }
    .sum-label { font-size: 9px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
    .sum-val   { font-size: 18px; font-weight: 800; }
    table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    th { padding: 8px 10px; text-align: left; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: #777; background: #f5f5f5; border-bottom: 2px solid #ddd; font-weight: 700; }
    td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    tr:nth-child(even) td { background: #fafafa; }
    .tag { display: inline-block; font-size: 9px; padding: 1px 6px; border-radius: 8px; font-weight: 700; margin: 1px; }
    .cat-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; }
    .phase-pill { display:inline-block; font-size:9px; padding:2px 7px; border-radius:8px; font-weight:600; }
    .progress-bar-bg { height: 4px; background: #eee; border-radius: 2px; width: 60px; display:inline-block; vertical-align:middle; }
    .progress-bar-fg { height: 4px; border-radius: 2px; background: #f5a623; }
    .footer { padding: 12px 28px; border-top: 1px solid #eee; font-size: 9px; color: #aaa; display:flex; justify-content:space-between; }
    .section-header { padding: 8px 28px; background: #fff3dc; border-top: 1px solid #f5a623; border-bottom: 1px solid #f5a623; font-size: 11px; font-weight: 800; color: #c47d00; text-transform: uppercase; letter-spacing: 2px; margin-top: 12px; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .no-print { display: none; }
    }
  </style>
  </head><body>`);

  const totalHours   = allCards.reduce((s,{card}) => s + card.timeLog.reduce((a,t)=>a+(t.hours||0),0), 0);
  const completedCnt = allCards.filter(({card}) => card.tags.includes('Completed')).length;
  const overdueCards = allCards.filter(({card}) => card.due && new Date(card.due+'T00:00:00') < new Date() && !card.tags.includes('Completed'));

  printWin.document.write(`
  <div class="header">
    <div>
      <div class="project-name">${proj.name}</div>
      <div class="project-sub">${proj.client} &nbsp;¬∑&nbsp; ${colFilter === 'all' ? 'All Categories' : cols[0]?.label}</div>
    </div>
    <div class="report-meta">
      Project Status Report<br>${now}<br>
      <strong>Confidential</strong>
    </div>
  </div>
  <div class="summary">
    <div class="sum-card"><div class="sum-label">Total Items</div><div class="sum-val">${allCards.length}</div></div>
    <div class="sum-card"><div class="sum-label">Completed</div><div class="sum-val" style="color:#16a34a;">${completedCnt}</div></div>
    <div class="sum-card"><div class="sum-label">Open</div><div class="sum-val" style="color:#f5a623;">${allCards.length - completedCnt}</div></div>
    <div class="sum-card"><div class="sum-label">Overdue</div><div class="sum-val" style="color:#dc2626;">${overdueCards.length}</div></div>
    <div class="sum-card"><div class="sum-label">Hours Logged</div><div class="sum-val" style="color:#2563eb;">${totalHours}h</div></div>
  </div>
  `);

  // Group by phase for printing
  const phases = [...new Set(cols.map(c => c.phase))];
  phases.forEach(phase => {
    const phaseCols = cols.filter(c => c.phase === phase);
    const phaseCards = [];
    phaseCols.forEach(col => col.cards.forEach(card => phaseCards.push({ col, card })));
    if (!phaseCards.length) return;
    printWin.document.write(`<div class="section-header">${phase}</div>`);
    printWin.document.write(`<table style="margin:0;"><thead><tr>
      <th style="width:28px;">#</th>
      <th>Item / Title</th>
      <th style="width:130px;">Category</th>
      <th style="width:100px;">Status</th>
      <th style="width:60px;">Assigned</th>
      <th style="width:80px;">Subtasks</th>
      <th style="width:50px;">Time</th>
      <th style="width:85px;">Due Date</th>
      <th>Latest Log</th>
    </tr></thead><tbody>`);

    phaseCards.forEach(({col, card}, idx) => {
      const doneSubs   = card.subtasks.filter(s=>s.done).length;
      const totalSubs  = card.subtasks.length;
      const totalHrs   = card.timeLog.reduce((s,t)=>s+(t.hours||0),0);
      const overdue    = card.due && new Date(card.due+'T00:00:00') < new Date() && !card.tags.includes('Completed');
      const isCompleted = card.tags.includes('Completed');
      const subPct     = totalSubs > 0 ? Math.round(doneSubs/totalSubs*100) : 0;
      const latestNote = card.notes[0];

      const tagColorMap = { 'Ordered':'#16a34a','Completed':'#16a34a','In Progress':'#2563eb','Sent / Waiting':'#ea580c','Pending':'#ca8a04','Cancelled':'#dc2626','Contract':'#7c3aed','Billing':'#db2777' };

      printWin.document.write(`<tr style="${isCompleted?'opacity:0.65;':''}">
        <td style="color:#999;">${idx+1}</td>
        <td style="${isCompleted?'text-decoration:line-through;color:#999;':'font-weight:600;'}">${card.title}</td>
        <td>
          <span class="cat-dot" style="background:${col.color};"></span>${col.label}
        </td>
        <td>
          ${card.tags.map(t => {
            const tc = tagColorMap[t] || '#888';
            return `<span class="tag" style="background:${tc}18;color:${tc};border:1px solid ${tc}55;">${t}</span>`;
          }).join(' ')}
        </td>
        <td>${card.assignees.join(', ') || '‚Äî'}</td>
        <td>
          ${totalSubs ? `${doneSubs}/${totalSubs}<br><div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${subPct}%;${subPct===100?'background:#16a34a;':''}"></div></div>` : '‚Äî'}
        </td>
        <td>${totalHrs ? totalHrs + 'h' : '‚Äî'}</td>
        <td style="color:${overdue?'#dc2626':'#555'};font-weight:${overdue?'700':'400'};">${overdue?'‚ö† ':''}${card.due || '‚Äî'}</td>
        <td style="color:#666;font-size:10px;max-width:160px;">
          ${latestNote ? `<strong style="color:#999;">${latestNote.date}</strong><br>${latestNote.text.slice(0,120)}${latestNote.text.length>120?'‚Ä¶':''}` : '‚Äî'}
        </td>
      </tr>`);
    });

    printWin.document.write('</tbody></table>');
  });

  printWin.document.write(`
  <div class="footer">
    <span>${proj.name} ‚Äî ${proj.client}</span>
    <span>Printed ${now} &nbsp;¬∑&nbsp; CONFIDENTIAL ‚Äî For internal use only</span>
  </div>
  </body></html>`);
  printWin.document.close();
  setTimeout(() => printWin.print(), 500);
}

// ---- DRAG AND DROP ----
let _dragCardId = null, _dragFromCol = null, _dragFromProj = null;

function roadmapDragStart(e, cardId, colId, projKey) {
  _dragCardId = cardId; _dragFromCol = colId; _dragFromProj = projKey;
  e.dataTransfer.effectAllowed = 'move';
}
function roadmapDragOver(e, colId, projKey) {
  e.preventDefault(); e.dataTransfer.dropEffect = 'move';
}
function roadmapDrop(e, toColId, projKey) {
  e.preventDefault();
  if (!_dragCardId || projKey !== _dragFromProj) return;
  const proj = roadmapProjects[projKey];
  const fromCol = proj.columns.find(c => c.id === _dragFromCol);
  const toCol   = proj.columns.find(c => c.id === toColId);
  if (!fromCol || !toCol || fromCol.id === toCol.id) return;
  const idx = fromCol.cards.findIndex(c => c.id === _dragCardId);
  if (idx === -1) return;
  const [card] = fromCol.cards.splice(idx, 1);
  toCol.cards.push(card);
  _dragCardId = null; _dragFromCol = null;
  renderRoadmap();
  showToast('Card moved to ' + toCol.label);
}

// ---- CARD DETAIL MODAL ----
function openCardDetail(projKey, colId, cardId) {
  const proj = roadmapProjects[projKey];
  const col  = proj.columns.find(c => c.id === colId);
  const card = col?.cards.find(c => c.id === cardId);
  if (!card) return;
  activeCardId = { projKey, colId, cardId };

  const allTags = Object.keys(TAG_COLORS);
  const doneSubs = card.subtasks.filter(s=>s.done).length;

  const modal = document.createElement('div');
  modal.id = 'card-detail-overlay';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto;';
  modal.onclick = e => { if (e.target === modal) closeCardDetail(); };

  modal.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:680px;overflow:hidden;animation:fadeIn 0.2s;">
      <!-- Header -->
      <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:20px 24px 14px;border-bottom:1px solid var(--border);background:var(--surface2);">
        <div style="flex:1;min-width:0;">
          <div style="font-size:10px;color:${col.color};letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">${col.label}</div>
          <div id="card-title-el" contenteditable="true" spellcheck="false" style="font-size:16px;font-weight:700;color:var(--text);line-height:1.4;outline:none;border-bottom:1px dashed transparent;cursor:text;" onblur="saveCardTitle(this.innerText)" onfocus="this.style.borderBottomColor='var(--accent)'" onblur2="this.style.borderBottomColor='transparent'">${card.title}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">${proj.name} ¬∑ ${proj.client}</div>
        </div>
        <button onclick="closeCardDetail()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0 0 0 12px;flex-shrink:0;">‚úï</button>
      </div>

      <!-- Tabs -->
      <div style="display:flex;background:var(--surface);border-bottom:1px solid var(--border);">
        ${['Description','Subtasks','Time','Tags'].map((t,i)=>`
          <div class="cd-tab" data-tab="${t.toLowerCase()}" onclick="switchCardTab('${t.toLowerCase()}')"
            style="padding:10px 18px;font-size:12px;font-weight:600;cursor:pointer;letter-spacing:0.4px;${i===0?'border-bottom:2px solid var(--accent);color:var(--accent);':'border-bottom:2px solid transparent;color:var(--muted);'}">${t}</div>
        `).join('')}
      </div>

      <!-- Meta row -->
      <div style="display:flex;flex-wrap:wrap;gap:16px;padding:14px 24px;background:rgba(255,255,255,0.01);border-bottom:1px solid var(--border);font-size:12px;">
        <div>
          <div style="color:var(--muted);margin-bottom:3px;font-size:10px;text-transform:uppercase;letter-spacing:1px;">Assigned</div>
          <div style="display:flex;gap:4px;align-items:center;">
            ${card.assignees.map(a=>`<div style="width:24px;height:24px;border-radius:50%;background:${avatarColor(a)};color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;">${a}</div>`).join('')}
            <button onclick="promptAddAssignee()" style="width:24px;height:24px;border-radius:50%;background:var(--surface2);border:1px dashed var(--border);color:var(--muted);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;">+</button>
          </div>
        </div>
        <div>
          <div style="color:var(--muted);margin-bottom:3px;font-size:10px;text-transform:uppercase;letter-spacing:1px;">Due Date</div>
          <input type="date" value="${card.due||''}" onchange="saveCardDue(this.value)"
            style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:4px 8px;font-size:12px;font-family:inherit;">
        </div>
        <div>
          <div style="color:var(--muted);margin-bottom:3px;font-size:10px;text-transform:uppercase;letter-spacing:1px;">Status</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;" id="card-tags-mini">
            ${card.tags.map(t=>`<span style="${tagStyle(t)}font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;">${t}</span>`).join('')}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);margin-bottom:3px;font-size:10px;text-transform:uppercase;letter-spacing:1px;">Subtasks</div>
          <span style="font-size:12px;color:var(--text);">${doneSubs} / ${card.subtasks.length} done</span>
        </div>
      </div>

      <!-- Tab Panels -->
      <div style="padding:20px 24px;min-height:280px;">

        <!-- DESCRIPTION / NOTES -->
        <div id="cd-panel-description">
          <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Activity Log</div>
          <div id="notes-list" style="margin-bottom:16px;">
            ${card.notes.length ? card.notes.map((n,i)=>`
              <div style="display:flex;gap:10px;margin-bottom:12px;padding:10px 12px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--accent);">
                <div style="flex:1;min-width:0;">
                  <div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:4px;">${n.date}</div>
                  <div style="font-size:12px;color:var(--text);line-height:1.6;white-space:pre-wrap;">${n.text}</div>
                </div>
                <button onclick="deleteNote(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;flex-shrink:0;padding:0;">√ó</button>
              </div>`).join('') : `<div style="font-size:12px;color:var(--muted);font-style:italic;">No log entries yet. Add one below.</div>`}
          </div>
          <div style="border-top:1px solid var(--border);padding-top:14px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Add Log Entry</div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input type="date" id="new-note-date" value="${new Date().toISOString().split('T')[0]}"
                style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:6px 8px;font-size:12px;font-family:inherit;flex-shrink:0;">
            </div>
            <textarea id="new-note-text" placeholder="Describe the update, action taken, or next steps..." rows="3"
              style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;font-size:12px;font-family:inherit;resize:vertical;"></textarea>
            <button onclick="addCardNote()" style="margin-top:8px;background:var(--accent);color:#000;border:none;border-radius:5px;padding:7px 16px;font-size:12px;font-weight:700;cursor:pointer;">+ Add Entry</button>
          </div>
        </div>

        <!-- SUBTASKS -->
        <div id="cd-panel-subtasks" style="display:none;">
          <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Subtasks</div>
          <div id="subtasks-list" style="margin-bottom:14px;">
            ${card.subtasks.length ? card.subtasks.map((s,i)=>`
              <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;background:var(--surface2);margin-bottom:6px;">
                <input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtask(${i},this.checked)"
                  style="width:15px;height:15px;cursor:pointer;accent-color:var(--accent);">
                <span style="font-size:12px;color:${s.done?'var(--muted)':'var(--text)'};${s.done?'text-decoration:line-through;':''};flex:1;">${s.label}</span>
                <button onclick="deleteSubtask(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;">√ó</button>
              </div>`).join('') : `<div style="font-size:12px;color:var(--muted);font-style:italic;">No subtasks yet.</div>`}
          </div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="new-subtask-input" placeholder="Add a subtask..." onkeydown="if(event.key==='Enter')addSubtask()"
              style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:7px 10px;font-size:12px;font-family:inherit;">
            <button onclick="addSubtask()" style="background:var(--accent);color:#000;border:none;border-radius:5px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;">Add</button>
          </div>
        </div>

        <!-- TIME LOG -->
        <div id="cd-panel-time" style="display:none;">
          <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Time Log</div>
          <div id="time-list" style="margin-bottom:14px;">
            ${card.timeLog.length ? `
              <table style="width:100%;border-collapse:collapse;font-size:12px;">
                <thead><tr style="border-bottom:1px solid var(--border);">
                  <th style="text-align:left;padding:6px 8px;color:var(--muted);">Date</th>
                  <th style="text-align:left;padding:6px 8px;color:var(--muted);">Hours</th>
                  <th style="text-align:left;padding:6px 8px;color:var(--muted);">Note</th>
                  <th></th>
                </tr></thead>
                <tbody>
                  ${card.timeLog.map((t,i)=>`
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
                      <td style="padding:7px 8px;color:var(--text);">${t.date}</td>
                      <td style="padding:7px 8px;color:var(--accent);font-weight:700;">${t.hours}h</td>
                      <td style="padding:7px 8px;color:var(--muted);">${t.note||'‚Äî'}</td>
                      <td style="padding:7px 8px;"><button onclick="deleteTimeEntry(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;">√ó</button></td>
                    </tr>`).join('')}
                  <tr style="border-top:2px solid var(--border);">
                    <td style="padding:7px 8px;font-weight:700;color:var(--text);">Total</td>
                    <td style="padding:7px 8px;font-weight:800;color:var(--accent);">${card.timeLog.reduce((s,t)=>s+(t.hours||0),0)}h</td>
                    <td colspan="2"></td>
                  </tr>
                </tbody>
              </table>` : `<div style="font-size:12px;color:var(--muted);font-style:italic;">No time logged yet.</div>`}
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
            <div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;">Date</div>
              <input type="date" id="new-time-date" value="${new Date().toISOString().split('T')[0]}"
                style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:6px 8px;font-size:12px;font-family:inherit;">
            </div>
            <div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;">Hours</div>
              <input type="number" id="new-time-hours" placeholder="0" min="0" step="0.5"
                style="width:80px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:6px 8px;font-size:12px;font-family:inherit;">
            </div>
            <div style="flex:1;min-width:120px;">
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;">Note</div>
              <input type="text" id="new-time-note" placeholder="Description..."
                style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:6px 8px;font-size:12px;font-family:inherit;">
            </div>
            <button onclick="addTimeEntry()" style="background:var(--accent);color:#000;border:none;border-radius:5px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;">Log Time</button>
          </div>
        </div>

        <!-- TAGS -->
        <div id="cd-panel-tags" style="display:none;">
          <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Tags</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
            ${allTags.map(t => {
              const active = card.tags.includes(t);
              return `<button onclick="toggleCardTag('${t}')" id="tag-btn-${t.replace(/[^a-zA-Z0-9]/g,'_')}"
                style="${tagStyle(t)}font-size:11px;padding:5px 12px;border-radius:12px;font-weight:600;cursor:pointer;${active?'opacity:1;':'opacity:0.4;'}transition:opacity 0.15s;">${active?'‚úì ':''}${t}</button>`;
            }).join('')}
          </div>
          <div style="border-top:1px solid var(--border);padding-top:14px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Custom Tag</div>
            <div style="display:flex;gap:8px;">
              <input type="text" id="custom-tag-input" placeholder="e.g. Priority" onkeydown="if(event.key==='Enter')addCustomTag()"
                style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:7px 10px;font-size:12px;font-family:inherit;">
              <button onclick="addCustomTag()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:5px;padding:7px 14px;font-size:12px;cursor:pointer;">Add</button>
            </div>
          </div>
          <div style="border-top:1px solid var(--border);padding-top:14px;margin-top:14px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Delete Card</div>
            <button onclick="deleteCard()" style="background:rgba(232,57,29,0.1);border:1px solid var(--danger);color:var(--danger);border-radius:5px;padding:7px 14px;font-size:12px;cursor:pointer;">üóë Delete this card</button>
          </div>
        </div>

      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function closeCardDetail() {
  const el = document.getElementById('card-detail-overlay');
  if (el) el.remove();
  activeCardId = null;
  renderRoadmap();
}

function switchCardTab(tab) {
  ['description','subtasks','time','tags'].forEach(t => {
    const panel = document.getElementById('cd-panel-' + t);
    if (panel) panel.style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.cd-tab').forEach(el => {
    const isActive = el.dataset.tab === tab;
    el.style.borderBottomColor = isActive ? 'var(--accent)' : 'transparent';
    el.style.color = isActive ? 'var(--accent)' : 'var(--muted)';
  });
}

function getActiveCard() {
  if (!activeCardId) return null;
  const { projKey, colId, cardId } = activeCardId;
  const proj = roadmapProjects[projKey];
  const col  = proj?.columns.find(c => c.id === colId);
  return col?.cards.find(c => c.id === cardId) || null;
}

function saveCardTitle(text) {
  const card = getActiveCard();
  if (card) card.title = text.trim();
}

function saveCardDue(val) {
  const card = getActiveCard();
  if (card) { card.due = val; renderDueDate(); }
}

function renderDueDate() {}

function addCardNote() {
  const card = getActiveCard();
  const date = document.getElementById('new-note-date')?.value;
  const text = document.getElementById('new-note-text')?.value.trim();
  if (!card || !text) return;
  card.notes.unshift({ date, text });
  document.getElementById('new-note-text').value = '';
  const list = document.getElementById('notes-list');
  if (list) {
    list.innerHTML = card.notes.map((n,i) => `
      <div style="display:flex;gap:10px;margin-bottom:12px;padding:10px 12px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--accent);">
        <div style="flex:1;min-width:0;">
          <div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:4px;">${n.date}</div>
          <div style="font-size:12px;color:var(--text);line-height:1.6;white-space:pre-wrap;">${n.text}</div>
        </div>
        <button onclick="deleteNote(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;flex-shrink:0;padding:0;">√ó</button>
      </div>`).join('');
  }
  showToast('Log entry added');
}

function deleteNote(i) {
  const card = getActiveCard();
  if (!card) return;
  card.notes.splice(i, 1);
  closeCardDetail();
  openCardDetail(activeCardId?.projKey, activeCardId?.colId, activeCardId?.cardId);
}

function addSubtask() {
  const card = getActiveCard();
  const input = document.getElementById('new-subtask-input');
  if (!card || !input?.value.trim()) return;
  card.subtasks.push({ label: input.value.trim(), done: false });
  input.value = '';
  refreshSubtaskList();
  showToast('Subtask added');
}

function toggleSubtask(i, done) {
  const card = getActiveCard();
  if (card && card.subtasks[i] !== undefined) card.subtasks[i].done = done;
}

function deleteSubtask(i) {
  const card = getActiveCard();
  if (card) { card.subtasks.splice(i, 1); refreshSubtaskList(); }
}

function refreshSubtaskList() {
  const card = getActiveCard();
  const list = document.getElementById('subtasks-list');
  if (!card || !list) return;
  list.innerHTML = card.subtasks.length ? card.subtasks.map((s,i)=>`
    <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;background:var(--surface2);margin-bottom:6px;">
      <input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtask(${i},this.checked)"
        style="width:15px;height:15px;cursor:pointer;accent-color:var(--accent);">
      <span style="font-size:12px;color:${s.done?'var(--muted)':'var(--text)'};${s.done?'text-decoration:line-through;':''};flex:1;">${s.label}</span>
      <button onclick="deleteSubtask(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;">√ó</button>
    </div>`).join('') : '<div style="font-size:12px;color:var(--muted);font-style:italic;">No subtasks yet.</div>';
}

function addTimeEntry() {
  const card = getActiveCard();
  const date  = document.getElementById('new-time-date')?.value;
  const hours = parseFloat(document.getElementById('new-time-hours')?.value || 0);
  const note  = document.getElementById('new-time-note')?.value.trim();
  if (!card || !hours) return;
  card.timeLog.push({ date, hours, note });
  document.getElementById('new-time-hours').value = '';
  document.getElementById('new-time-note').value = '';
  refreshTimeList();
  showToast(`${hours}h logged`);
}

function deleteTimeEntry(i) {
  const card = getActiveCard();
  if (card) { card.timeLog.splice(i, 1); refreshTimeList(); }
}

function refreshTimeList() {
  const card = getActiveCard();
  const list = document.getElementById('time-list');
  if (!card || !list) return;
  const total = card.timeLog.reduce((s,t)=>s+(t.hours||0),0);
  list.innerHTML = card.timeLog.length ? `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead><tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left;padding:6px 8px;color:var(--muted);">Date</th>
        <th style="text-align:left;padding:6px 8px;color:var(--muted);">Hours</th>
        <th style="text-align:left;padding:6px 8px;color:var(--muted);">Note</th><th></th>
      </tr></thead>
      <tbody>
        ${card.timeLog.map((t,i)=>`
          <tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
            <td style="padding:7px 8px;color:var(--text);">${t.date}</td>
            <td style="padding:7px 8px;color:var(--accent);font-weight:700;">${t.hours}h</td>
            <td style="padding:7px 8px;color:var(--muted);">${t.note||'‚Äî'}</td>
            <td style="padding:7px 8px;"><button onclick="deleteTimeEntry(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;">√ó</button></td>
          </tr>`).join('')}
        <tr style="border-top:2px solid var(--border);">
          <td style="padding:7px 8px;font-weight:700;color:var(--text);">Total</td>
          <td style="padding:7px 8px;font-weight:800;color:var(--accent);">${total}h</td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>` : '<div style="font-size:12px;color:var(--muted);font-style:italic;">No time logged yet.</div>';
}

function toggleCardTag(tag) {
  const card = getActiveCard();
  if (!card) return;
  const idx = card.tags.indexOf(tag);
  if (idx === -1) card.tags.push(tag);
  else card.tags.splice(idx, 1);
  // Refresh tag buttons
  const safeId = tag.replace(/[^a-zA-Z0-9]/g,'_');
  const btn = document.getElementById('tag-btn-' + safeId);
  if (btn) {
    const active = card.tags.includes(tag);
    btn.style.opacity = active ? '1' : '0.4';
    btn.textContent = (active ? '‚úì ' : '') + tag;
  }
  // Refresh mini tags
  const mini = document.getElementById('card-tags-mini');
  if (mini) mini.innerHTML = card.tags.map(t=>`<span style="${tagStyle(t)}font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;">${t}</span>`).join('');
}

function addCustomTag() {
  const input = document.getElementById('custom-tag-input');
  const tag = input?.value.trim();
  if (!tag) return;
  toggleCardTag(tag);
  if (input) input.value = '';
}

function deleteCard() {
  if (!activeCardId) return;
  const { projKey, colId, cardId } = activeCardId;
  const col = roadmapProjects[projKey]?.columns.find(c => c.id === colId);
  if (!col) return;
  const idx = col.cards.findIndex(c => c.id === cardId);
  if (idx !== -1) col.cards.splice(idx, 1);
  closeCardDetail();
  showToast('Card deleted');
}

function promptAddAssignee() {
  const card = getActiveCard();
  const initials = prompt('Enter initials to assign (e.g. FV, S, A):');
  if (!initials?.trim()) return;
  card.assignees.push(initials.trim().toUpperCase());
  showToast('Assignee added');
}

// ---- NEW CARD ----
let _newCardCol = null, _newCardProj = null;

function openNewRoadmapCard() {
  const projKey = document.getElementById('roadmap-project-select')?.value || 'ogesco';
  const proj = roadmapProjects[projKey];
  const colId = proj.columns[0]?.id;
  openNewCardInCol(projKey, colId);
}

function openNewCardInCol(projKey, colId) {
  _newCardCol = colId; _newCardProj = projKey;
  const overlay = document.createElement('div');
  overlay.id = 'new-card-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;';
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };
  const proj = roadmapProjects[projKey];
  overlay.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;width:100%;max-width:440px;padding:24px;animation:fadeIn 0.2s;">
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:16px;">New Card</div>
      <div style="margin-bottom:12px;">
        <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Column</label>
        <select id="nc-col" style="width:100%;margin-top:4px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px 10px;font-size:12px;font-family:inherit;">
          ${proj.columns.map(c=>`<option value="${c.id}" ${c.id===colId?'selected':''}>${c.label} (${c.phase})</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Card Title *</label>
        <input type="text" id="nc-title" placeholder="e.g. QRT-009 ‚Äì Ceiling clearance issue"
          style="width:100%;margin-top:4px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px 10px;font-size:12px;font-family:inherit;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Due Date</label>
        <input type="date" id="nc-due"
          style="width:100%;margin-top:4px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px 10px;font-size:12px;font-family:inherit;">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button onclick="document.getElementById('new-card-overlay').remove()" style="background:none;border:1px solid var(--border);border-radius:5px;color:var(--muted);padding:7px 16px;font-size:12px;cursor:pointer;">Cancel</button>
        <button onclick="saveNewCard()" style="background:var(--accent);color:#000;border:none;border-radius:5px;padding:7px 16px;font-size:12px;font-weight:700;cursor:pointer;">Create Card</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(() => document.getElementById('nc-title')?.focus(), 100);
}

function saveNewCard() {
  const projKey = _newCardProj || document.getElementById('roadmap-project-select')?.value || 'ogesco';
  const colId = document.getElementById('nc-col')?.value;
  const title = document.getElementById('nc-title')?.value.trim();
  const due   = document.getElementById('nc-due')?.value;
  if (!title) { alert('Please enter a card title.'); return; }
  const proj = roadmapProjects[projKey];
  const col  = proj?.columns.find(c => c.id === colId);
  if (!col) return;
  const newId = 'card-' + Date.now();
  col.cards.push({ id: newId, title, tags: [], assignees: [], due: due||'', notes: [], subtasks: [], timeLog: [] });
  document.getElementById('new-card-overlay')?.remove();
  renderRoadmap();
  showToast('Card created: ' + title);
}


// ============ PROPOSAL MODAL ============
function openProposalModal(bidId) {
  const b = bids.find(x => x.id === bidId);

  // Try to pull rich contact data from companies list
  const linkedCo = b?.contactCompanyId ? companies.find(c => c.id === b.contactCompanyId) : companies.find(c => c.name === b?.company);
  const linkedPerson = linkedCo && b?.contactPersonId
    ? linkedCo.persons.find(p => p.id === b.contactPersonId)
    : linkedCo?.persons.find(p => `${p.first} ${p.last}` === b?.contact);

  // Pre-fill from bid + linked contact data
  document.getElementById('p-project').value = b ? b.name : '';
  document.getElementById('p-client-company').value = linkedCo?.name || b?.company || '';
  document.getElementById('p-client-company-email').value = linkedCo?.email || '';
  document.getElementById('p-client-company-phone').value = linkedCo?.phone || '';
  document.getElementById('p-client-company-address').value = linkedCo?.address || '';
  document.getElementById('p-client').value = linkedPerson ? `${linkedPerson.first} ${linkedPerson.last}` : (b?.contact || '');
  document.getElementById('p-client-email').value = linkedPerson?.email || '';
  document.getElementById('p-client-phone').value = linkedPerson?.phone || '';
  document.getElementById('p-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('p-scope').value = b?.notes || '';
  document.getElementById('p-addendum').value = '0';
  document.getElementById('p-drawings-date').value = '';
  document.getElementById('p-quote-valid').value = '';
  document.getElementById('p-material-until').value = '';
  document.getElementById('p-footer-note').value = myCompany.email ? `Bid request to be sent at ${myCompany.email}` : '';
  document.getElementById('p-terms').value = '';
  document.getElementById('p-quote-num').value = '';
  document.getElementById('p-quote-label').value = '';

  // Seed a default category from bid value if available
  catNextId = 1;
  catLiNextId = 100;
  proposalCategories = [
    {
      id: catNextId++,
      name: b ? b.name : 'Base House',
      taxLabel: '+ GST',
      items: b && b.value ? [{ id: catLiNextId++, desc: b.name || 'Base scope', qty: 1, price: b.value }] : []
    }
  ];

  // Modal title
  document.getElementById('proposal-modal-title').textContent = 'Proposal Builder';
  document.getElementById('proposal-modal-sub').textContent = b ? `For: ${b.name}` : '';

  // Show banner
  const banner = document.getElementById('proposal-bid-banner');
  const bannerText = document.getElementById('proposal-bid-banner-text');
  if (b) {
    banner.style.display = 'flex';
    bannerText.textContent = `Pre-filled from bid ¬∑ ${b.contact}${b.company ? ' ¬∑ ' + b.company : ''}`;
  } else {
    banner.style.display = 'none';
  }

  renderCategoriesUI();
  updatePreview();

  // Reset page 2 from company defaults
  document.getElementById('p2-inclusions').value = myCompany.inclusions;
  document.getElementById('p2-exclusions').value = myCompany.exclusions;
  document.getElementById('p2-hourly').value = myCompany.hourlyRates;
  document.getElementById('p2-terms').value = myCompany.termsAndConditions;

  // Always open on page 1
  switchProposalPage(1);
  document.getElementById('proposal-modal').classList.add('open');
}

function closeProposalModal() {
  document.getElementById('proposal-modal').classList.remove('open');
  // Close saved quotes panel too
  const panel = document.getElementById('saved-quotes-panel');
  if (panel) panel.style.display = 'none';
}

// Ctrl+S saves quote while modal is open
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    const modal = document.getElementById('proposal-modal');
    if (modal && modal.classList.contains('open')) {
      e.preventDefault();
      saveCurrentQuote();
    }
  }
});

// ============ STATS ============
function getStats() {
  const est = bids.filter(b => b.status === 'estimating');
  const pend = bids.filter(b => b.status === 'pending');
  const won = bids.filter(b => b.status === 'won');
  const lost = bids.filter(b => b.status === 'lost');
  return { est, pend, won, lost };
}

function fmt(n) {
  if (!n) return '$0';
  if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return '$' + (n / 1000).toFixed(0) + 'K';
  return '$' + n.toLocaleString();
}

function fmtFull(n) {
  return '$' + (n || 0).toLocaleString();
}

// ============ PROPOSAL BUILDER ‚Äî Category + Line Items ============
let catNextId = 1;
let catLiNextId = 100;

// Each category: { id, name, taxLabel, items: [{id, desc, qty, price}] }
let proposalCategories = [];

function initCategoriesUI() {
  proposalCategories = [
    { id: catNextId++, name: 'Base House', taxLabel: '+ GST', items: [] }
  ];
  renderCategoriesUI();
}

function addCategory() {
  proposalCategories.push({ id: catNextId++, name: '', taxLabel: '+ GST', items: [] });
  renderCategoriesUI();
  updatePreview();
}

function removeCategory(catId) {
  proposalCategories = proposalCategories.filter(c => c.id !== catId);
  renderCategoriesUI();
  updatePreview();
}

function toggleCategory(catId) {
  const el = document.getElementById('cat-block-' + catId);
  if (el) el.classList.toggle('collapsed');
}

function updateCatField(catId, field, value) {
  const cat = proposalCategories.find(c => c.id === catId);
  if (cat) { cat[field] = value; updateCatTotal(catId); updatePreview(); }
}

function addCatLineItem(catId) {
  const cat = proposalCategories.find(c => c.id === catId);
  if (cat) {
    cat.items.push({ id: catLiNextId++, desc: '', qty: 1, price: 0 });
    renderCategoryItems(catId);
    updatePreview();
  }
}

function updateCatLI(catId, liId, field, val) {
  const cat = proposalCategories.find(c => c.id === catId);
  const li  = cat?.items.find(x => x.id === liId);
  if (li) { li[field] = val; updateCatTotal(catId); updatePreview(); }
}

function removeCatLI(catId, liId) {
  const cat = proposalCategories.find(c => c.id === catId);
  if (cat) {
    cat.items = cat.items.filter(x => x.id !== liId);
    renderCategoryItems(catId);
    updatePreview();
  }
}

function updateCatTotal(catId) {
  const cat = proposalCategories.find(c => c.id === catId);
  if (!cat) return;
  const total = cat.items.reduce((a, li) => a + (li.qty * li.price), 0);
  const el = document.getElementById('cat-total-' + catId);
  if (el) el.textContent = total ? fmtFull(total) : '';
}

function renderCategoryItems(catId) {
  const cat = proposalCategories.find(c => c.id === catId);
  if (!cat) return;
  const el = document.getElementById('cat-items-' + catId);
  if (!el) return;
  if (!cat.items.length) {
    el.innerHTML = `<div style="font-size:12px;color:var(--muted);padding:6px 0;">No line items yet.</div>`;
    return;
  }
  el.innerHTML = cat.items.map(li => `
    <div class="p-cat-line-item">
      <input type="text" value="${li.desc.replace(/"/g,'&quot;')}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;" placeholder="Item description"
        oninput="updateCatLI(${catId},${li.id},'desc',this.value)">
      <input type="number" value="${li.qty}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;text-align:center;color:var(--muted);" placeholder="Qty"
        oninput="updateCatLI(${catId},${li.id},'qty',parseFloat(this.value)||1)">
      <input type="number" value="${li.price}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;text-align:right;color:var(--accent);font-family:'DM Mono',monospace;" placeholder="Unit $"
        oninput="updateCatLI(${catId},${li.id},'price',parseFloat(this.value)||0)">
      <span class="p-cat-li-del" onclick="removeCatLI(${catId},${li.id})">‚úï</span>
    </div>
  `).join('');
}

function renderCategoriesUI() {
  const el = document.getElementById('categories-list');
  if (!el) return;
  if (!proposalCategories.length) {
    el.innerHTML = `<div style="font-size:13px;color:var(--muted);padding:12px 0;text-align:center;">No categories yet. Click "+ Add Category" to start.</div>`;
    return;
  }
  el.innerHTML = proposalCategories.map(cat => {
    const total = cat.items.reduce((a, li) => a + (li.qty * li.price), 0);
    return `
      <div class="p-category" id="cat-block-${cat.id}">
        <div class="p-category-header" onclick="toggleCategory(${cat.id})">
          <span class="p-category-chevron">‚ñº</span>
          <input class="p-category-name-input" type="text" value="${cat.name.replace(/"/g,'&quot;')}" placeholder="Category name (e.g. Base House)"
            onclick="event.stopPropagation()"
            oninput="updateCatField(${cat.id},'name',this.value)">
          <span class="p-category-total" id="cat-total-${cat.id}">${total ? fmtFull(total) : ''}</span>
          <button class="btn btn-sm" style="background:transparent;border:1px solid var(--border);color:var(--muted);font-size:11px;padding:3px 8px;flex-shrink:0;"
            onclick="event.stopPropagation();removeCategory(${cat.id})">‚úï</button>
        </div>
        <div class="p-category-body">
          <div class="p-category-meta">
            <div class="form-group">
              <label class="form-label">Tax Label</label>
              <input type="text" class="form-input" value="${cat.taxLabel.replace(/"/g,'&quot;')}" placeholder="e.g. + GST"
                oninput="updateCatField(${cat.id},'taxLabel',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label" style="opacity:0;">spacer</label>
              <button class="btn btn-ghost btn-sm" style="width:100%;" onclick="addCatLineItem(${cat.id})">+ Add Line Item</button>
            </div>
          </div>
          <div class="p-cat-line-items" id="cat-items-${cat.id}">
            ${cat.items.length === 0
              ? '<div style="font-size:12px;color:var(--muted);padding:4px 0;">No line items yet.</div>'
              : cat.items.map(li => `
                <div class="p-cat-line-item">
                  <input type="text" value="${li.desc.replace(/"/g,'&quot;')}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;" placeholder="Item description"
                    onchange="updateCatLI(${cat.id},${li.id},'desc',this.value)">
                  <input type="number" value="${li.qty}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;text-align:center;color:var(--muted);" placeholder="Qty"
                    onchange="updateCatLI(${cat.id},${li.id},'qty',parseFloat(this.value)||1)">
                  <input type="number" value="${li.price}" class="form-input" style="background:transparent;border:none;padding:0;font-size:12px;text-align:right;color:var(--accent);font-family:'DM Mono',monospace;" placeholder="Unit $"
                    onchange="updateCatLI(${cat.id},${li.id},'price',parseFloat(this.value)||0)">
                  <span class="p-cat-li-del" onclick="removeCatLI(${cat.id},${li.id})">‚úï</span>
                </div>`).join('')
            }
          </div>
        </div>
      </div>
    `;
  }).join('');
}


// ============ DASHBOARD ============
function renderDashboard() {
  const s = getStats();
  const wonVal = s.won.reduce((a, b) => a + (b.value || 0), 0);
  const pendVal = s.pend.reduce((a, b) => a + (b.value || 0), 0);

  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card est">
      <div class="stat-label">Estimating</div>
      <div class="stat-value">${s.est.length}</div>
      <div class="stat-sub">Active bids</div>
    </div>
    <div class="stat-card pend">
      <div class="stat-label">Pending Approval</div>
      <div class="stat-value">${s.pend.length}</div>
      <div class="stat-sub">${fmt(pendVal)} in pipeline</div>
    </div>
    <div class="stat-card won">
      <div class="stat-label">Won</div>
      <div class="stat-value">${s.won.length}</div>
      <div class="stat-sub">${fmt(wonVal)} secured</div>
    </div>
    <div class="stat-card lost">
      <div class="stat-label">Lost</div>
      <div class="stat-value">${s.lost.length}</div>
      <div class="stat-sub">Unsuccessful bids</div>
    </div>
  `;

  const estBids = bids.filter(b => b.status === 'estimating').sort((a, b) => {
    if (a.due && b.due) return a.due.localeCompare(b.due);
    if (a.due) return -1;
    if (b.due) return 1;
    return b.id - a.id;
  });
  document.getElementById('dashboard-table').innerHTML = buildTable(estBids);
}

// ============ BIDS TABLE ============
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.filter-btn.f-' + (f === 'pending' ? 'pending' : f)).classList.add('active');
  renderBidsTable();
}

function renderBidsTable() {
  const query = (document.getElementById('search-input')?.value || '').toLowerCase();
  let filtered = bids;
  if (currentFilter !== 'all') filtered = filtered.filter(b => b.status === currentFilter);
  if (query) filtered = filtered.filter(b =>
    b.name.toLowerCase().includes(query) ||
    b.contact.toLowerCase().includes(query) ||
    b.company.toLowerCase().includes(query)
  );
  document.getElementById('bids-table').innerHTML = buildTable(filtered);
}

function statusLabel(s) {
  const map = { estimating: 'Estimating', pending: 'Pending Approval', won: 'Won', lost: 'Lost' };
  return map[s] || s;
}

function quickStatusChange(bidId, selectEl) {
  const bid = bids.find(b => b.id === bidId);
  if (!bid) return;
  bid.status = selectEl.value;
  selectEl.className = 'status-select sel-' + selectEl.value;
  const colorMap = { estimating: 'var(--estimating)', pending: 'var(--pending)', won: 'var(--won)', lost: 'var(--lost)' };
  const dot = selectEl.parentElement.querySelector('.status-dot');
  if (dot) dot.style.background = colorMap[selectEl.value];
  renderDashboard();
  showToast('Status updated to ' + statusLabel(bid.status));
}

function buildTable(rows) {
  if (!rows.length) return `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-text">No bids found</div></div>`;
  return `
    <table>
      <thead>
        <tr>
          <th>Project</th>
          <th>Status</th>
          <th>Value</th>
          <th>Team</th>
          <th>Contact</th>
          <th>Company</th>
          <th>Due Date</th>
          <th>Files</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(b => {
          const assigned = (b.assigned || []).map(id => teamMembers.find(m => m.id === id)).filter(Boolean);
          const avatarHtml = assigned.map(m =>
            `<div class="row-avatar" style="background:${m.bg};color:${m.color};" title="${m.name}">${m.initials}</div>`
          ).join('');
          return `
          <tr>
            <td>
              <div class="project-name">${b.name}</div>
            </td>
            <td>
              <div class="status-dropdown-wrap">
                <select class="status-select sel-${b.status}" onchange="quickStatusChange(${b.id}, this)">
                  <option value="estimating" ${b.status==='estimating'?'selected':''}>Estimating</option>
                  <option value="pending"    ${b.status==='pending'   ?'selected':''}>Pending Approval</option>
                  <option value="won"        ${b.status==='won'       ?'selected':''}>Won</option>
                  <option value="lost"       ${b.status==='lost'      ?'selected':''}>Lost</option>
                </select>
                <span class="status-chevron">‚ñº</span>
                <span class="status-dot" style="background:${b.status==='estimating'?'var(--estimating)':b.status==='pending'?'var(--pending)':b.status==='won'?'var(--won)':'var(--lost)'};"></span>
              </div>
            </td>
            <td>
              <div class="row-team">
                ${avatarHtml}
                <div class="row-avatar-add" onclick="openAssignPopup(event, ${b.id})" title="Assign team members">Ôºã</div>
              </div>
            </td>
            <td class="contact-cell">${b.contact || '‚Äî'}</td>
            <td class="company-cell">${b.company || '‚Äî'}</td>
            <td class="date-cell">${b.due ? new Date(b.due + 'T00:00:00').toLocaleDateString('en-CA', {month:'short',day:'numeric',year:'numeric'}) : '‚Äî'}</td>
            <td>
              <span class="file-count ${b.files && b.files.length ? 'has-files' : ''}">
                ${b.files && b.files.length ? 'üìé ' + b.files.length : '‚Äî'}
              </span>
            </td>
            <td>
              <div class="row-actions">
                <div class="action-btn" onclick="viewBid(${b.id})" title="View">üëÅ</div>
                <div class="action-btn" onclick="editBid(${b.id})" title="Edit">‚úèÔ∏è</div>
                <div class="action-btn" onclick="openProposalModal(${b.id})" title="Create Proposal" style="color:var(--accent);">üìÑ</div>
                <div class="action-btn del" onclick="deleteBid(${b.id})" title="Delete">üóë</div>
              </div>
            </td>
          </tr>
        `}).join('')}
      </tbody>
    </table>
  `;
}

// ============ VIEW BID ============
function viewBid(id) {
  const b = bids.find(x => x.id === id);
  if (!b) return;
  const assigned = (b.assigned || []).map(mid => teamMembers.find(m => m.id === mid)).filter(Boolean);
  document.getElementById('view-modal-title').textContent = b.name;
  document.getElementById('view-modal-body').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <div class="form-label" style="margin-bottom:4px;">Status</div>
        <span class="status-badge badge-${b.status}">${statusLabel(b.status)}</span>
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Value</div>
        <div style="font-family:'DM Mono',monospace;font-size:18px;color:var(--accent);">${b.value ? fmtFull(b.value) : '‚Äî'}</div>
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Assigned Team</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:2px;">
          ${assigned.length ? assigned.map(m => `
            <div style="display:flex;align-items:center;gap:6px;background:${m.bg};border-radius:20px;padding:4px 10px 4px 4px;">
              <div style="width:22px;height:22px;border-radius:50%;background:${m.color}22;color:${m.color};font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;">${m.initials}</div>
              <span style="font-size:12px;font-weight:500;color:${m.color};">${m.name}</span>
            </div>
          `).join('') : '<span style="color:var(--muted);font-size:13px;">Unassigned</span>'}
        </div>
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Contact</div>
        ${(() => {
          // Try to find linked person
          const co = companies.find(c => c.id == b.contactCompanyId);
          const p = co?.persons.find(x => x.id == b.contactPersonId);
          if (p) {
            const idx = co.persons.indexOf(p);
            const color = personAvatarColors[idx % personAvatarColors.length];
            const initials = (p.first[0] + (p.last ? p.last[0] : '')).toUpperCase();
            return `<div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
              <div style="width:32px;height:32px;border-radius:50%;background:${color}20;color:${color};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${initials}</div>
              <div>
                <div style="font-size:13px;font-weight:600;">${p.first} ${p.last}</div>
                <div style="font-size:11px;color:var(--muted);">${p.role || 'Other'}</div>
                ${p.email ? `<div style="font-size:12px;color:var(--blue);">‚úâ ${p.email}</div>` : ''}
                ${p.phone ? `<div style="font-size:12px;color:var(--muted);">üìû ${p.phone}</div>` : ''}
              </div>
            </div>`;
          }
          return `<div>${b.contact || '‚Äî'}</div>`;
        })()}
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Company</div>
        ${(() => {
          const co = companies.find(c => c.id == b.contactCompanyId);
          if (co) {
            const idx = companies.indexOf(co);
            const col = companyColor(idx);
            const initials = getCompanyInitials(co.name);
            return `<div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
              <div style="width:28px;height:28px;border-radius:5px;background:${col.bg};color:${col.color};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;">${initials}</div>
              <div>
                <div style="font-size:13px;font-weight:600;">${co.name}</div>
                ${co.phone ? `<div style="font-size:12px;color:var(--muted);">üìû ${co.phone}</div>` : ''}
              </div>
            </div>`;
          }
          return `<div>${b.company || '‚Äî'}</div>`;
        })()}
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Due Date</div>
        <div style="font-family:'DM Mono',monospace;">${b.due || '‚Äî'}</div>
      </div>
      <div>
        <div class="form-label" style="margin-bottom:4px;">Est. Construction Date</div>
        <div style="font-family:'DM Mono',monospace;">${b.construction || '‚Äî'}</div>
      </div>
      ${b.notes ? `
      <div style="grid-column:1/-1">
        <div class="form-label" style="margin-bottom:4px;">Notes</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6;">${b.notes}</div>
      </div>` : ''}
      ${b.files && b.files.length ? `
      <div style="grid-column:1/-1">
        <div class="form-label" style="margin-bottom:8px;">Attachments (${b.files.length})</div>
        <div class="file-list">
          ${b.files.map(f => `<div class="file-item"><div class="file-item-name">üìé ${f.name}</div><span style="color:var(--muted);font-size:11px;">${(f.size/1024).toFixed(1)} KB</span></div>`).join('')}
        </div>
      </div>` : ''}
    </div>
  `;
  document.getElementById('view-edit-btn').onclick = () => {
    document.getElementById('view-modal').classList.remove('open');
    editBid(id);
  };
  document.getElementById('view-modal').classList.add('open');
}

// ============ BID MODAL ‚Äî Contact Dropdown Helpers ============

function populateBidCompanyDropdown(selectedCompanyName = '') {
  const sel = document.getElementById('bid-company-select');
  sel.innerHTML = '<option value="">‚Äî Select a company ‚Äî</option>';
  companies.forEach(co => {
    const opt = document.createElement('option');
    opt.value = co.id;
    opt.textContent = co.name;
    if (co.name === selectedCompanyName) opt.selected = true;
    sel.appendChild(opt);
  });
  // Trigger contact list update
  populateBidContactDropdown(sel.value);
}

function populateBidContactDropdown(companyId, selectedContactName = '') {
  const co = companies.find(c => c.id == companyId);
  const sel = document.getElementById('bid-contact-select');
  sel.innerHTML = '<option value="">‚Äî Select a contact ‚Äî</option>';
  if (co && co.persons.length) {
    co.persons.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.first} ${p.last} ¬∑ ${p.role || 'Other'}`;
      if (`${p.first} ${p.last}` === selectedContactName) opt.selected = true;
      sel.appendChild(opt);
    });
  }
  // Auto-show preview if a contact is selected
  updateBidContactPreview(companyId, sel.value);
}

function onBidCompanyChange() {
  const companyId = document.getElementById('bid-company-select').value;
  // Update hidden field
  const co = companies.find(c => c.id == companyId);
  document.getElementById('bid-company').value = co ? co.name : '';
  document.getElementById('bid-contact').value = '';
  populateBidContactDropdown(companyId);
}

function onBidContactChange() {
  const companyId = document.getElementById('bid-company-select').value;
  const personId = document.getElementById('bid-contact-select').value;
  const co = companies.find(c => c.id == companyId);
  const p = co?.persons.find(x => x.id == personId);
  document.getElementById('bid-contact').value = p ? `${p.first} ${p.last}` : '';
  updateBidContactPreview(companyId, personId);
}

function updateBidContactPreview(companyId, personId) {
  const preview = document.getElementById('bid-contact-preview');
  const co = companies.find(c => c.id == companyId);
  const p = co?.persons.find(x => x.id == personId);
  if (!p) { preview.style.display = 'none'; return; }

  const idx = co.persons.indexOf(p);
  const color = personAvatarColors[idx % personAvatarColors.length];
  const initials = (p.first[0] + (p.last ? p.last[0] : '')).toUpperCase();

  document.getElementById('bid-contact-avatar').style.background = color + '20';
  document.getElementById('bid-contact-avatar').style.color = color;
  document.getElementById('bid-contact-avatar').textContent = initials;
  document.getElementById('bid-contact-name-display').textContent = `${p.first} ${p.last}`;
  document.getElementById('bid-contact-role-display').textContent = (p.role || 'Other') + (co ? '  ¬∑  ' + co.name : '');
  document.getElementById('bid-contact-email-display').textContent = p.email ? '‚úâ ' + p.email : '';
  document.getElementById('bid-contact-phone-display').textContent = p.phone ? 'üìû ' + p.phone : '';
  preview.style.display = 'block';
}

// ============ BID MODAL ============
function openNewBidModal() {
  editingBidId = null;
  pendingFiles = [];
  modalAssigned = [];
  document.getElementById('bid-modal-title').textContent = 'New Bid';
  document.getElementById('bid-name').value = '';
  document.getElementById('bid-value').value = '';
  document.getElementById('bid-status').value = 'estimating';
  document.getElementById('bid-due').value = '';
  document.getElementById('bid-construction').value = '';
  document.getElementById('bid-notes').value = '';
  document.getElementById('bid-contact').value = '';
  document.getElementById('bid-company').value = '';
  document.getElementById('file-list').innerHTML = '';
  document.getElementById('bid-contact-preview').style.display = 'none';
  populateBidCompanyDropdown();
  renderModalAssign();
  document.getElementById('bid-modal').classList.add('open');
}

function editBid(id) {
  const b = bids.find(x => x.id === id);
  if (!b) return;
  editingBidId = id;
  pendingFiles = b.files ? [...b.files] : [];
  modalAssigned = b.assigned ? [...b.assigned] : [];
  document.getElementById('bid-modal-title').textContent = 'Edit Bid';
  document.getElementById('bid-name').value = b.name;
  document.getElementById('bid-status').value = b.status;
  document.getElementById('bid-value').value = b.value || '';
  document.getElementById('bid-contact').value = b.contact || '';
  document.getElementById('bid-company').value = b.company || '';
  document.getElementById('bid-due').value = b.due || '';
  document.getElementById('bid-construction').value = b.construction || '';
  document.getElementById('bid-notes').value = b.notes || '';
  renderModalAssign();
  renderFileList();
  // Populate dropdowns and try to match existing contact
  populateBidCompanyDropdown(b.company || '');
  // After company is populated, match contact name
  const coSel = document.getElementById('bid-company-select');
  const companyId = coSel.value;
  populateBidContactDropdown(companyId, b.contact || '');
  document.getElementById('bid-modal').classList.add('open');
}

function closeBidModal() {
  document.getElementById('bid-modal').classList.remove('open');
}

function saveBid() {
  const name = document.getElementById('bid-name').value.trim();
  if (!name) { alert('Project name is required.'); return; }
  const data = {
    name,
    status: document.getElementById('bid-status').value,
    value: parseFloat(document.getElementById('bid-value').value) || 0,
    contact: document.getElementById('bid-contact').value.trim(),
    company: document.getElementById('bid-company').value.trim(),
    due: document.getElementById('bid-due').value,
    construction: document.getElementById('bid-construction').value,
    notes: document.getElementById('bid-notes').value.trim(),
    files: [...pendingFiles],
    assigned: [...modalAssigned],
    // store linked IDs for richer display
    contactPersonId: parseInt(document.getElementById('bid-contact-select').value) || null,
    contactCompanyId: parseInt(document.getElementById('bid-company-select').value) || null,
  };

  if (editingBidId) {
    const idx = bids.findIndex(b => b.id === editingBidId);
    bids[idx] = { ...bids[idx], ...data };
    showToast('Bid updated successfully!');
  } else {
    data.id = ++nextId;
    bids.unshift(data);
    showToast('Bid added successfully!');
  }

  closeBidModal();
  renderBidsTable();
  renderDashboard();
}

function deleteBid(id) {
  if (!confirm('Delete this bid?')) return;
  bids = bids.filter(b => b.id !== id);
  renderBidsTable();
  renderDashboard();
  showToast('Bid deleted.');
}

// ============ FILES ============
function addFiles(files) {
  Array.from(files).forEach(f => {
    pendingFiles.push({ name: f.name, size: f.size, type: f.type });
  });
  renderFileList();
}

function renderFileList() {
  document.getElementById('file-list').innerHTML = pendingFiles.map((f, i) => `
    <div class="file-item">
      <div class="file-item-name">üìé ${f.name} <span style="color:var(--muted);margin-left:8px;font-size:11px;">${(f.size/1024).toFixed(1)} KB</span></div>
      <span class="file-remove" onclick="removeFile(${i})">‚úï</span>
    </div>
  `).join('');
}

function removeFile(i) {
  pendingFiles.splice(i, 1);
  renderFileList();
}

function dragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('dragover'); }
function dragLeave(e) { document.getElementById('drop-zone').classList.remove('dragover'); }
function dropFiles(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('dragover');
  addFiles(e.dataTransfer.files);
}

// ============ CONTACTS ‚Äî Company + Person model ============

let companies = [
  { id: 10, name: 'Akela Construction Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 200, first: 'Helen', last: 'Claridge', role: 'Estimator', email: 'helen@akelaconstruction.com', phone: '', notes: '' }
    ]
  },
  { id: 11, name: 'Ashton Luxury Living', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 201, first: 'John', last: 'Arcurri', role: 'President', email: 'john@ashtongrp.ca', phone: '14037302375', notes: '' }
    ]
  },
  { id: 12, name: 'CNJ Developments', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 202, first: 'Michelle', last: 'Skerry', role: 'Estimator', email: 'michelle@cnjdevelopments.com', phone: '14038604943', notes: '' }
    ]
  },
  { id: 13, name: 'EFC Developments', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 203, first: 'Don', last: 'Bergerman', role: 'GM', email: 'Dbergerman@efcdev.ca', phone: '14033121143', notes: '' },
      { id: 225, first: 'Matt', last: 'Thompson', role: 'Property Manager', email: 'mthompson@efcdev.ca', phone: '15872293398', notes: '' },
      { id: 242, first: 'Brainard', last: 'Vibora', role: '', email: 'bvibora@efcdev.ca', phone: '7807147037', notes: '' },
      { id: 285, first: 'Phetsamone', last: 'Chanthamala', role: 'Project Manager', email: 'pchanthamala@efcdev.ca', phone: '4038088656', notes: '' }
    ]
  },
  { id: 14, name: 'Home By Us', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 204, first: 'Nicole', last: 'Phee', role: 'Estimator', email: 'office@homebyus.ca', phone: '4039267886', notes: '' }
    ]
  },
  { id: 15, name: 'Konstruct Developments Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 205, first: 'Niklas', last: 'Bartsch', role: 'President', email: 'niklas@crossroadhomes.ca', phone: '4035428702', notes: '' }
    ]
  },
  { id: 16, name: 'LD&A Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 206, first: 'Neil', last: 'Bailey', role: 'President', email: 'e.neil@lynndonaldson.ca', phone: '14038160364', notes: '' },
      { id: 226, first: 'Jenna', last: 'Dimler', role: 'Interior Designer', email: 'jenna@lynndonaldson.ca', phone: '5875855168', notes: '' },
      { id: 240, first: 'Lindsey', last: 'Tsang', role: 'Lead Interior Design', email: 'lindsey@lynndonaldson.ca', phone: '14037019457', notes: '' },
      { id: 323, first: 'Lauren', last: 'Wood', role: 'Interior stylist & admin', email: 'lauren@lynndonaldson.ca', phone: '5874327535', notes: '' }
    ]
  },
  { id: 17, name: 'BSI Build', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 207, first: 'Joey', last: 'Calvitti', role: 'Director of Estimating', email: 'jcalvitti@bsibuild.ca', phone: '14033711969', notes: '' },
      { id: 208, first: 'Joon', last: 'Yi', role: 'Estimator', email: 'jyi@bsibuild.ca', phone: '14033891989', notes: '' },
      { id: 209, first: 'Jack', last: 'Che', role: 'Estimator', email: 'jche@bsibuild.ca', phone: '14033896861', notes: '' },
      { id: 227, first: 'Franco', last: 'Falcone', role: 'Estimator', email: 'ffalcone@bsibuild.ca', phone: '4036056108', notes: '' },
      { id: 246, first: 'Martin', last: 'Maranon', role: 'Office and Inventory Clerk', email: 'project@bsibuild.ca', phone: '14039666616', notes: '' },
      { id: 263, first: 'Carlle', last: 'Balanquit', role: 'Lead Estimator', email: 'cbalanquit@bsibuild.ca', phone: '14033891989', notes: '' },
      { id: 264, first: 'Remy', last: 'Gallego', role: 'Sr. Project coordinator', email: 'rgallego@bsibuild.ca', phone: '13688864100', notes: '' },
      { id: 266, first: 'Jeremy', last: 'Hiscock', role: 'President', email: 'jhiscock@bsibuild.ca', phone: '', notes: '' },
      { id: 267, first: 'Orlando', last: 'Corrales Lopez', role: 'Project Manager', email: 'ocorrales@bsibuild.ca', phone: '13688863900', notes: '' }
    ]
  },
  { id: 18, name: 'Old Street Dev.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 210, first: 'Jon', last: 'Turton', role: 'Operations Manager', email: 'jon.turton@oldstreet.ca', phone: '', notes: '' }
    ]
  },
  { id: 19, name: 'Nelson Homes', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 211, first: 'Zizi', last: 'Knudsen', role: 'Office Admin', email: 'zknudsen@nlc.ca', phone: '14036522288', notes: '' },
      { id: 212, first: 'Ryan', last: 'Wyngaarden', role: 'Construction Supervisor', email: 'rwyngaarden@nlc.ca', phone: '14036522288', notes: '' },
      { id: 213, first: 'Jason', last: 'Sawchuk', role: 'Regional Manager', email: 'jsawchuk@nlc.ca', phone: '14036016821', notes: '' }
    ]
  },
  { id: 20, name: 'Birchcliff properties', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 214, first: 'Derek', last: 'Selanders', role: 'Owner', email: 'derekselanders@hotmail.com', phone: '', notes: '' }
    ]
  },
  { id: 21, name: 'Interior Care', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 215, first: 'Connor', last: 'Linton', role: 'Team Lead, National Project Management', email: 'connor@interiorcare.com', phone: '4164768247', notes: '' }
    ]
  },
  { id: 22, name: 'Gill Developments', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 216, first: 'Sunny', last: 'Dhaliwal', role: 'Vice President, Operations', email: 'sunny@gilldevelopments.ca', phone: '14039912320', notes: '' }
    ]
  },
  { id: 23, name: 'Novacom Building Partners Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 217, first: 'Brett', last: 'Robinson', role: 'Estimator', email: 'brett@novacom.ca', phone: '16044248075', notes: '' }
    ]
  },
  { id: 24, name: 'Workhub Software', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 218, first: 'Brian', last: 'Nodwell', role: '', email: 'brian.nodwell@workhub.com', phone: '4038886177', notes: '' }
    ]
  },
  { id: 25, name: 'Home Owner', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 219, first: 'Paul', last: 'Davis', role: '', email: '', phone: '', notes: '' },
      { id: 241, first: 'Daniel', last: 'Senecal', role: 'Home Owner', email: 'seneboy@gmail.com', phone: '4038265358', notes: '' },
      { id: 281, first: 'Cheryl', last: 'Barr', role: 'Home Owner', email: '', phone: '', notes: '' }
    ]
  },
  { id: 26, name: 'Span West building corporation', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 220, first: 'Jignesh', last: 'Parikh', role: 'Estimator', email: 'jignesh@spanwest.com', phone: '13062424624', notes: '' }
    ]
  },
  { id: 27, name: 'Luxridge Custom Builders Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 221, first: 'Brian', last: 'Dotinga', role: 'Owner', email: '', phone: '5874371527', notes: '' }
    ]
  },
  { id: 28, name: 'Melanson Homes & Renovations  Ellie Cabinet Co.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 222, first: 'Murray', last: 'Petkau', role: 'President', email: 'Murray.p@melansonhomes.com', phone: '14038288969', notes: '' },
      { id: 223, first: 'Jen', last: 'Stricker', role: 'Office Admin', email: 'admin@melansonhomes.com', phone: '14036901000', notes: '' },
      { id: 224, first: 'Ryan', last: 'Stricker', role: 'Site Supervisor', email: 'ryan.s@melansonhomes.com', phone: '15878936662', notes: '' }
    ]
  },
  { id: 29, name: 'PK Developments', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 228, first: 'Sai', last: 'Ram', role: 'Project Coordinator', email: 'sram@pkdevelopments.ca', phone: '17802965283', notes: '' },
      { id: 229, first: 'Rob', last: 'Elliot', role: 'Senior PM', email: 'relliott@pkdevelopments.ca', phone: '', notes: '' }
    ]
  },
  { id: 30, name: 'Rectangle Design', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 230, first: 'Marc', last: 'Lehodey', role: 'Operations Manager', email: 'marc@rectangle.ca', phone: '12505086335', notes: '' }
    ]
  },
  { id: 31, name: 'Dwell Custom Homes', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 231, first: 'Imran', last: 'Choudry', role: 'Office Admin', email: 'imran_choudry@hotmail.com', phone: '', notes: '' }
    ]
  },
  { id: 32, name: 'BIBD (Calgary) Inc.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 232, first: 'Courtney', last: 'Lewis', role: 'Office Admin', email: 'courtney@buildit.ca', phone: '18254491872', notes: '' },
      { id: 245, first: 'Rebeka', last: 'Tavares', role: 'Estimator', email: 'rebeka@buildit.ca', phone: '', notes: '' },
      { id: 247, first: 'Louisa', last: 'Gwin', role: 'Estimator', email: 'louisa@buildit.ca', phone: '8254251221', notes: '' }
    ]
  },
  { id: 33, name: 'Maple Reinders', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 233, first: 'Munaf', last: 'Ladha', role: 'Senior Estimator', email: '', phone: '', notes: '' },
      { id: 273, first: 'Darija', last: 'Svilar', role: 'Estimator', email: 'darijas@maple.ca', phone: '7804655980', notes: '' }
    ]
  },
  { id: 34, name: 'Rescom Construction Management Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 234, first: 'Jeffrey', last: 'Byma', role: 'Pre-Construction & Estimating', email: 'jeff.byma@rescombuilds.com', phone: '17803948452', notes: '' }
    ]
  },
  { id: 35, name: 'Telsec Property Corp', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 235, first: 'Brad', last: 'Macauley', role: 'Construction Manager', email: 'brad@telsec', phone: '4032033884', notes: '' },
      { id: 248, first: 'Gerald', last: 'Depuis', role: 'Operation Manager', email: 'gerald@telsec.ca', phone: '4033121885', notes: '' },
      { id: 256, first: 'Fadoua', last: 'Bouaouda', role: 'Construction', email: 'Fadoua@telsec.ca', phone: '4032030474', notes: '' },
      { id: 271, first: 'Paul', last: 'Pashulka', role: 'Project Manager', email: 'paul@telsec.ca', phone: '4038998505', notes: '' }
    ]
  },
  { id: 36, name: 'Red Wolf Group Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 236, first: 'Johnny', last: 'Riccardelli', role: 'President', email: 'jr@redwolfgroup.ca', phone: '19056603535', notes: '' }
    ]
  },
  { id: 37, name: 'WMGC Solutions', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 237, first: 'Warren', last: 'Muller', role: 'President', email: 'warrenmuller@me.com', phone: '4039666689', notes: '' }
    ]
  },
  { id: 38, name: 'Rayner Construction Services Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 238, first: 'Edwin', last: 'So', role: 'Estimator', email: 'estimating@raynercs.com', phone: '4038282401', notes: '' }
    ]
  },
  { id: 39, name: 'Bedrock Construction Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 239, first: 'Corrie', last: 'Massie', role: 'President', email: 'corrie@bedrockonline.com', phone: '4038047124', notes: '' }
    ]
  },
  { id: 40, name: 'Planit Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 243, first: 'Kim', last: 'Allen Roque', role: 'Estimator', email: 'kimr@planitconstruction.com', phone: '5143391112', notes: '' },
      { id: 276, first: 'Juan', last: 'Aquino', role: 'Estimator', email: 'juana@planitconstruction.com', phone: '15143391112', notes: '' }
    ]
  },
  { id: 41, name: 'Build It', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 244, first: 'Ashish', last: 'Chopra', role: 'Estimator', email: 'ashish@buildit.ca', phone: '4039061025', notes: '' },
      { id: 287, first: 'Marcelo', last: 'Arantes', role: '', email: '', phone: '', notes: '' },
      { id: 319, first: 'Kevin', last: 'Brown', role: '', email: '', phone: '', notes: '' }
    ]
  },
  { id: 42, name: '42Tech Modular', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 249, first: 'Wade', last: 'Adams', role: 'President', email: 'wade@42techmodular.ca', phone: '4033894491', notes: '' }
    ]
  },
  { id: 43, name: 'Hockaday Homes', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 250, first: 'Dilesh', last: 'Sidhpura', role: 'Owner', email: 'info@hockadayhomes.com', phone: '4038522212', notes: '' }
    ]
  },
  { id: 44, name: 'Scott Builders Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 251, first: 'Bill', last: 'Rowell', role: 'Senior Estimator', email: 'billr@scottbuilders.com', phone: '4035206528', notes: '' }
    ]
  },
  { id: 45, name: 'Longboard Construction Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 252, first: 'Cory', last: 'Robertson', role: 'Senior Estimator', email: 'cory@lbconstruction.ca', phone: '4039124080', notes: '' },
      { id: 290, first: 'Mitch', last: 'Mcloed', role: 'Estimator', email: 'mitchell@lbconstruction.ca', phone: '4039124080', notes: '' }
    ]
  },
  { id: 46, name: 'OML Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 253, first: 'Liam', last: 'Wheadon', role: 'Project Manager', email: 'lwheadon@omlconstruction.com', phone: '7809771010', notes: '' }
    ]
  },
  { id: 47, name: 'Private Owner', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 254, first: 'Ali', last: 'Hamdan', role: 'Owner', email: 'ahamdan00@gmail.com', phone: '4039718844', notes: '' },
      { id: 255, first: 'Bronwen', last: 'Davis', role: 'Home Owner', email: 'Bronwendavisray@gmail.com', phone: '4035108741', notes: '' }
    ]
  },
  { id: 48, name: 'Fillmore Construction - Edmonton', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 257, first: 'FCMI', last: 'Estimating', role: 'Estimating Dept.', email: 'estimating@fcmi.net', phone: '7806381030', notes: '' },
      { id: 284, first: 'Colin', last: 'Letawsky', role: '', email: 'cletawsky@fcmi.net', phone: '', notes: '' }
    ]
  },
  { id: 49, name: 'Cascade Custom Home Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 258, first: 'Candice', last: 'Cretney', role: '', email: 'candice@cascadecustomhomes.ca', phone: '4038182460', notes: '' }
    ]
  },
  { id: 50, name: 'The Anglican Diocese of Calgary', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 259, first: 'Frank', last: 'Corbett', role: 'Property Assistant', email: 'property@calgary.anglican.ca', phone: '5873201345', notes: '' }
    ]
  },
  { id: 51, name: 'Truman Homes', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 260, first: 'Brian', last: 'Madayag', role: 'Project Manager', email: 'brian.madayag@trumanhomes.com', phone: '4035105147', notes: '' }
    ]
  },
  { id: 52, name: 'Swift Builders Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 261, first: 'Dinko', last: 'Condric', role: 'Manager, Preconstruction & Estimating', email: 'dcondric@swiftbuilders.ca', phone: '5877070876', notes: '' }
    ]
  },
  { id: 53, name: 'Cambria Design Build Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 262, first: 'Saqib', last: 'Amer', role: 'Project Coordinator', email: 'samer@cambriadesign.ca', phone: '12897163641', notes: '' }
    ]
  },
  { id: 54, name: 'Hipperson Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 265, first: 'Demi', last: 'Sison', role: 'PM/Estimator', email: 'demis@hippersonconstruction.com', phone: '3063595206', notes: '' }
    ]
  },
  { id: 55, name: 'Dawn Construction (2018) Ltd.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 268, first: 'Pratiksha', last: 'Mahant', role: 'Estimator', email: 'pmahant@dawnconstruction.com', phone: '2367777457', notes: '' }
    ]
  },
  { id: 56, name: 'TD renovation and Construction ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 269, first: 'Troy', last: 'Schmirler', role: '', email: 'troy@tdrenovation.com', phone: '4036132533', notes: '' },
      { id: 291, first: 'Wayne', last: 'Schmirler', role: 'Sales', email: 'wayne@tdrenovation.com', phone: '4034733245', notes: '' }
    ]
  },
  { id: 57, name: 'Haven Luxury Homes', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 270, first: 'Nicholas', last: 'Olson', role: 'Operations Manager', email: 'operations@havenluxuryhomes.com', phone: '8259450312', notes: '' }
    ]
  },
  { id: 58, name: 'Keller Construction Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 272, first: 'Austin', last: 'Rossmann', role: 'Junior Estimator', email: 'austinr@keller.ab.ca', phone: '7804841010', notes: '' },
      { id: 292, first: 'Francis', last: 'Bordaje', role: 'Estimator', email: 'francisb@keller.ab.ca', phone: '7804470248', notes: '' },
      { id: 295, first: 'Marc', last: 'Brown', role: 'Chief Estimator', email: 'marcb@keller.ab.ca', phone: '7802453975', notes: '' }
    ]
  },
  { id: 59, name: 'Gator Construction Group Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 274, first: 'Todd', last: 'Harkness', role: 'Senior Project Manager', email: 't.harkness@gatorbuilt.ca', phone: '7802883394', notes: '' }
    ]
  },
  { id: 60, name: 'Index Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 275, first: 'Robert', last: 'Muto', role: 'Vice President, Estimating', email: 'rmuto@indexconstruction.ca', phone: '', notes: '' }
    ]
  },
  { id: 61, name: 'FWD Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 277, first: 'Stephen', last: 'Chen', role: 'Estimator', email: 'stephen@fwdconstruction.ca', phone: '5875861949', notes: '' },
      { id: 280, first: 'Ammar', last: 'Hamad', role: 'Operations Manager', email: 'ammar@fwdconstruction.ca', phone: '4036304118', notes: '' },
      { id: 306, first: 'Nick', last: 'lobello', role: 'Estimator', email: 'nick@fwdconstruction.ca', phone: '4033330047', notes: '' }
    ]
  },
  { id: 62, name: 'Luxuria Group', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 278, first: 'Wilson', last: 'Chuong', role: 'Operations Manager', email: 'w.chuong@luxuriahomes.ca', phone: '4069195395', notes: '' }
    ]
  },
  { id: 63, name: 'Quest Construction and Management', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 279, first: 'Caleb', last: 'Webb', role: 'Site Superintendent', email: 'cwebb@q-cm.ca', phone: '4036330127', notes: '' }
    ]
  },
  { id: 64, name: 'JVF Project Management & Consulting', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 282, first: 'Adam', last: 'Rosendahl', role: 'Project Manager', email: 'arosendahl@jvfsolutions.ca', phone: '4035107119', notes: '' },
      { id: 324, first: 'Domenic', last: 'Migliarese', role: 'Estimating Manager', email: 'dmigliarese@jvfsolutions.ca', phone: '4033120288', notes: '' }
    ]
  },
  { id: 65, name: 'Direct Construction Company Limited', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 283, first: 'Harkeerat', last: 'Singh', role: '', email: 'hsaini@directconstruction.ca', phone: '', notes: '' }
    ]
  },
  { id: 66, name: 'Leeswood Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 286, first: 'Joe', last: 'Bonitatibus', role: 'Estimator', email: 'jbonitatibus@leeswood.ca', phone: '5873553737', notes: '' }
    ]
  },
  { id: 67, name: 'Traugott Building Contractors', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 288, first: 'Greg', last: 'Clarke', role: 'Estimator', email: 'gregc@traugott.com', phone: '4032766444', notes: '' }
    ]
  },
  { id: 68, name: 'Vanguard Commercial Services', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 289, first: 'Alsion', last: 'Erwood', role: 'Project Coordinator', email: 'alison@vanguardcommercial.ca', phone: '6048663662', notes: '' }
    ]
  },
  { id: 69, name: 'Holland Licensed Interior Design', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 293, first: 'Jaime', last: 'Holland', role: 'Founding Partner', email: 'jaime@hollanddesign.ca', phone: '4034540592', notes: '' }
    ]
  },
  { id: 70, name: 'Parke Pacific Projects Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 294, first: 'Logan', last: 'House', role: 'Project Coordinator', email: 'logan@parkepacific.ca', phone: '2506814861', notes: '' }
    ]
  },
  { id: 71, name: 'Carbon Build', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 296, first: 'Victoria', last: 'Temple', role: 'Project Manager', email: 'victoria@carbonbuild.ca', phone: '14163668208', notes: '' }
    ]
  },
  { id: 72, name: 'Versatile Developments', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 297, first: 'John', last: 'Mclelland', role: 'Sr. Site Supervisor', email: 'john@versatiledevelopments.com', phone: '17809071577', notes: '' },
      { id: 303, first: 'Shirley', last: 'Huynh', role: 'Office Admin', email: 'shirley@versatiledevelopments.com', phone: '7807092633', notes: '' }
    ]
  },
  { id: 73, name: 'Lusso Custom Homes Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 298, first: 'Anthony', last: 'Cimino', role: 'Owner', email: 'anthony@lussocustomhomes.com', phone: '4038508138', notes: '' }
    ]
  },
  { id: 74, name: 'Catalyst Construction Group - Ajax', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 299, first: 'Ali', last: 'Aghigh', role: 'Bid Manager / Coordinator', email: 'info@catalystconstructiongroup.ca', phone: '14379855844', notes: '' }
    ]
  },
  { id: 75, name: 'Aethos Strategic', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 300, first: 'Peter', last: 'Kiranas', role: '', email: 'peter@ethosprojects.ca', phone: '4035404118', notes: '' }
    ]
  },
  { id: 76, name: 'Centom Construction Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 301, first: 'Chris', last: 'Craig', role: 'President', email: 'chris.craig@centcom.ca', phone: '4038528100', notes: '' }
    ]
  },
  { id: 77, name: 'Avalon', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 302, first: 'Graham', last: 'O`neil', role: 'Estimating Manager', email: 'goneill@avalonmasterbuilder.com', phone: '', notes: '' }
    ]
  },
  { id: 78, name: 'BSI Build / Theodore Builders', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 304, first: 'Trevor', last: 'Crowdis', role: 'Estimator', email: 'tcrowdis@theodorebuilders.ca', phone: '', notes: '' },
      { id: 316, first: 'Tracy', last: 'Conrad', role: 'Project Coordinator', email: 'tconrad@theodorebuilders.ca', phone: '9028742192', notes: '' }
    ]
  },
  { id: 79, name: 'Mirabelli', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 305, first: 'Giovanna', last: 'Helmer', role: 'Estimator', email: 'giovanna.helmer@mirabellicorp.com', phone: '4162090539', notes: '' }
    ]
  },
  { id: 80, name: 'Elevated', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 307, first: 'Colin', last: 'Godbout', role: '', email: 'colin@elevatedyyc.ca', phone: '4039662625', notes: '' }
    ]
  },
  { id: 81, name: 'Cornad Contracting Inc', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 308, first: 'Deola', last: 'Onifade', role: 'Estimator', email: 'Deola.Onifade@cornad.ca', phone: '4033872784', notes: '' }
    ]
  },
  { id: 82, name: 'Novesta Projects', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 309, first: 'Dusan', last: 'Aralica', role: 'Senior Project Manager', email: 'dusan@novesta.ca', phone: '7809659952', notes: '' },
      { id: 312, first: 'Mike', last: 'Garcia', role: 'Project Manager', email: 'mike@novesta.ca', phone: '', notes: '' }
    ]
  },
  { id: 83, name: 'Elite Painting', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 310, first: 'Brad', last: 'Bell', role: 'Owner', email: 'bcampbell@elitepainting.com', phone: '4033990763', notes: '' }
    ]
  },
  { id: 84, name: 'Engineeredto Development Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 311, first: 'Able', last: 'Abraham', role: 'Estimator', email: 'a.abraham@engineeredto.com', phone: '4039180751', notes: '' }
    ]
  },
  { id: 85, name: 'Carter Home & Design', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 313, first: 'James', last: 'Carter', role: 'Project Manager', email: 'carterdesign@live.ca', phone: '4036809058', notes: '' }
    ]
  },
  { id: 86, name: 'Total Construction Group', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 314, first: 'Trevor', last: 'Schulz', role: 'Owner', email: 'trevor@totalconstruction.com', phone: '4032142121', notes: '' }
    ]
  },
  { id: 87, name: 'Statera Contracting', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 315, first: 'Madison', last: 'Inkster', role: 'Office Manager', email: 'statera.manager@gmail.com', phone: '', notes: '' }
    ]
  },
  { id: 88, name: 'Hestia Construction', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 317, first: 'Adam', last: 'Wilcox', role: '', email: 'AWilcox@hestiaconstruction.ca', phone: '', notes: '' }
    ]
  },
  { id: 89, name: 'Platinum Homes Canada Ltd.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 318, first: 'David', last: 'Mirosevic', role: 'Estimator', email: 'david@platinumhomescanada.ca', phone: '4039887368', notes: '' }
    ]
  },
  { id: 90, name: 'Seko Construction Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 320, first: 'William', last: 'Dayman', role: 'PM/Estimator', email: 'bdayman@sekoconstruction.com', phone: '4032120800', notes: '' }
    ]
  },
  { id: 91, name: 'First General Services (Calgary) Inc.', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 321, first: 'Angel', last: 'Garant', role: 'File Manager -  Commercial & Complex Loss Division', email: 'angel.garant@firstgeneral.net', phone: '4032294471', notes: '' }
    ]
  },
  { id: 92, name: 'My Home Options Ltd', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 322, first: 'Simona', last: 'Smolejova', role: '', email: 'simona@myhomeoptions.ca', phone: '5878992837', notes: '' }
    ]
  },
  { id: 93, name: 'Ledcor Group', email: '', phone: '', address: '', notes: '',
    persons: [
      { id: 325, first: 'Matthew', last: 'Klassen', role: 'Preconstruction Manager', email: 'matt.klassen@ledcor.com', phone: '14034773329', notes: '' }
    ]
  },
];

let selectedCompanyId = null;
let editingPersonId = null;
let editingCompanyId = null;
const companyColors = [
  { bg: '#3b82f615', color: '#3b82f6' },
  { bg: '#f5a62315', color: '#f5a623' },
  { bg: '#2ecc7115', color: '#2ecc71' },
  { bg: '#a855f715', color: '#a855f7' },
  { bg: '#06b6d415', color: '#06b6d4' },
  { bg: '#e8391d15', color: '#e8391d' },
];

function companyColor(idx) { return companyColors[idx % companyColors.length]; }

function getCompanyInitials(name) {
  return name.split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();
}

function renderContacts() {
  renderCompanyList();
  if (selectedCompanyId) {
    renderCompanyDetail(selectedCompanyId);
  }
}

function filterCompanies(q) {
  renderCompanyList(q.toLowerCase());
}

function renderCompanyList(query = '') {
  const list = document.getElementById('company-list');
  let filtered = companies;
  if (query) filtered = companies.filter(c => c.name.toLowerCase().includes(query));
  if (!filtered.length) {
    list.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted);font-size:13px;">No companies found</div>`;
    return;
  }
  list.innerHTML = filtered.map((co, i) => {
    const col = companyColor(companies.indexOf(co));
    const initials = getCompanyInitials(co.name);
    const bidCount = bids.filter(b => b.company.toLowerCase().includes(co.name.toLowerCase().split(' ')[0])).length;
    const isActive = co.id === selectedCompanyId;
    return `
      <div class="company-item ${isActive ? 'active' : ''}" onclick="selectCompany(${co.id})">
        <div class="company-item-logo" style="background:${col.bg};color:${col.color};">${initials}</div>
        <div class="company-item-info">
          <div class="company-item-name">${co.name}</div>
          <div class="company-item-meta">${co.persons.length} contact${co.persons.length !== 1 ? 's' : ''} ¬∑ ${bidCount} bid${bidCount !== 1 ? 's' : ''}</div>
        </div>
      </div>
    `;
  }).join('');
}

function selectCompany(id) {
  selectedCompanyId = id;
  document.getElementById('add-contact-btn').style.display = 'flex';
  renderCompanyList();
  renderCompanyDetail(id);
}

function renderCompanyDetail(id) {
  const co = companies.find(c => c.id === id);
  if (!co) return;
  const idx = companies.indexOf(co);
  const col = companyColor(idx);
  const initials = getCompanyInitials(co.name);
  const relatedBids = bids.filter(b => b.company.toLowerCase().includes(co.name.toLowerCase().split(' ')[0]));

  const panel = document.getElementById('company-detail-panel');
  panel.innerHTML = `
    <div class="company-detail-content">
      <!-- Left: company info -->
      <div class="company-info-col">
        <div class="company-logo-large" style="background:${col.bg};color:${col.color};">${initials}</div>
        <div class="company-detail-name">${co.name}</div>

        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn btn-ghost btn-sm" onclick="openEditCompanyModal(${co.id})">‚úèÔ∏è Edit</button>
          <button class="btn btn-sm" style="background:var(--danger)20;color:var(--danger);border:1px solid var(--danger)40;" onclick="deleteCompany(${co.id})">üóë Delete</button>
        </div>

        ${co.email || co.phone || co.address ? `<div class="company-info-label">Contact Info</div>` : ''}
        ${co.email ? `<div class="company-info-row">‚úâ <span style="color:var(--blue)">${co.email}</span></div>` : ''}
        ${co.phone ? `<div class="company-info-row">üìû <span>${co.phone}</span></div>` : ''}
        ${co.address ? `<div class="company-info-row">üìç <span>${co.address}</span></div>` : ''}

        ${relatedBids.length ? `
        <div class="company-info-label">Active Bids (${relatedBids.length})</div>
        <div class="company-bids-list">
          ${relatedBids.map(b => `
            <div class="company-bid-pill" onclick="showPage('bids')">
              <span class="status-badge badge-${b.status}" style="font-size:10px;padding:2px 8px;">${statusLabel(b.status)}</span>
              <span style="font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${b.name}</span>
            </div>
          `).join('')}
        </div>` : `<div class="company-info-label" style="margin-top:20px;">No bids yet</div>`}

        ${co.notes ? `<div class="company-info-label">Notes</div><div style="font-size:12px;color:var(--muted);line-height:1.6;">${co.notes}</div>` : ''}
      </div>

      <!-- Right: persons -->
      <div class="contacts-col">
        <div class="contacts-col-header">
          <div class="contacts-col-title">Contacts (${co.persons.length})</div>
          <button class="btn btn-primary btn-sm" onclick="openAddPersonModal()">+ Add Contact</button>
        </div>
        <div class="contacts-person-list" id="persons-list">
          ${renderPersonsList(co)}
        </div>
      </div>
    </div>
  `;
}

function renderPersonsList(co) {
  if (!co.persons.length) {
    return `<div class="empty-state"><div class="empty-icon">üë§</div><div class="empty-text">No contacts yet for this company.</div><button class="btn btn-ghost btn-sm" onclick="openAddPersonModal()">+ Add First Contact</button></div>`;
  }
  const personColors = ['#3b82f6','#f5a623','#2ecc71','#a855f7','#06b6d4','#e8391d','#f97316','#ec4899'];
  return co.persons.map((p, i) => {
    const color = personColors[i % personColors.length];
    const initials = (p.first[0] + (p.last ? p.last[0] : '')).toUpperCase();
    return `
      <div class="contact-person-row">
        <div class="person-avatar" style="background:${color}18;color:${color};">${initials}</div>
        <div class="person-info">
          <div class="person-name">${p.first} ${p.last}</div>
          <div class="person-role">${p.role || 'Other'}</div>
        </div>
        <div class="person-contact-info">
          ${p.email ? `<a href="mailto:${p.email}">‚úâ ${p.email}</a>` : ''}
          ${p.phone ? `<span>üìû ${p.phone}</span>` : ''}
        </div>
        <div class="person-actions">
          <div class="action-btn" onclick="openEditPersonModal(${co.id}, ${p.id})" title="Edit">‚úèÔ∏è</div>
          <div class="action-btn del" onclick="deletePerson(${co.id}, ${p.id})" title="Delete">üóë</div>
        </div>
      </div>
    `;
  }).join('');
}

// ---- COMPANY MODAL ----
function openAddCompanyModal() {
  editingCompanyId = null;
  document.getElementById('company-modal-title').textContent = 'Add Company';
  ['co-name','co-email','co-phone','co-address','co-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('add-company-modal').classList.add('open');
}

function openEditCompanyModal(id) {
  const co = companies.find(c => c.id === id);
  if (!co) return;
  editingCompanyId = id;
  document.getElementById('company-modal-title').textContent = 'Edit Company';
  document.getElementById('co-name').value = co.name;
  document.getElementById('co-email').value = co.email || '';
  document.getElementById('co-phone').value = co.phone || '';
  document.getElementById('co-address').value = co.address || '';
  document.getElementById('co-notes').value = co.notes || '';
  document.getElementById('add-company-modal').classList.add('open');
}

function closeAddCompanyModal() {
  document.getElementById('add-company-modal').classList.remove('open');
}

function saveCompany() {
  const name = document.getElementById('co-name').value.trim();
  if (!name) { alert('Company name is required.'); return; }
  if (editingCompanyId) {
    const co = companies.find(c => c.id === editingCompanyId);
    co.name = name;
    co.email = document.getElementById('co-email').value.trim();
    co.phone = document.getElementById('co-phone').value.trim();
    co.address = document.getElementById('co-address').value.trim();
    co.notes = document.getElementById('co-notes').value.trim();
    showToast('Company updated!');
  } else {
    companies.push({
      id: ++nextId, name,
      email: document.getElementById('co-email').value.trim(),
      phone: document.getElementById('co-phone').value.trim(),
      address: document.getElementById('co-address').value.trim(),
      notes: document.getElementById('co-notes').value.trim(),
      persons: [],
    });
    showToast('Company added!');
  }
  closeAddCompanyModal();
  renderContacts();
  if (editingCompanyId) renderCompanyDetail(editingCompanyId);
}

function deleteCompany(id) {
  if (!confirm('Delete this company and all its contacts?')) return;
  companies = companies.filter(c => c.id !== id);
  selectedCompanyId = null;
  document.getElementById('add-contact-btn').style.display = 'none';
  document.getElementById('company-detail-panel').innerHTML = `
    <div class="company-detail-empty">
      <div style="font-size:48px;">üè¢</div>
      <div style="font-size:14px;">Select a company to view details</div>
      <button class="btn btn-ghost btn-sm" onclick="openAddCompanyModal()">+ Add your first company</button>
    </div>`;
  renderCompanyList();
  showToast('Company deleted.');
}

// ---- PERSON MODAL ----
function openAddPersonModal() {
  if (!selectedCompanyId) return;
  editingPersonId = null;
  document.getElementById('person-modal-title').textContent = 'Add Contact';
  ['p-first','p-last','p-email','p-phone','p-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p-role').value = 'Other';
  document.getElementById('add-person-modal').classList.add('open');
}

function openEditPersonModal(coId, personId) {
  const co = companies.find(c => c.id === coId);
  const p = co?.persons.find(x => x.id === personId);
  if (!p) return;
  selectedCompanyId = coId;
  editingPersonId = personId;
  document.getElementById('person-modal-title').textContent = 'Edit Contact';
  document.getElementById('p-first').value = p.first;
  document.getElementById('p-last').value = p.last || '';
  document.getElementById('p-role').value = p.role || 'Other';
  document.getElementById('p-email').value = p.email || '';
  document.getElementById('p-phone').value = p.phone || '';
  document.getElementById('p-notes').value = p.notes || '';
  document.getElementById('add-person-modal').classList.add('open');
}

function closeAddPersonModal() {
  document.getElementById('add-person-modal').classList.remove('open');
}

function savePerson() {
  const first = document.getElementById('p-first').value.trim();
  if (!first) { alert('First name is required.'); return; }
  const co = companies.find(c => c.id === selectedCompanyId);
  if (!co) return;

  const data = {
    first,
    last: document.getElementById('p-last').value.trim(),
    role: document.getElementById('p-role').value,
    email: document.getElementById('p-email').value.trim(),
    phone: document.getElementById('p-phone').value.trim(),
    notes: document.getElementById('p-notes').value.trim(),
  };

  if (editingPersonId) {
    const idx = co.persons.findIndex(p => p.id === editingPersonId);
    co.persons[idx] = { ...co.persons[idx], ...data };
    showToast('Contact updated!');
  } else {
    data.id = ++nextId;
    co.persons.push(data);
    showToast('Contact added!');
  }
  closeAddPersonModal();
  renderCompanyList();
  renderCompanyDetail(selectedCompanyId);
}

function deletePerson(coId, personId) {
  if (!confirm('Delete this contact?')) return;
  const co = companies.find(c => c.id === coId);
  co.persons = co.persons.filter(p => p.id !== personId);
  renderCompanyList();
  renderCompanyDetail(coId);
  showToast('Contact deleted.');
}

// legacy stubs so nothing else breaks
function openContactModal() { openAddCompanyModal(); }
function closeContactModal() { closeAddCompanyModal(); }
function saveContact() { savePerson(); }
function deleteContact(id) { deleteCompany(id); }

// ============ MY COMPANY ============
let myCompany = {
  name: 'Quality Gypsum Services Ltd',
  address: '92 Legacy Path SE',
  website: 'https://qualitygypsum.ca/',
  phone: '4038092908',
  email: 'info@qualitygypsum.ca',
  contactName: 'Fabian Vargas Garcia',
  logoDataUrl: '',
  inclusions: `Area of work must be scraped, broom swept and vacuumed before paint.
Fasteners for this scope of work are included.
All work to be completed during regular business hours.
The area of work will be kept clean and scrap materials will be placed in a garbage bin supplied by GC.
We have included lifts for our scope of work.
Temporary heat, hoarding, water, power, ventilation, and lighting by others.
A full-time Quality Gypsum superintendent will be assigned to the project.
One-Year Warranty`,
  exclusions: `Supply and install of drywall applied to trusses or joist above finished ceilings is not included.
We have not included for water resistant board in any areas unless noted above.
Supply and installation of access panel is by others.
We have not included for any horizontal shaft work.
GC to provide proper access for delivery of material to all floors. Extras may occur if access is not provided.
No trade damage was allowed, extra charge will apply.
We have not included for insulation for interior partitions.
We have not included for smoke separation in attic space.
Mech Room drywall is not included unless mentioned above.
Ceiling Texture cracks from existing drywall is not covered and to be charged as an extra.`,
  hourlyRates: `Site Foreman ‚Äî $65.00/hr
Journeyman ‚Äî $60.00/hr
Apprentice ‚Äî $52.00/hr
Labourer ‚Äî $45.00/hr
Service ‚Äî $70.00/hr + $125 Trip Charge`,
  termsAndConditions: `1. Scope and Validity
This quotation outlines the scope of work, materials, and services as described herein. Any additions, deletions, or modifications must be requested in writing and will be subject to a revised quotation. This quotation is valid for 45 days from the date of issue.

2. Acceptance
Acceptance of this quotation must be in writing and signed by the Client. Acceptance constitutes a binding agreement between QGS and the Client, subject to these terms and conditions.

3. Pricing and Payment
Prices are as stated in the quotation and are subject to change if the scope of work is modified. Unless otherwise agreed in writing, payment terms are NET 30 days from the date of invoice. A service charge of 2% per month (24% per annum) will be applied to all overdue amounts.

4. Exclusions
This quotation does not include any costs for items not specifically listed, including but not limited to: permits and inspections, site preparation beyond what is explicitly stated, and remediation of unforeseen conditions.

5. Site Conditions
The Client is responsible for ensuring the site is ready for QGS to perform the work, including providing safe and accessible work areas, ensuring the availability of necessary utilities (power, water, etc.), and maintaining required environmental conditions (e.g., temperature, humidity).

6. Permits and Inspections
The Client is responsible for obtaining all necessary permits and inspections, unless otherwise specified in the quotation.

7. Changes to Scope
Any changes to the scope of work must be authorized in writing through a formally executed Change Order. Change Orders will be subject to separate pricing and payment terms.

8. Schedule
QGS will make reasonable efforts to adhere to the estimated schedule, but is not liable for delays caused by factors outside its control, including client-caused delays, unforeseen site conditions, or force majeure events.

9. Warranty
QGS warrants its workmanship for a period of 1 year from the date of completion. This warranty covers defects in materials and labor but excludes damage caused by misuse, neglect, or normal wear and tear.

10. Limitations of Liability
QGS's liability for any claims arising from this quotation shall be limited to the contract price. QGS shall not be liable for any indirect, incidental, consequential, or punitive damages.

11. Dispute Resolution
Any disputes arising from or relating to this quotation shall be resolved through negotiation, mediation, or arbitration.

12. Governing Law
This quotation shall be governed by and construed in accordance with the laws of Alberta.

*QGS = Quality Gypsum Services Ltd`
};

function switchMCTab(tab) {
  ['info','defaults'].forEach(t => {
    document.getElementById('mc-tab-' + t).style.borderBottomColor = t === tab ? 'var(--accent)' : 'transparent';
    document.getElementById('mc-tab-' + t).style.color = t === tab ? 'var(--accent)' : 'var(--muted)';
    document.getElementById('mc-panel-' + t).style.display = t === tab ? '' : 'none';
  });
}

function openMyCompanyModal() {
  document.getElementById('my-name').value = myCompany.name;
  document.getElementById('my-address').value = myCompany.address;
  document.getElementById('my-website').value = myCompany.website;
  document.getElementById('my-phone').value = myCompany.phone;
  document.getElementById('my-email').value = myCompany.email;
  document.getElementById('my-contact-name').value = myCompany.contactName;
  document.getElementById('my-inclusions').value = myCompany.inclusions;
  document.getElementById('my-exclusions').value = myCompany.exclusions;
  document.getElementById('my-hourly-rates').value = myCompany.hourlyRates;
  document.getElementById('my-terms').value = myCompany.termsAndConditions;
  switchMCTab('info');
  renderMyLogoPreview();
  document.getElementById('my-company-modal').classList.add('open');
}

function closeMyCompanyModal() {
  document.getElementById('my-company-modal').classList.remove('open');
}

function saveMyCompany() {
  myCompany.name = document.getElementById('my-name').value.trim();
  myCompany.address = document.getElementById('my-address').value.trim();
  myCompany.website = document.getElementById('my-website').value.trim();
  myCompany.phone = document.getElementById('my-phone').value.trim();
  myCompany.email = document.getElementById('my-email').value.trim();
  myCompany.contactName = document.getElementById('my-contact-name').value.trim();
  myCompany.inclusions = document.getElementById('my-inclusions').value.trim();
  myCompany.exclusions = document.getElementById('my-exclusions').value.trim();
  myCompany.hourlyRates = document.getElementById('my-hourly-rates').value.trim();
  myCompany.termsAndConditions = document.getElementById('my-terms').value.trim();
  closeMyCompanyModal();
  updatePreview();
  updatePreview2();
  showToast('Company info saved!');
}

function handleLogoUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    myCompany.logoDataUrl = e.target.result;
    renderMyLogoPreview();
    updatePreview();
  };
  reader.readAsDataURL(file);
}

function clearLogo() {
  myCompany.logoDataUrl = '';
  renderMyLogoPreview();
  updatePreview();
}

function renderMyLogoPreview() {
  const el = document.getElementById('my-logo-preview');
  if (myCompany.logoDataUrl) {
    el.innerHTML = `<img src="${myCompany.logoDataUrl}" style="width:100%;height:100%;object-fit:contain;padding:4px;">`;
  } else {
    el.innerHTML = 'üèóÔ∏è';
  }
}

// ============ PROPOSAL PAGE SWITCHING ============
let currentProposalPage = 1;

function switchProposalPage(page) {
  currentProposalPage = page;
  const p1 = document.querySelector('.proposal-builder');
  const p2 = document.getElementById('prop-page2-panel');
  const tab1 = document.getElementById('prop-tab-1');
  const tab2 = document.getElementById('prop-tab-2');

  if (page === 1) {
    p1.style.display = 'grid';
    p2.style.display = 'none';
    tab1.style.borderBottomColor = 'var(--accent)';
    tab1.style.color = 'var(--accent)';
    tab2.style.borderBottomColor = 'transparent';
    tab2.style.color = 'var(--muted)';
  } else {
    p1.style.display = 'none';
    p2.style.display = 'grid';
    tab1.style.borderBottomColor = 'transparent';
    tab1.style.color = 'var(--muted)';
    tab2.style.borderBottomColor = 'var(--accent)';
    tab2.style.color = 'var(--accent)';
    updatePreview2();
  }
}

function resetPage2FromDefaults() {
  document.getElementById('p2-inclusions').value = myCompany.inclusions;
  document.getElementById('p2-exclusions').value = myCompany.exclusions;
  document.getElementById('p2-hourly').value = myCompany.hourlyRates;
  document.getElementById('p2-terms').value = myCompany.termsAndConditions;
  updatePreview2();
}

function updatePreview2() {
  const inclusions = document.getElementById('p2-inclusions')?.value || '';
  const exclusions = document.getElementById('p2-exclusions')?.value || '';
  const hourly     = document.getElementById('p2-hourly')?.value || '';
  const terms2     = document.getElementById('p2-terms')?.value || '';
  const project    = document.getElementById('p-project')?.value || '';
  const toList = (t) => t.split('\n').map(l=>l.trim()).filter(Boolean);
  const incItems  = toList(inclusions);
  const excItems  = toList(exclusions);
  const rateItems = toList(hourly);
  const termItems = toList(terms2);

  // Parse hourly rates ‚Äî split on em-dash, en-dash, or " - $"
  const rateRows = rateItems.map(item => {
    const parts = item.split(/\s*[‚Äî‚Äì]\s*|\s+-\s+(?=\$)/);
    return { role: parts[0]?.trim() || item, rate: parts[1]?.trim() || '' };
  });

  // Terms ‚Äî detect "N. Title\nBody" pattern
  const tcRows = [];
  let i = 0;
  while (i < termItems.length) {
    const m = termItems[i].match(/^(\d+)\.\s+(.+)/);
    if (m) {
      const title = m[2];
      let body = '';
      i++;
      while (i < termItems.length && !termItems[i].match(/^\d+\./)) {
        body += (body ? ' ' : '') + termItems[i];
        i++;
      }
      tcRows.push({ num: m[1], title, body });
    } else { i++; }
  }

  const hasAny = incItems.length || excItems.length || rateItems.length || termItems.length;

  const logoHtml = myCompany.logoDataUrl
    ? `<img src="${myCompany.logoDataUrl}" style="height:110px;max-width:160px;object-fit:contain;display:block;flex-shrink:0;">`
    : ``;

  document.getElementById('preview-doc-2').innerHTML = `
    <style>
      .p2-wrap * { box-sizing:border-box; margin:0; padding:0; }
      .p2-wrap { font-family:Arial,Helvetica,sans-serif; font-size:9pt; color:#1a1a1a; background:#fff; }
      .p2-header-line { height:3px; background:linear-gradient(90deg,#0066cc,#004499); margin-bottom:14px; border-radius:2px; }
      .p2-sec-hdr { background:#1a1a1a; color:#fff; font-size:9pt; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; padding:6px 12px; margin-bottom:10px; border-radius:3px; }
      .p2-inc-exc { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
      .p2-box { border:1px solid #ddd; border-radius:3px; overflow:hidden; }
      .p2-box-hdr { padding:5px 10px; font-size:8.5pt; font-weight:700; color:#fff; letter-spacing:0.5px; }
      .p2-box.inc .p2-box-hdr { background:#2d6a2d; }
      .p2-box.exc .p2-box-hdr { background:#8b2000; }
      .p2-box ul { padding:6px 10px 6px 22px; list-style:disc; }
      .p2-box ul li { font-size:8pt; color:#333; line-height:1.65; padding:0.5px 0; }
      .p2-rates-lbl { font-size:7.5pt; font-weight:600; color:#888; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
      .p2-rates-tbl { width:55%; border-collapse:collapse; margin-bottom:10px; font-size:8.5pt; }
      .p2-rates-tbl thead tr { background:#1a1a1a; color:#fff; }
      .p2-rates-tbl thead td { padding:5px 12px; font-weight:700; font-size:8pt; letter-spacing:0.5px; }
      .p2-rates-tbl tbody tr:nth-child(odd) { background:#f5f5f5; }
      .p2-rates-tbl tbody tr:nth-child(even) { background:#fff; }
      .p2-rates-tbl tbody td { padding:5px 12px; color:#333; border-bottom:1px solid #eee; }
      .p2-pay { background:#fff8e1; border:1px solid #f0c040; border-radius:3px; padding:8px 14px; font-size:8.5pt; color:#333; line-height:1.6; margin-bottom:14px; }
      .p2-tc { width:100%; border-collapse:collapse; font-size:8pt; margin-bottom:14px; }
      .p2-tc tr:nth-child(odd) { background:#fafafa; }
      .p2-tc tr:nth-child(even) { background:#fff; }
      .p2-tc td { padding:5px 8px; border:1px solid #e8e8e8; vertical-align:top; line-height:1.55; }
      .p2-tc td:first-child { font-weight:700; color:#1a1a1a; width:22%; font-size:8pt; white-space:nowrap; }
      .p2-tc td:last-child { color:#444; }
      .p2-accept { background:#f5f5f5; border:1px solid #ddd; border-radius:4px; padding:12px 16px; margin-bottom:14px; }
      .p2-accept p { font-size:8.5pt; color:#444; margin-bottom:16px; line-height:1.5; }
      .p2-sig-grid { display:grid; grid-template-columns:1fr 1fr 0.5fr; gap:16px; }
      .p2-sig-lbl { font-size:7pt; color:#888; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:18px; display:block; }
      .p2-sig-line { border-bottom:1px solid #333; height:1px; }
      .p2-footer { border-top:2px solid #0066cc; padding-top:6px; text-align:center; font-size:7.5pt; color:#888; line-height:1.7; margin-top:20px; }
    </style>
    <div class="p2-wrap">
      <!-- Mini header -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          ${logoHtml}
          <div>
            <div style="font-size:11pt;font-weight:800;color:#0066cc;line-height:1;letter-spacing:0.3px;margin-bottom:2px;">${myCompany.name || 'Quality Gypsum Services Ltd'}</div>
            <div style="font-size:6.5pt;color:#888;letter-spacing:1.2px;text-transform:uppercase;margin-bottom:4px;">Best Ideas ¬∑ Best Solutions ¬∑ Best Results</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-size:8pt;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;">Project</div>
          <div style="font-size:12pt;font-weight:700;color:#1a1a1a;">${project || '‚Äî'}</div>
          <div style="font-size:8pt;color:#888;margin-top:2px;">Page 2 of 2 ‚Äî General Conditions</div>
        </div>
      </div>
      <div class="p2-header-line"></div>

      ${!hasAny ? `<div style="font-size:12pt;color:#bbb;font-style:italic;padding:20px 0;">Fill in the fields on the left to preview Page 2.</div>` : ''}

      ${(incItems.length || excItems.length) ? `
      <div class="p2-sec-hdr">General Inclusions &amp; Exclusions</div>
      <div class="p2-inc-exc">
        <div class="p2-box inc">
          <div class="p2-box-hdr">‚úì General Inclusions</div>
          <ul>${incItems.map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
        <div class="p2-box exc">
          <div class="p2-box-hdr">‚úó General Exclusions</div>
          <ul>${excItems.map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
      </div>` : ''}

      ${rateRows.length ? `
      <div class="p2-rates-lbl">${myCompany.name || 'Quality Gypsum'} Hourly Rates ‚Äî For Change Orders &amp; T&amp;M Work</div>
      <table class="p2-rates-tbl">
        <thead><tr><td>Role</td><td>Hourly Rate</td></tr></thead>
        <tbody>${rateRows.map((r,i)=>`<tr><td>${r.role}</td><td>${r.rate}</td></tr>`).join('')}</tbody>
      </table>` : ''}

      ${rateItems.length ? `
      <div class="p2-pay">
        <strong>Payment Terms:</strong> NET 30 days from invoice date. A service charge of <strong>2% per month (24% per annum)</strong> will be applied to all overdue amounts. All prices are exclusive of GST. Quote valid for <strong>45 days</strong> from issue date.
      </div>` : ''}

      ${tcRows.length ? `
      <div class="p2-sec-hdr">Terms &amp; Conditions</div>
      <table class="p2-tc">
        ${tcRows.map(r=>`<tr><td>${r.num}. ${r.title}</td><td>${r.body}</td></tr>`).join('')}
      </table>` : (termItems.length ? `
      <div class="p2-sec-hdr">Terms &amp; Conditions</div>
      <table class="p2-tc">
        ${termItems.map((t,i)=>`<tr><td>${i+1}.</td><td>${t}</td></tr>`).join('')}
      </table>` : '')}

      <div class="p2-accept">
        <p>By signing below, the Client accepts this quotation and agrees to all terms and conditions outlined above. Please return a signed copy to ${myCompany.email || 'info@qualitygypsum.ca'} to confirm acceptance.</p>
        <div class="p2-sig-grid">
          <div><span class="p2-sig-lbl">Authorized Signature</span><div class="p2-sig-line"></div></div>
          <div><span class="p2-sig-lbl">Printed Name &amp; Title</span><div class="p2-sig-line"></div></div>
          <div><span class="p2-sig-lbl">Date</span><div class="p2-sig-line"></div></div>
        </div>
      </div>

      <div class="p2-footer">
        ${myCompany.name || 'Quality Gypsum Services Ltd.'} &nbsp;|&nbsp; ${myCompany.address || '85 Walgrove Rise SE, Calgary, AB T2X 4E9'} &nbsp;|&nbsp; ${myCompany.phone || '(403) 809-2908'} &nbsp;|&nbsp; ${myCompany.email || 'info@qualitygypsum.ca'} &nbsp;|&nbsp; ${myCompany.website || 'www.qualitygypsum.ca'}<br>
        <em>At Quality Gypsum, we don't just build walls ‚Äî we build relationships.</em>
      </div>
    </div>
  `;
}

function updatePreview() {
  const client         = document.getElementById('p-client')?.value || '';
  const clientEmail    = document.getElementById('p-client-email')?.value || '';
  const clientPhone    = document.getElementById('p-client-phone')?.value || '';
  const clientCompany  = document.getElementById('p-client-company')?.value || '';
  const clientCompanyEmail   = document.getElementById('p-client-company-email')?.value || '';
  const clientCompanyPhone   = document.getElementById('p-client-company-phone')?.value || '';
  const clientCompanyAddress = document.getElementById('p-client-company-address')?.value || '';
  const project        = document.getElementById('p-project')?.value || '';
  const dateVal        = document.getElementById('p-date')?.value || '';
  const addendum       = document.getElementById('p-addendum')?.value ?? '0';
  const drawingsDate   = document.getElementById('p-drawings-date')?.value || '';
  const scope          = document.getElementById('p-scope')?.value || '';
  const quoteValid     = document.getElementById('p-quote-valid')?.value || '45';
  const materialUntil  = document.getElementById('p-material-until')?.value || '';
  const footerNote     = document.getElementById('p-footer-note')?.value || '';
  const terms          = document.getElementById('p-terms')?.value || '';

  const fmtDate = (v) => {
    if (!v) return '‚Äî';
    const d = new Date(v + 'T00:00:00');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
  };

  // Auto-fill quote number if empty and date is set
  const quoteNumField = document.getElementById('p-quote-num');
  if (quoteNumField && !quoteNumField.value && dateVal) {
    const autoNum = 'QGS-' + dateVal.replace(/-/g,'').slice(2);
    quoteNumField.value = autoNum;
  }

  // Compute expiry date from quote date + valid days
  const expiryDate = (() => {
    if (!dateVal || !quoteValid) return '‚Äî';
    const d = new Date(dateVal + 'T00:00:00');
    d.setDate(d.getDate() + parseInt(quoteValid));
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
  })();

  // Quote number ‚Äî generate from date or use placeholder
  const quoteNum = dateVal
    ? 'QGS-' + dateVal.replace(/-/g,'').slice(2)
    : 'QGS-[QUOTE#]';

  const showItemsCheckbox = document.getElementById('p-show-items');
  const showItemsTrack    = document.getElementById('p-show-items-track');
  const showItemsThumb    = document.getElementById('p-show-items-thumb');
  const showItems = showItemsCheckbox ? showItemsCheckbox.checked : true;
  if (showItemsTrack) showItemsTrack.style.background = showItems ? 'var(--accent)' : 'var(--border)';
  if (showItemsThumb) showItemsThumb.style.transform  = showItems ? 'translateX(18px)' : 'translateX(0)';

  const grandTotal = proposalCategories.reduce((a,cat) => a + cat.items.reduce((b,li) => b+(li.qty*li.price),0), 0);
  const multiCat   = proposalCategories.length > 1;

  // ‚îÄ‚îÄ Logo / company block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const logoHtml = myCompany.logoDataUrl
    ? `<img src="${myCompany.logoDataUrl}" style="height:110px;max-width:160px;object-fit:contain;display:block;flex-shrink:0;">`
    : ``;

  // ‚îÄ‚îÄ Scope / pricing HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const categoriesHtml = proposalCategories.map((cat, ci) => {
    const catTotal    = cat.items.reduce((a,li) => a+(li.qty*li.price),0);
    const visibleItems = cat.items.filter(li => li.desc || li.price);
    const hasItems    = visibleItems.length > 0;
    const taxStr      = cat.taxLabel || '';

    if (!showItems) {
      return `
        <div style="display:flex;align-items:baseline;justify-content:space-between;padding:7px 0;border-bottom:1px solid #eee;">
          <div style="font-size:9.5pt;font-weight:700;color:#1a1a1a;text-transform:uppercase;letter-spacing:0.5px;">${cat.name || 'Category ' + (ci+1)}</div>
          <div style="font-size:9.5pt;font-weight:700;color:#1a1a1a;font-family:monospace;">${catTotal ? fmtFull(catTotal) + (taxStr ? ' ' + taxStr : '') : '‚Äî'}</div>
        </div>`;
    }

    return `
      <div style="margin-bottom:14px;page-break-inside:avoid;">
        <div style="background:#e8f0fa;border-left:3px solid #0066cc;padding:4px 10px;font-size:8.5pt;font-weight:700;color:#004499;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
          <span>${cat.name || 'Category ' + (ci+1)}</span>
          ${catTotal ? `<span style="font-family:monospace;">${fmtFull(catTotal)}${taxStr ? ' ' + taxStr : ''}</span>` : ''}
        </div>
        ${hasItems ? `
        <table style="width:100%;border-collapse:collapse;font-size:8.5pt;">
          <thead>
            <tr style="background:#f0f0f0;">
              <td style="padding:5px 10px;font-size:8pt;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:0.8px;border-bottom:1px solid #ddd;">Description</td>
              <td style="padding:5px 10px;font-size:8pt;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:0.8px;border-bottom:1px solid #ddd;width:40px;text-align:center;">Qty</td>
              <td style="padding:5px 10px;font-size:8pt;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:0.8px;border-bottom:1px solid #ddd;width:90px;text-align:right;">Unit Price</td>
              <td style="padding:5px 10px;font-size:8pt;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:0.8px;border-bottom:1px solid #ddd;width:90px;text-align:right;">Total</td>
            </tr>
          </thead>
          <tbody>
            ${visibleItems.map((li,i) => `
              <tr style="background:${i%2===0?'#fff':'#fafafa'};">
                <td style="padding:6px 10px;border-bottom:1px solid #eee;font-size:8.5pt;color:#1a1a1a;">${li.desc || '‚Äî'}</td>
                <td style="padding:6px 10px;border-bottom:1px solid #eee;font-size:8.5pt;color:#555;text-align:center;">${li.qty}</td>
                <td style="padding:6px 10px;border-bottom:1px solid #eee;font-size:8.5pt;color:#555;text-align:right;font-family:monospace;">${fmtFull(li.price)}</td>
                <td style="padding:6px 10px;border-bottom:1px solid #eee;font-size:8.5pt;font-weight:700;color:#1a1a1a;text-align:right;font-family:monospace;">${fmtFull(li.qty*li.price)}</td>
              </tr>`).join('')}
          </tbody>
        </table>` : ''}
      </div>`;
  }).join('');

  // Grand total row
  const totalRowHtml = grandTotal ? `
    <div style="background:#f0f6ff;border:2px solid #0066cc;border-radius:4px;padding:8px 14px;display:flex;justify-content:space-between;align-items:center;margin-top:${showItems?'8px':'4px'};">
      <div style="font-size:8pt;font-weight:700;color:#888;letter-spacing:1px;text-transform:uppercase;">${multiCat ? 'Grand Total' : (proposalCategories[0]?.name || 'Total Price')}</div>
      <div style="text-align:right;">
        <div style="font-size:22pt;font-weight:800;color:#0066cc;line-height:1;">${fmtFull(grandTotal)}${proposalCategories[0]?.taxLabel ? ' <span style="font-size:10pt;">+' + proposalCategories[0].taxLabel.replace(/^\+\s*/,'') + '</span>' : ''}</div>
        ${quoteValid ? `<div style="font-size:8pt;color:#888;margin-top:2px;">Quote valid for ${quoteValid} days from issue date</div>` : ''}
      </div>
    </div>` : '';

  // Build scope section only if there's a text description or line items
  const hasPricing = proposalCategories.some(c => c.name || c.items.some(li => li.desc || li.price));
  const scopeBlock = scope ? `
    <div style="background:#e8f0fa;border-left:3px solid #0066cc;padding:6px 12px;font-size:8.5pt;color:#333;line-height:1.6;margin-bottom:10px;">${scope.replace(/\n/g,'<br>')}</div>` : '';

  document.getElementById('preview-doc').innerHTML = `
    <style>
      .qgs-wrap * { box-sizing:border-box; margin:0; padding:0; }
      .qgs-wrap { font-family:Arial,Helvetica,sans-serif; font-size:9pt; color:#1a1a1a; background:#fff; }
      .qgs-header-line { height:3px; background:linear-gradient(90deg,#0066cc,#004499); margin-bottom:12px; border-radius:2px; }
      .qgs-info { display:grid; grid-template-columns:1fr 1fr; gap:0; margin-bottom:12px; border:1px solid #ddd; border-radius:4px; overflow:hidden; }
      .qgs-info-block { padding:10px 14px; }
      .qgs-info-block:first-child { border-right:1px solid #ddd; }
      .qgs-block-title { font-size:7pt; font-weight:700; color:#0066cc; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:6px; }
      .qgs-proj-name { font-size:12pt; font-weight:700; color:#1a1a1a; margin-bottom:6px; line-height:1.2; }
      .qgs-row { margin-bottom:4px; }
      .qgs-lbl { font-size:7pt; font-weight:600; color:#888; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:1px; }
      .qgs-val { font-size:9pt; color:#1a1a1a; }
      .qgs-val.hi { color:#0066cc; font-weight:600; }
      .qgs-sec { background:#1a1a1a; color:#fff; font-size:9pt; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; padding:6px 12px; margin-bottom:8px; margin-top:12px; border-radius:3px; }
      .qgs-footer { border-top:2px solid #0066cc; padding-top:6px; text-align:center; font-size:7.5pt; color:#888; line-height:1.7; margin-top:24px; }
    </style>
    <div class="qgs-wrap">

      <!-- HEADER -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">

        <!-- LEFT: Logo + Company name + tagline + contact -->
        <div style="flex:1;display:flex;align-items:flex-start;gap:10px;">
          ${logoHtml}
          <div>
            <div style="font-size:11pt;font-weight:800;color:#0066cc;line-height:1;letter-spacing:0.3px;margin-bottom:2px;">${myCompany.name || 'Quality Gypsum Services Ltd'}</div>
            <div style="font-size:6.5pt;color:#888;letter-spacing:1.2px;text-transform:uppercase;margin-bottom:5px;">Best Ideas ¬∑ Best Solutions ¬∑ Best Results</div>
            <div style="font-size:7.5pt;color:#555;line-height:1.7;">
              ${myCompany.website ? myCompany.website.replace(/https?:\/\//,'') : 'www.qualitygypsum.ca'} &nbsp;|&nbsp; ${myCompany.email || 'info@qualitygypsum.ca'} &nbsp;|&nbsp; ${myCompany.phone || '(403) 809-2908'}<br>
              ${myCompany.address || '85 Walgrove Rise SE, Calgary, AB T2X 4E9'}
            </div>
          </div>
        </div>

        <!-- RIGHT: QUOTATION + meta -->
        <div style="text-align:right;flex-shrink:0;min-width:180px;">
          <div style="font-size:22pt;font-weight:800;color:#0066cc;letter-spacing:3px;line-height:1;margin-bottom:6px;">QUOTATION</div>
          <table style="margin-left:auto;border-collapse:collapse;">
            <tr><td style="padding:1px 0 1px 12px;font-size:8.5pt;color:#555;text-align:right;">Quote #:&nbsp;<strong style="color:#1a1a1a;">${quoteNum}</strong></td></tr>
            <tr><td style="padding:1px 0 1px 12px;font-size:8.5pt;color:#555;text-align:right;">Date:&nbsp;<strong style="color:#1a1a1a;">${fmtDate(dateVal)}</strong></td></tr>
            <tr><td style="padding:1px 0 1px 12px;font-size:8.5pt;color:#555;text-align:right;">Estimate By:&nbsp;<strong style="color:#1a1a1a;">${myCompany.contactName || 'Fabian Vargas Garcia'}</strong></td></tr>
            ${quoteValid ? `<tr><td style="padding:1px 0 1px 12px;font-size:8.5pt;color:#0066cc;font-weight:600;text-align:right;">Valid Until:&nbsp;<strong>${expiryDate}</strong></td></tr>` : ''}
          </table>
        </div>
      </div>
      <div class="qgs-header-line"></div>

      <!-- PROJECT + CLIENT INFO GRID -->
      <div class="qgs-info">
        <div class="qgs-info-block">
          <div class="qgs-block-title">Project Information</div>
          <div class="qgs-proj-name">${project || '[Project Name]'}</div>
          <div class="qgs-row"><span class="qgs-lbl">Drawings / Specs Date</span><span class="qgs-val">${fmtDate(drawingsDate)}</span></div>
          <div class="qgs-row"><span class="qgs-lbl">Addendum Received</span><span class="qgs-val">${addendum || '0'}</span></div>
          ${materialUntil ? `<div class="qgs-row"><span class="qgs-lbl">Material Pricing Held Until</span><span class="qgs-val hi">${materialUntil}</span></div>` : ''}
        </div>
        <div class="qgs-info-block">
          <div class="qgs-block-title">Submitted To</div>
          <div class="qgs-proj-name">${clientCompany || '[General Contractor]'}</div>
          ${client ? `<div class="qgs-row"><span class="qgs-lbl">Attention</span><span class="qgs-val">${client}</span></div>` : ''}
          ${clientEmail || clientCompanyEmail ? `<div class="qgs-row"><span class="qgs-lbl">Email</span><span class="qgs-val">${clientEmail || clientCompanyEmail}</span></div>` : ''}
          ${clientPhone || clientCompanyPhone ? `<div class="qgs-row"><span class="qgs-lbl">Phone</span><span class="qgs-val">${clientPhone || clientCompanyPhone}</span></div>` : ''}
          ${clientCompanyAddress ? `<div class="qgs-row"><span class="qgs-lbl">Address</span><span class="qgs-val">${clientCompanyAddress}</span></div>` : ''}
        </div>
      </div>

      <!-- TOTAL PRICE BOX (always shown when there's a total) -->
      ${totalRowHtml}

      <!-- SCOPE / PRICING -->
      ${(hasPricing || scope) ? `<div class="qgs-sec" style="margin-top:12px;">Scope of Work</div>` : ''}
      ${scopeBlock}
      ${hasPricing ? categoriesHtml : ''}

      ${(terms) ? `
      <div class="qgs-sec">Additional Terms</div>
      <div style="font-size:8.5pt;color:#444;line-height:1.7;">${terms.replace(/\n/g,'<br>')}</div>` : ''}

      <!-- FOOTER -->
      <div class="qgs-footer">
        ${myCompany.name || 'Quality Gypsum Services Ltd.'} &nbsp;|&nbsp; ${myCompany.address || '85 Walgrove Rise SE, Calgary, AB T2X 4E9'} &nbsp;|&nbsp; ${myCompany.phone || '(403) 809-2908'} &nbsp;|&nbsp; ${myCompany.email || 'info@qualitygypsum.ca'} &nbsp;|&nbsp; ${myCompany.website ? myCompany.website.replace(/https?:\/\//,'') : 'www.qualitygypsum.ca'}<br>
        <em>At Quality Gypsum, we don't just build walls ‚Äî we build relationships.</em>
      </div>

    </div>
  `;
}

// ============ QUOTE SAVE / LOAD / EXPORT ============

function getQuoteFormState() {
  return {
    quoteNum:      document.getElementById('p-quote-num')?.value || '',
    quoteLabel:    document.getElementById('p-quote-label')?.value || '',
    client:        document.getElementById('p-client')?.value || '',
    clientEmail:   document.getElementById('p-client-email')?.value || '',
    clientPhone:   document.getElementById('p-client-phone')?.value || '',
    clientCompany: document.getElementById('p-client-company')?.value || '',
    clientCompanyEmail:   document.getElementById('p-client-company-email')?.value || '',
    clientCompanyPhone:   document.getElementById('p-client-company-phone')?.value || '',
    clientCompanyAddress: document.getElementById('p-client-company-address')?.value || '',
    project:       document.getElementById('p-project')?.value || '',
    dateVal:       document.getElementById('p-date')?.value || '',
    addendum:      document.getElementById('p-addendum')?.value || '0',
    drawingsDate:  document.getElementById('p-drawings-date')?.value || '',
    scope:         document.getElementById('p-scope')?.value || '',
    quoteValid:    document.getElementById('p-quote-valid')?.value || '',
    materialUntil: document.getElementById('p-material-until')?.value || '',
    footerNote:    document.getElementById('p-footer-note')?.value || '',
    terms:         document.getElementById('p-terms')?.value || '',
    showItems:     document.getElementById('p-show-items')?.checked ?? true,
    categories:    JSON.parse(JSON.stringify(proposalCategories)),
    p2Inclusions:  document.getElementById('p2-inclusions')?.value || '',
    p2Exclusions:  document.getElementById('p2-exclusions')?.value || '',
    p2Hourly:      document.getElementById('p2-hourly')?.value || '',
    p2Terms:       document.getElementById('p2-terms')?.value || '',
    savedAt:       new Date().toISOString(),
  };
}

function loadQuoteFormState(q) {
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  set('p-quote-num',              q.quoteNum || '');
  set('p-quote-label',            q.quoteLabel || '');
  set('p-client',                 q.client || '');
  set('p-client-email',           q.clientEmail || '');
  set('p-client-phone',           q.clientPhone || '');
  set('p-client-company',         q.clientCompany || '');
  set('p-client-company-email',   q.clientCompanyEmail || '');
  set('p-client-company-phone',   q.clientCompanyPhone || '');
  set('p-client-company-address', q.clientCompanyAddress || '');
  set('p-project',                q.project || '');
  set('p-date',                   q.dateVal || '');
  set('p-addendum',               q.addendum || '0');
  set('p-drawings-date',          q.drawingsDate || '');
  set('p-scope',                  q.scope || '');
  set('p-quote-valid',            q.quoteValid || '');
  set('p-material-until',         q.materialUntil || '');
  set('p-footer-note',            q.footerNote || '');
  set('p-terms',                  q.terms || '');
  set('p2-inclusions',            q.p2Inclusions || '');
  set('p2-exclusions',            q.p2Exclusions || '');
  set('p2-hourly',                q.p2Hourly || '');
  set('p2-terms',                 q.p2Terms || '');
  const cb = document.getElementById('p-show-items');
  if (cb) cb.checked = q.showItems ?? true;
  // Restore categories
  catNextId = 1;
  catLiNextId = 100;
  proposalCategories = q.categories ? JSON.parse(JSON.stringify(q.categories)) : [];
  // Re-sync IDs to avoid collisions
  proposalCategories.forEach(c => {
    if (c.id >= catNextId) catNextId = c.id + 1;
    c.items.forEach(li => { if (li.id >= catLiNextId) catLiNextId = li.id + 1; });
  });
  renderCategoriesUI();
  updatePreview();
  updatePreview2();
}

function getSavedQuotes() {
  try { return JSON.parse(localStorage.getItem('qgs_saved_quotes') || '[]'); }
  catch(e) { return []; }
}

function setSavedQuotes(arr) {
  localStorage.setItem('qgs_saved_quotes', JSON.stringify(arr));
}

function saveCurrentQuote() {
  const state = getQuoteFormState();
  const label = state.quoteLabel || state.quoteNum || state.project || 'Untitled Quote';
  if (!state.project && !state.quoteNum && !state.quoteLabel) {
    showToast('Add a project name or quote # before saving');
    return;
  }
  const quotes = getSavedQuotes();
  // Replace existing if same quoteNum, else push
  const idx = state.quoteNum ? quotes.findIndex(q => q.quoteNum === state.quoteNum) : -1;
  if (idx >= 0) {
    quotes[idx] = state;
    showToast(`Quote "${label}" updated`);
  } else {
    quotes.unshift(state);
    showToast(`Quote "${label}" saved`);
  }
  setSavedQuotes(quotes);
  renderSavedQuotesList();
}

function deleteQuote(idx) {
  const quotes = getSavedQuotes();
  const label  = quotes[idx]?.quoteLabel || quotes[idx]?.quoteNum || quotes[idx]?.project || 'Quote';
  quotes.splice(idx, 1);
  setSavedQuotes(quotes);
  renderSavedQuotesList();
  showToast(`"${label}" deleted`);
}

function loadQuote(idx) {
  const quotes = getSavedQuotes();
  const q = quotes[idx];
  if (!q) return;
  loadQuoteFormState(q);
  toggleSavedQuotesPanel();
  showToast(`Loaded: ${q.quoteLabel || q.quoteNum || q.project}`);
}

function toggleSavedQuotesPanel() {
  const panel = document.getElementById('saved-quotes-panel');
  const isOpen = panel.style.display !== 'none' && panel.style.display !== '';
  panel.style.display = isOpen ? 'none' : 'flex';
  panel.style.flexDirection = 'column';
  if (!isOpen) renderSavedQuotesList();
}

function renderSavedQuotesList() {
  const el = document.getElementById('saved-quotes-list');
  if (!el) return;
  const quotes = getSavedQuotes();
  if (!quotes.length) {
    el.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:12px;">
      <div style="font-size:28px;margin-bottom:10px;">üìã</div>
      No saved quotes yet.<br>Fill out the form and click <strong>Save Quote</strong>.
    </div>`;
    return;
  }
  el.innerHTML = quotes.map((q, i) => {
    const label    = q.quoteLabel || q.quoteNum || q.project || 'Untitled Quote';
    const subLabel = [q.quoteNum, q.project].filter(Boolean).join(' ¬∑ ');
    const client   = q.clientCompany || q.client || '‚Äî';
    const savedAt  = q.savedAt ? new Date(q.savedAt).toLocaleDateString('en-CA', {month:'short',day:'numeric',year:'numeric'}) : '';
    const total    = (q.categories || []).reduce((a,c) => a + c.items.reduce((b,li) => b+(li.qty*li.price),0), 0);
    return `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
          <div style="font-size:13px;font-weight:700;color:var(--text);line-height:1.3;flex:1;margin-right:8px;">${label}</div>
          <div style="display:flex;gap:4px;flex-shrink:0;">
            <button onclick="loadQuote(${i})" style="background:var(--accent);color:#000;border:none;border-radius:4px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;">Load</button>
            <button onclick="deleteQuote(${i})" style="background:transparent;color:var(--lost);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">‚úï</button>
          </div>
        </div>
        ${subLabel ? `<div style="font-size:10px;color:var(--muted);margin-bottom:3px;">${subLabel}</div>` : ''}
        <div style="display:flex;gap:12px;font-size:11px;color:var(--muted);">
          <span>üè¢ ${client}</span>
          ${total ? `<span style="color:var(--accent);font-weight:600;">$${total.toLocaleString()}</span>` : ''}
          ${savedAt ? `<span>üíæ ${savedAt}</span>` : ''}
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Export PDF ‚Äî uses Blob + hidden iframe print ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportProposalPDF() {
  updatePreview();
  updatePreview2();

  var page1Html = document.getElementById('preview-doc').innerHTML;
  var page2Html = document.getElementById('preview-doc-2').innerHTML;

  var p2i = document.getElementById('p2-inclusions')?.value || '';
  var p2e = document.getElementById('p2-exclusions')?.value || '';
  var p2h = document.getElementById('p2-hourly')?.value || '';
  var p2t = document.getElementById('p2-terms')?.value || '';
  var hasPage2 = p2i || p2e || p2h || p2t;

  var projName = document.getElementById('p-project')?.value || 'Quote';
  var quoteNum = document.getElementById('p-quote-num')?.value || '';
  var fileName = [quoteNum, projName].filter(Boolean).join(' \u2014 ');

  var printCSS = `
    * { box-sizing:border-box; margin:0; padding:0; }
    @page { size: letter portrait; margin: 10mm 12mm; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 9pt;
      color: #1a1a1a;
      background: #fff;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }
    .print-page { width:100%; padding: 5mm 0; }
    .print-page + .print-page { page-break-before:always; break-before:page; }
    [style*="background"] { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    table { border-collapse:collapse; }
    img { max-width:100%; }
  `;

  var fullHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + fileName + '</title><style>' + printCSS + '</style></head><body>';
  fullHtml += '<div class="print-page">' + page1Html + '</div>';
  if (hasPage2) fullHtml += '<div class="print-page">' + page2Html + '</div>';
  fullHtml += '<scr' + 'ipt>document.title="' + fileName.replace(/"/g,'\\"') + '"; window.onafterprint=function(){window.close();}; setTimeout(function(){window.print();},500);</scr' + 'ipt>';
  fullHtml += '</body></html>';

  var blob = new Blob([fullHtml], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  var w = window.open(url, '_blank');

  if (!w) {
    // Popup blocked - try iframe approach
    var iframe = document.createElement('iframe');
    iframe.style.cssText = 'position:fixed;left:-9999px;width:0;height:0;';
    iframe.srcdoc = fullHtml;
    document.body.appendChild(iframe);
    iframe.onload = function() {
      try { iframe.contentWindow.print(); } catch(e) { console.error(e); }
      setTimeout(function() { document.body.removeChild(iframe); }, 2000);
    };
    showToast('Print dialog opening...');
  } else {
    showToast('Print dialog opening \u2014 choose "Save as PDF" as the printer');
  }
}

// Legacy alias
function printProposal() { exportProposalPDF(); }




// ============ TOAST ============
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = '‚úì  ' + msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ============ INIT ============
renderDashboard();
setTimeout(() => renderCompanyList(), 0);
// Fire preview once proposal modal content is ready (pre-loads company data into preview on first open)
setTimeout(() => { renderMyLogoPreview(); }, 100);
</script>
<script>
// ============================
// SUPABASE CLOUD ADDON - AUTO-INJECTED
// ============================
(function() {
  // Show auth overlay immediately
  const overlay = document.createElement('div');
  overlay.id = 'auth-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:#0f0f0f;z-index:10000;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = '<div style="background:#1a1a1a;border:1px solid #2e2e2e;border-radius:12px;padding:40px;width:380px;max-width:90vw;text-align:center;"><div style="font-family:Bebas Neue,sans-serif;font-size:32px;letter-spacing:3px;color:#f5a623;margin-bottom:4px;">ConstructBid</div><div style="font-size:11px;color:#888;letter-spacing:2px;text-transform:uppercase;margin-bottom:28px;">Loading cloud services...</div><div style="color:#888;font-size:13px;">Please wait...</div></div>';
  document.body.insertBefore(overlay, document.body.firstChild);

  // Load Supabase SDK
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  s.onload = function() { initCloudAddon(); };
  s.onerror = function() { overlay.querySelector('div > div:last-child').innerHTML = '<div style="color:#e8391d;">Failed to load. Check internet and refresh.</div>'; };
  document.head.appendChild(s);
})();

function initCloudAddon() {
  var ov = document.getElementById('auth-overlay');
  ov.innerHTML = '<div style="background:#1a1a1a;border:1px solid #2e2e2e;border-radius:12px;padding:40px;width:380px;max-width:90vw;text-align:center;"><div style="font-family:Bebas Neue,sans-serif;font-size:32px;letter-spacing:3px;color:#f5a623;margin-bottom:4px;">ConstructBid</div><div style="font-size:11px;color:#888;letter-spacing:2px;text-transform:uppercase;margin-bottom:28px;">Sign in to continue</div><div id="auth-error" style="display:none;background:rgba(232,57,29,0.1);border:1px solid #e8391d;color:#e8391d;border-radius:6px;padding:8px 12px;font-size:12px;margin-bottom:14px;text-align:left;"></div><div id="auth-message" style="font-size:12px;margin-bottom:14px;"></div><input type="email" id="auth-email" placeholder="Email" style="width:100%;background:#242424;border:1px solid #2e2e2e;color:#f0ede8;padding:10px 14px;border-radius:6px;font-size:13px;margin-bottom:10px;outline:none;font-family:DM Sans,sans-serif;"><input type="password" id="auth-password" placeholder="Password (min 6 chars)" onkeydown="if(event.key===\'Enter\')signIn()" style="width:100%;background:#242424;border:1px solid #2e2e2e;color:#f0ede8;padding:10px 14px;border-radius:6px;font-size:13px;margin-bottom:16px;outline:none;font-family:DM Sans,sans-serif;"><div style="display:flex;gap:10px;"><button class="btn btn-primary" onclick="signIn()" style="flex:1;padding:10px;">Sign In</button><button class="btn btn-ghost" onclick="signUp()" style="flex:1;padding:10px;">Sign Up</button></div><div style="margin-top:16px;font-size:11px;color:#888;">Data stored securely via Supabase</div></div>';

  // Update logo
  var ls = document.querySelector('.logo-sub');
  if (ls) ls.innerHTML = 'Bid Tracker Pro &middot; <span style="color:#2ecc71;">Cloud &#9729;</span>';

  // Add sidebar items
  var nav = document.querySelector('.nav');
  if (nav) {
    var d = document.createElement('div');
    d.innerHTML = '<div style="border-top:1px solid #2e2e2e;margin:8px 0;"></div><div style="padding:4px 20px;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:4px;">Data</div><div class="nav-item" onclick="exportBackup()"><span class="nav-icon">&#128190;</span> Export Backup</div><div class="nav-item" onclick="openTeamModal()"><span class="nav-icon">&#128101;</span> Manage Team</div>';
    nav.appendChild(d);
  }

  // Add team modal + save indicator
  var toast = document.getElementById('toast');
  if (toast) {
    var tm = document.createElement('div');
    tm.innerHTML = '<div class="modal-overlay" id="team-modal"><div class="modal"><div class="modal-header"><div class="modal-title">Manage Team Members</div><button class="modal-close" onclick="closeTeamModal()">&times;</button></div><div class="modal-body"><div id="team-list-manage" style="margin-bottom:16px;"></div><div style="border-top:1px solid #2e2e2e;padding-top:16px;"><div class="form-grid"><div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="tm-name" placeholder="e.g. John Doe"></div><div class="form-group"><label class="form-label">Initials *</label><input type="text" class="form-input" id="tm-initials" placeholder="JD" maxlength="3"></div><div class="form-group"><label class="form-label">Color</label><input type="color" class="form-input" id="tm-color" value="#3b82f6" style="height:38px;cursor:pointer;"></div><div class="form-group" style="display:flex;align-items:flex-end;"><button class="btn btn-primary" onclick="addTeamMember()" style="width:100%;">+ Add</button></div></div></div></div><div class="modal-footer"><button class="btn btn-ghost" onclick="closeTeamModal()">Close</button></div></div></div><div id="save-indicator" style="position:fixed;bottom:24px;left:24px;background:#1a1a1a;border:1px solid #2e2e2e;border-radius:20px;padding:6px 14px;font-size:11px;color:#2ecc71;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;">&#9729; Saved to cloud</div>';
    toast.parentElement.insertBefore(tm, toast);
  }

  // Run the integration
  setupSupabase();
}

function openTeamModal(){renderTeamList();document.getElementById('team-modal').classList.add('open');}
function closeTeamModal(){document.getElementById('team-modal').classList.remove('open');}
function renderTeamList(){var e=document.getElementById('team-list-manage');if(!e)return;if(!teamMembers.length){e.innerHTML='<div style="color:#888;font-size:13px;text-align:center;padding:20px;">No team members yet. Add one below.</div>';return;}e.innerHTML=teamMembers.map(function(m,i){return '<div style="display:flex;align-items:center;gap:12px;padding:10px;background:#242424;border:1px solid #2e2e2e;border-radius:6px;margin-bottom:8px;"><div style="width:36px;height:36px;border-radius:50%;background:'+(m.color||'#3b82f6')+'20;color:'+(m.color||'#3b82f6')+';display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;">'+m.initials+'</div><div style="flex:1;"><div style="font-size:13px;font-weight:600;">'+m.name+'</div><div style="font-size:11px;color:#888;">'+m.initials+'</div></div><button onclick="removeTeamMember('+i+')" style="background:none;border:1px solid #e8391d;color:#e8391d;border-radius:4px;padding:4px 10px;font-size:11px;cursor:pointer;">Remove</button></div>';}).join('');}

function setupSupabase() {

// ============================
// SUPABASE CONFIG
// ============================
const SUPABASE_URL = 'https://eymrvlmmmhnvjfaiyxeo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5bXJ2bG1tbWhudmpmYWl5eGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Nzc2NzksImV4cCI6MjA4NzU1MzY3OX0.sVbk5jcXmfSETl-nh-lsYMXoi0bLuq3pV1PB_Q763Y4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

// ============================
// AUTH
// ============================
async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    document.getElementById('auth-overlay').style.display = 'none';
    await loadAllFromDB();
    renderDashboard();
    renderCompanyList();
    updateSidebarTeam();
    renderMyLogoPreview();
  } else {
    document.getElementById('auth-overlay').style.display = 'flex';
  }
}

async function signUp() {
  const email = document.getElementById('auth-email').value.trim();
  const pw = document.getElementById('auth-password').value;
  if (!email || !pw) { showAuthError('Email and password required'); return; }
  if (pw.length < 6) { showAuthError('Password must be at least 6 characters'); return; }
  const { data, error } = await supabase.auth.signUp({ email, password: pw });
  if (error) { showAuthError(error.message); return; }
  document.getElementById('auth-message').textContent = 'Check your email to confirm, then sign in!';
  document.getElementById('auth-message').style.color = 'var(--green)';
}

async function signIn() {
  const email = document.getElementById('auth-email').value.trim();
  const pw = document.getElementById('auth-password').value;
  if (!email || !pw) { showAuthError('Email and password required'); return; }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password: pw });
  if (error) { showAuthError(error.message); return; }
  currentUser = data.user;
  document.getElementById('auth-overlay').style.display = 'none';
  await loadAllFromDB();
  if (!bids.length && !companies.length) await seedDefaultData();
  renderDashboard(); renderCompanyList(); updateSidebarTeam(); renderMyLogoPreview();
  showToast('Signed in!');
}

async function signOut() { await supabase.auth.signOut(); currentUser = null; location.reload(); }

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  if (el) { el.textContent = msg; el.style.display = msg ? 'block' : 'none'; }
}

// ============================
// LOAD FROM DB
// ============================
async function loadAllFromDB() {
  try {
    const { data: bidRows } = await supabase.from('bids').select('*').order('id', { ascending: true });
    if (bidRows) bids = bidRows.map(r => ({
      id: r.id, name: r.name, status: r.status, value: parseFloat(r.value)||0,
      contact: r.contact_name||'', company: r.company_name||'',
      contactCompanyId: r.company_id, contactPersonId: r.contact_id,
      due: r.due_date||'', construction: r.construction_date||'',
      notes: r.notes||'', files: [], assigned: r.assigned||[],
    }));

    const { data: fileRows } = await supabase.from('bid_files').select('*');
    if (fileRows) fileRows.forEach(f => {
      const bid = bids.find(b => b.id === f.bid_id);
      if (bid) bid.files.push({ name: f.file_name, size: f.file_size, type: f.file_type });
    });

    const { data: coRows } = await supabase.from('companies').select('*').order('name');
    if (coRows) companies = coRows.map(r => ({
      id: r.id, name: r.name, email: r.email||'', phone: r.phone||'',
      address: r.address||'', notes: r.notes||'', persons: [],
    }));

    const { data: contactRows } = await supabase.from('contacts').select('*').order('first_name');
    if (contactRows) contactRows.forEach(r => {
      const co = companies.find(c => c.id === r.company_id);
      if (co) co.persons.push({
        id: r.id, first: r.first_name, last: r.last_name||'',
        role: r.role||'Other', email: r.email||'', phone: r.phone||'', notes: r.notes||'',
      });
    });

    const { data: tmRows } = await supabase.from('team_members').select('*');
    if (tmRows && tmRows.length) {
      teamMembers.length = 0;
      tmRows.forEach(r => teamMembers.push({
        id: r.initials, initials: r.initials, name: r.name,
        color: r.color||'#3b82f6', bg: (r.color||'#3b82f6')+'20', dbId: r.id,
      }));
    }

    const { data: mcRows } = await supabase.from('my_company').select('*').limit(1);
    if (mcRows && mcRows.length) {
      const mc = mcRows[0];
      Object.assign(myCompany, {
        name: mc.name||myCompany.name, address: mc.address||myCompany.address,
        website: mc.website||myCompany.website, phone: mc.phone||myCompany.phone,
        email: mc.email||myCompany.email, contactName: mc.contact_name||myCompany.contactName,
        logoDataUrl: mc.logo_data_url||'', inclusions: mc.inclusions||myCompany.inclusions,
        exclusions: mc.exclusions||myCompany.exclusions, hourlyRates: mc.hourly_rates||myCompany.hourlyRates,
        termsAndConditions: mc.terms_and_conditions||myCompany.termsAndConditions, _dbId: mc.id,
      });
    }

    nextId = Math.max(nextId, ...bids.map(b=>b.id), ...companies.map(c=>c.id)) + 1;
    console.log('[CB] Loaded:', bids.length, 'bids,', companies.length, 'companies');
  } catch(err) { console.error('[CB] Load error:', err); }
}

async function seedDefaultData() {
  await supabase.from('my_company').insert({
    name: myCompany.name, address: myCompany.address, website: myCompany.website,
    phone: myCompany.phone, email: myCompany.email, contact_name: myCompany.contactName,
    inclusions: myCompany.inclusions, exclusions: myCompany.exclusions,
    hourly_rates: myCompany.hourlyRates, terms_and_conditions: myCompany.termsAndConditions,
  });
  for (const m of teamMembers) {
    await supabase.from('team_members').insert({ initials: m.initials, name: m.name, color: m.color });
  }
}

// ============================
// DB WRITE HELPERS
// ============================
async function dbSaveBid(d, eid) {
  const row = { name:d.name, status:d.status, value:d.value||0, contact_name:d.contact||'',
    company_name:d.company||'', company_id:d.contactCompanyId||null, contact_id:d.contactPersonId||null,
    due_date:d.due||null, construction_date:d.construction||null, notes:d.notes||'', assigned:d.assigned||[] };
  if (eid) { await supabase.from('bids').update(row).eq('id',eid); return eid; }
  const { data } = await supabase.from('bids').insert(row).select('id').single();
  return data?.id;
}
async function dbDeleteBid(id) { await supabase.from('bids').delete().eq('id',id); }
async function dbUpdateBidStatus(id,s) { await supabase.from('bids').update({status:s}).eq('id',id); }
async function dbUpdateBidAssigned(id,a) { await supabase.from('bids').update({assigned:a}).eq('id',id); }

async function dbSaveCompany(d,eid) {
  const row = { name:d.name, email:d.email||'', phone:d.phone||'', address:d.address||'', notes:d.notes||'' };
  if (eid) { await supabase.from('companies').update(row).eq('id',eid); return eid; }
  const { data } = await supabase.from('companies').insert(row).select('id').single();
  return data?.id;
}
async function dbDeleteCompany(id) { await supabase.from('companies').delete().eq('id',id); }

async function dbSavePerson(cid,d,eid) {
  const row = { company_id:cid, first_name:d.first, last_name:d.last||'', role:d.role||'Other', email:d.email||'', phone:d.phone||'', notes:d.notes||'' };
  if (eid) { await supabase.from('contacts').update(row).eq('id',eid); return eid; }
  const { data } = await supabase.from('contacts').insert(row).select('id').single();
  return data?.id;
}
async function dbDeletePerson(id) { await supabase.from('contacts').delete().eq('id',id); }

async function dbSaveMyCompany() {
  const row = { name:myCompany.name, address:myCompany.address, website:myCompany.website,
    phone:myCompany.phone, email:myCompany.email, contact_name:myCompany.contactName,
    logo_data_url:myCompany.logoDataUrl||'', inclusions:myCompany.inclusions,
    exclusions:myCompany.exclusions, hourly_rates:myCompany.hourlyRates,
    terms_and_conditions:myCompany.termsAndConditions };
  if (myCompany._dbId) await supabase.from('my_company').update(row).eq('id',myCompany._dbId);
  else { const {data}=await supabase.from('my_company').insert(row).select('id').single(); if(data)myCompany._dbId=data.id; }
}

async function dbAddTeamMember(m) {
  const {data}=await supabase.from('team_members').insert({initials:m.initials,name:m.name,color:m.color}).select('id').single();
  return data?.id;
}
async function dbRemoveTeamMember(dbId) { if(dbId) await supabase.from('team_members').delete().eq('id',dbId); }

// ============================
// OVERRIDE CORE FUNCTIONS
// ============================
const _oSaveBid = saveBid;
saveBid = async function() {
  const name = document.getElementById('bid-name').value.trim();
  if (!name) { alert('Project name is required.'); return; }
  const d = { name, status:document.getElementById('bid-status').value,
    value:parseFloat(document.getElementById('bid-value').value)||0,
    contact:document.getElementById('bid-contact').value.trim(),
    company:document.getElementById('bid-company').value.trim(),
    due:document.getElementById('bid-due').value, construction:document.getElementById('bid-construction').value,
    notes:document.getElementById('bid-notes').value.trim(), files:[...pendingFiles], assigned:[...modalAssigned],
    contactPersonId:parseInt(document.getElementById('bid-contact-select').value)||null,
    contactCompanyId:parseInt(document.getElementById('bid-company-select').value)||null };
  if (editingBidId) { await dbSaveBid(d,editingBidId); const i=bids.findIndex(b=>b.id===editingBidId); bids[i]={...bids[i],...d}; showToast('Bid updated!'); }
  else { const nid=await dbSaveBid(d); d.id=nid; bids.unshift(d); showToast('Bid added!'); }
  closeBidModal(); renderBidsTable(); renderDashboard();
};

const _oDeleteBid = deleteBid;
deleteBid = async function(id) { if(!confirm('Delete this bid?'))return; await dbDeleteBid(id); bids=bids.filter(b=>b.id!==id); renderBidsTable(); renderDashboard(); showToast('Bid deleted.'); };

const _oQSC = quickStatusChange;
quickStatusChange = async function(bidId,sel) {
  const bid=bids.find(b=>b.id===bidId); if(!bid)return;
  bid.status=sel.value; sel.className='status-select sel-'+sel.value;
  const cm={estimating:'var(--estimating)',pending:'var(--pending)',won:'var(--won)',lost:'var(--lost)'};
  const dot=sel.parentElement.querySelector('.status-dot'); if(dot)dot.style.background=cm[sel.value];
  await dbUpdateBidStatus(bidId,bid.status); renderDashboard(); showToast('Status \\u2192 '+statusLabel(bid.status));
};

const _oTA = toggleAssign;
toggleAssign = async function(mid) {
  if(!assignPopupBidId)return; const bid=bids.find(b=>b.id===assignPopupBidId); if(!bid)return;
  if(!bid.assigned)bid.assigned=[]; if(bid.assigned.includes(mid))bid.assigned=bid.assigned.filter(x=>x!==mid); else bid.assigned.push(mid);
  const chk=document.getElementById('acheck-'+mid);
  if(chk){const c=bid.assigned.includes(mid);chk.className='assign-member-check'+(c?' checked':'');chk.textContent=c?'\\u2713':'';}
  await dbUpdateBidAssigned(bid.id,bid.assigned); renderBidsTable(); renderDashboard();
};

const _oSC = saveCompany;
saveCompany = async function() {
  const name=document.getElementById('co-name').value.trim(); if(!name){alert('Company name required.');return;}
  const d={name,email:document.getElementById('co-email').value.trim(),phone:document.getElementById('co-phone').value.trim(),
    address:document.getElementById('co-address').value.trim(),notes:document.getElementById('co-notes').value.trim()};
  if(editingCompanyId){await dbSaveCompany(d,editingCompanyId);const co=companies.find(c=>c.id===editingCompanyId);Object.assign(co,d);showToast('Company updated!');}
  else{const nid=await dbSaveCompany(d);companies.push({id:nid,...d,persons:[]});showToast('Company added!');}
  closeAddCompanyModal(); renderContacts(); if(editingCompanyId)renderCompanyDetail(editingCompanyId);
};

const _oDC = deleteCompany;
deleteCompany = async function(id) {
  if(!confirm('Delete company and contacts?'))return; await dbDeleteCompany(id);
  companies=companies.filter(c=>c.id!==id); selectedCompanyId=null;
  document.getElementById('add-contact-btn').style.display='none';
  document.getElementById('company-detail-panel').innerHTML='<div class="company-detail-empty"><div style="font-size:48px;">\\u{1F3E2}</div><div style="font-size:14px;">Select a company</div></div>';
  renderCompanyList(); showToast('Company deleted.');
};

const _oSP = savePerson;
savePerson = async function() {
  const first=document.getElementById('p-first').value.trim(); if(!first){alert('First name required.');return;}
  const co=companies.find(c=>c.id===selectedCompanyId); if(!co)return;
  const d={first,last:document.getElementById('p-last').value.trim(),role:document.getElementById('p-role').value,
    email:document.getElementById('p-email').value.trim(),phone:document.getElementById('p-phone').value.trim(),
    notes:document.getElementById('p-notes').value.trim()};
  if(editingPersonId){await dbSavePerson(co.id,d,editingPersonId);const i=co.persons.findIndex(p=>p.id===editingPersonId);co.persons[i]={...co.persons[i],...d};showToast('Contact updated!');}
  else{const nid=await dbSavePerson(co.id,d);d.id=nid;co.persons.push(d);showToast('Contact added!');}
  closeAddPersonModal(); renderCompanyList(); renderCompanyDetail(selectedCompanyId);
};

const _oDP = deletePerson;
deletePerson = async function(cid,pid) {
  if(!confirm('Delete this contact?'))return; await dbDeletePerson(pid);
  const co=companies.find(c=>c.id===cid); co.persons=co.persons.filter(p=>p.id!==pid);
  renderCompanyList(); renderCompanyDetail(cid); showToast('Contact deleted.');
};

const _oSMC = saveMyCompany;
saveMyCompany = async function() {
  myCompany.name=document.getElementById('my-name').value.trim();
  myCompany.address=document.getElementById('my-address').value.trim();
  myCompany.website=document.getElementById('my-website').value.trim();
  myCompany.phone=document.getElementById('my-phone').value.trim();
  myCompany.email=document.getElementById('my-email').value.trim();
  myCompany.contactName=document.getElementById('my-contact-name').value.trim();
  myCompany.inclusions=document.getElementById('my-inclusions').value.trim();
  myCompany.exclusions=document.getElementById('my-exclusions').value.trim();
  myCompany.hourlyRates=document.getElementById('my-hourly-rates').value.trim();
  myCompany.termsAndConditions=document.getElementById('my-terms').value.trim();
  await dbSaveMyCompany(); closeMyCompanyModal(); updatePreview(); updatePreview2(); showToast('Company info saved!');
};

// Team overrides
addTeamMember = async function() {
  const name=document.getElementById('tm-name')?.value.trim();
  const initials=document.getElementById('tm-initials')?.value.trim().toUpperCase();
  const color=document.getElementById('tm-color')?.value||'#3b82f6';
  if(!name||!initials){alert('Name and initials required.');return;}
  if(teamMembers.find(m=>m.id===initials)){alert('Initials taken.');return;}
  const dbId=await dbAddTeamMember({initials,name,color});
  teamMembers.push({id:initials,initials,name,color,bg:color+'20',dbId});
  document.getElementById('tm-name').value=''; document.getElementById('tm-initials').value='';
  renderTeamList(); updateSidebarTeam(); showToast('Added: '+name);
};

removeTeamMember = async function(idx) {
  if(!confirm('Remove '+teamMembers[idx].name+'?'))return;
  await dbRemoveTeamMember(teamMembers[idx].dbId);
  teamMembers.splice(idx,1); renderTeamList(); updateSidebarTeam(); renderDashboard();
};

// Export backup
function exportBackup() {
  const data={bids,companies,myCompany,teamMembers,exportedAt:new Date().toISOString(),version:'1.0-supabase'};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='constructbid-backup-'+new Date().toISOString().split('T')[0]+'.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  showToast('Backup exported!');
}

function updateSidebarTeam() {
  const footer=document.querySelector('.sidebar-footer'); if(!footer)return;
  const avatars=teamMembers.slice(0,5).map((m,i)=>
    '<div class="avatar" style="background:'+(m.bg||(m.color+'20'))+';color:'+m.color+';'+(i>0?'margin-left:-8px;':'')+'">'+m.initials+'</div>'
  ).join('');
  footer.innerHTML='<div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Team</div>'
    +'<div class="team-badge">'+avatars+'<span style="font-size:11px;color:var(--muted);margin-left:4px;">'+teamMembers.length+' member'+(teamMembers.length!==1?'s':'')+'</span></div>'
    +'<div style="margin-top:10px;"><button onclick="signOut()" style="background:none;border:1px solid var(--border);color:var(--muted);padding:4px 10px;font-size:10px;border-radius:4px;cursor:pointer;width:100%;">Sign Out</button></div>';
}

// Start
// Export functions to global scope for onclick handlers
window.signIn = signIn;
window.signUp = signUp;
window.signOut = signOut;
window.checkAuth = checkAuth;
window.exportBackup = exportBackup;

checkAuth();
console.log('[ConstructBid] Supabase cloud integration loaded');

}

</script>
</body>
</html>
